---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

# iterate over an instance's list of coordinators and replicas
# check if the directory already exists. If not, issue a pgxc_ctl
# command to set the component up

- name: Check if Coordinator exists
  stat: path=/pgxl/data/coord{{ cnode }}_{{ ctype }}
  register: dirstat

- name: Add Coordinator Master if it does not exist
  shell: pgxc_ctl -c ~postgres/pgxc_ctl.conf add coordinator master coord{{ cnode }} {{ inventory_hostname }} 20002 20003 /pgxl/data/coord{{ cnode }}_master none none
  args:
    executable: /bin/bash
  vars:
    _task_environment:
      LC_ALL: en_US.UTF-8
      PATH: /opt/pgxl/bin:/usr/local/bin:/usr/bin:/bin
  environment: "{{ target_environment|combine(_task_environment) }}"
  when: ctype == 'master' and not dirstat.stat.exists
  become_user: "{{ postgres_user }}"
  become: true
  delegate_to: "{{ control_hostname }}"
