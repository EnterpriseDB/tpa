---

- name: Ensure that /opt/Postgres-XL-{{pgxlversion}} exists
  file:
    path: /opt/Postgres-XL-{{pgxlversion}}
    state: directory
    owner: postgres
    group: postgres
    mode: 0755

- name: Unarchive Postgres-XL tarball onto control node
  unarchive:
    src: "{{ pgxl_tar_name }}"
    dest: /opt
    creates: "/opt/Postgres-XL-{{pgxlversion}}/bin/pgxc_ctl"
  when: inventory_hostname == control_hostname

- name: Copy /opt/Postgres-XL-{{pgxlversion}} to other nodes
  command: rsync -e 'ssh -o StrictHostKeyChecking=yes' -qa \
    "{{ hostvars[control_hostname].private_ip }}:/opt/Postgres-XL-{{pgxlversion}}" /opt
  args:
    creates: "/opt/Postgres-XL-{{pgxlversion}}/bin/pgxc_ctl"
  sudo_user: "{{ postgres_user }}"
  sudo: yes
  when: inventory_hostname != control_hostname

- name: Link /opt/pgxl to /opt/Postgres-XL-{{pgxlversion}}
  file:
    path: /opt/pgxl
    src: "/opt/Postgres-XL-{{pgxlversion}}"
    state: link
