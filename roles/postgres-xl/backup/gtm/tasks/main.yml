---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

# GTM does not need any special barman configuration file
#
# We do need a script which connects to a coordinator and
# fires off "CREATE BARRIER". On successful completion of
# the command, the script should scp the contents of the
# GTM directory to an appropriate location.
#
- block:
  - name: Ensure that GTM backup directory exists
    file:
      path: "{{ _gtm_backup_basedir }}/backup"
      owner: barman
      group: barman
      state: directory
    delegate_to: "{{ gtm_backup }}"

  - name: Ensure that GTM scripts directory exists
    file:
      path: "{{ _gtm_backup_basedir }}/scripts"
      owner: barman
      group: barman
      state: directory
    delegate_to: "{{ gtm_backup }}"

  - name: Install GTM backup script
    template:
      src: barrier_gtm_backup.sh.j2
      dest: "{{ _gtm_backup_basedir }}/scripts/barrier_gtm_backup.sh"
      owner: barman
      group: barman
      mode: 0600
    delegate_to: "{{ gtm_backup }}"

  - name: Set up a cron job to take regular backups
    cron:
      user: barman
      cron_file: /etc/cron.d/{{ backup_name }}
      name: Backup from server {{ backup_name }}
      minute: "{{ _gtm_backup_interval[0] }}"
      hour: "{{ _gtm_backup_interval[1] }}"
      day: "{{ _gtm_backup_interval[2] }}"
      month: "{{ _gtm_backup_interval[3] }}"
      weekday: "{{ _gtm_backup_interval[4] }}"
      job: >
        /bin/sh {{ _gtm_backup_basedir }}/scripts/barrier_gtm_backup.sh
      state: present
    delegate_to: "{{ gtm_backup }}"
  when: >
    'gtm' in role
