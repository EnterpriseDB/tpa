cluster:
  name: {{ cluster_name }}

dcs:
  driver: "{{ harp_consensus_protocol }}"
  request_timeout: {{ harp_request_timeout|default(250) }}
  watch_poll_interval: {{ harp_watch_poll_interval|default(500) }}
{% if harp_consensus_protocol == 'etcd' %}
  ssl: "off"
  ssl_ca_file: ""
  ssl_cert_file: ""
  ssl_key_file: ""
{% endif %}
  endpoints:
{% if harp_consensus_protocol == 'etcd' %}
{%   for h in groups['role_etcd'] %}
{%     set v = hostvars[h] %}
{%     if v.harp_location == harp_location %}
  - {{ h }}:{{ v.etcd_client_port|default(2379) }}
{%     endif %}
{%   endfor %}
{% elif harp_consensus_protocol == 'bdr' %}
{%   for h in groups[bdr_node_group] %}
{%     set v = hostvars[h] %}
{%     if 'subscriber-only' not in v.role %}
{%       if 'harp-proxy' in role and harp_dcs_user is defined %}
  - "{{ v.bdr_node_dsn|dbname(v.bdr_database, user=harp_dcs_user) }}"
{%       elif 'harp-proxy' not in role and inventory_hostname == h %}
  - "host={{ unix_socket_directories|first }} dbname={{ v.bdr_database }}"
{%       else %}
  - "{{ v.bdr_node_dsn }}"
{%       endif %}
{%     endif %}
{%   endfor %}
{% endif %}

{% if 'postgres' in role %}
manager:
  name: "{{ bdr_node_name|default(inventory_hostname) }}"
  log_level: info
  start_command: {{ harp_postgres_start_command | default('sudo systemctl start postgres') }}
  stop_command: {{ harp_postgres_stop_command | default('sudo systemctl stop postgres') }}
  status_command: {{ harp_postgres_status_command | default('sudo systemctl status postgres') }}
{% endif %}
{% if 'harp-proxy' in role %}
proxy:
  log_level: info
  name: "{{ inventory_hostname }}-proxy"
  location: {{ harp_location }}
{% if harp_proxy_mode == "pgbouncer" %}
  pgbouncer_bin_dir: {{ pgbouncer_bin_dir }}
{% endif %}
{% endif %}
