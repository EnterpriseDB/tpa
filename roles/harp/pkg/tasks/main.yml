---

# Â© Copyright EnterpriseDB UK Limited 2015-2022 - All rights reserved.

- name: Install harp packages
  package:
    name: "{{
      _packages[harp_version]|packages_for(ansible_os_family, harp_package_version)
    }}"
    state: "{{
      (harp_package_version is defined)|ternary('present', 'latest')
    }}"
  vars:
    _packages: "{{
      ('harp-proxy' not in role)|ternary(harp_packages, harp_proxy_packages)
    }}"
  tags: pkg

# If we're not using the pgbouncer role (i.e., setting up pgbouncer to
# connect to harp-proxy), and we're using harp_proxy_mode = pgbouncer,
# we must install pgbouncer here. harp-proxy will manage the service.

- name: Install pgbouncer if required
  include_role:
    name: pgbouncer/pkg
    apply:
      tags: [pgbouncer, pkg]
  when: >
    'harp-proxy' in role
    and 'pgbouncer' not in role
    and harp_proxy_mode == "pgbouncer"
    and platform not in ['shared']
  tags: pkg

- name: Disable pgbouncer service on harp-proxy instances
  systemd:
    name: pgbouncer
    state: stopped
    masked: true
    enabled: no
  when: >
    'harp-proxy' in role
    and 'pgbouncer' not in role
    and harp_proxy_mode == "pgbouncer"
