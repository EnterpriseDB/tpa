---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

# First, we must obtain the source code.
#
# At present, we support fetching a git repository to a local directory.
#
# We might want to clone repositories via ssh with agent forwarding, but
# that won't work because we've sudo'ed to root (for the whole play). As
# a courtesy, we copy SSH_AUTH_SOCK to the environment if it's set.

- name: Check if ssh agent forwarding is enabled
  shell: echo $SSH_AUTH_SOCK
  args:
    executable: /bin/bash
  register: cmd
  become: no

- name: Fetch source code from git repository
  git:
    dest: "{{ source_directory }}"
    repo: "{{ git_repository_url }}"
    version: "{{ git_repository_ref }}"
    reference: "{{ git_reference_repository|default(omit) }}"
    depth: 1
    accept_hostkey: yes
  register: git
  vars:
    ansible_connection: ssh
    ansible_ssh_host: "{{ (platform == 'docker')|ternary(ip_address, ansible_host) }}"
    ssh_auth_sock: "{{ cmd.stdout.strip() }}"
    ssh_env:
      SSH_AUTH_SOCK: "{{ ssh_auth_sock }}"
    _task_environment: "{{ ssh_auth_sock|ternary(ssh_env, {}) }}"
  environment: "{{ target_environment|combine(_task_environment) }}"

# Next, we must run a series of commands to build the sources and
# install the results. The caller may specify a build_commands array and
# a build_environment hash, or we'll just run "make install" by default.

- name: Run build commands
  shell: >
    PATH={{ postgres_bin_dir }}:$PATH {{ item }} >> {{ build_log }} 2>&1
  args:
    chdir: "{{ source_directory }}"
    executable: /bin/bash
  with_items: "{{ build_commands|default([]) or default_build_commands }}"
  vars:
    build_log: "{{ build_log|default('/tmp/build.log') }}"
    default_build_commands:
    - make install
    _task_environment: "{{ build_environment|default({}) }}"
  environment: "{{ target_environment|combine(_task_environment) }}"
  notify:
    - Note Postgres restart required
