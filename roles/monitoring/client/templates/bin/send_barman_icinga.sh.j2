{% import '_send_icinga_config.j2' as config with context -%}
{% include '_send_icinga_init.sh.j2' -%}

{% if barman_check_disk|length %}
CHECK_DISK={{barman_check_disk}}
{% else %}
{% if ansible_os_family == "Debian" %}
CHECK_DISK=/usr/lib/nagios/plugins/check_disk
{% elif ansible_os_family == "RedHat" %}
CHECK_DISK=/usr/lib64/nagios/plugins/check_disk
{% else %}
# ERROR - please locate check_disk
CHECK_DISK=/unknown/path
{% endif %}
{% endif %}

# 1. Run checks and collect output in $NSCA_MSG
NSCA_MSG=$(
    ~/bin/check_barman_wrapper.pl {{barman_server|join(' ')}}
    $CHECK_DISK --warning="10%" --critical="5%"{% for disk in barman_disks %} --path {{disk}}{% endfor %}

)

# 2. Send output to specified icinga hosts

{# Note: below template needed because command output slightly different to check_postgres.pl #}
{% include '_send_nsca_generic.sh.j2' %}
