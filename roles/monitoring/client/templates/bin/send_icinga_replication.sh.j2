{% import '_send_icinga_config.j2' as config with context -%}
{% include '_send_icinga_init.sh.j2' -%}

NSCA_MSG=$(
{% if ('replica' in role  or 'cascading' in role) %}
   {{config.sudo}} ~/bin/check_replication.pl $PG_HOST $PG_PORT --check=lag --warning="{{replication_lag_warn}}" --critical="{{replication_lag_crit}}"{% if (peak_lag != '') %} --peak_lag={{peak_lag|join(',')}}{% endif -%}
{% endif -%}
{% if ('primary' in role  or 'cascading' in role) %}
   {{config.sudo}} ~/bin/check_replication.pl $PG_HOST $PG_PORT --check=connection {% for server_name in groups['tag_role_postgres'] -%}
{% if(hostvars[server_name].upstream|default('') == inventory_hostname) -%} --standby {{ server_name }},{{ hostvars[server_name].private_ip }} {% endif -%}
{% endfor -%}
{% endif -%}
)

# 2. Send output to specified icinga hosts

{% include '_send_nsca.sh.j2' %}
