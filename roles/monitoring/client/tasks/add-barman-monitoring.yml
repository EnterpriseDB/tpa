---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

# roles/client/tasks/add-barman-monitoring.yml
#
# Set up monitoring for a barman server


# Check that standard directories exist
# -------------------------------------

- name: Ensure ~/bin directory exists
  file: path={{barman_home}}/bin state=directory owner=barman mode=0755
  become: "{{barman_become}}"

- name: Ensure ~/conf directory exists
  file: path={{barman_home}}/conf state=directory owner=barman
  become: "{{barman_become}}"

- name: Ensure ~/logs directory exists
  file: path={{barman_home}}/logs state=directory owner=barman
  become: "{{barman_become}}"


# Install prerequisites
# ---------------------

- name: Install nsca-ng client
  include_tasks: install-nsca-client.yml
  become: "{{barman_become}}"

- name: Install nagios-plugins-basic (Debian et al)
  apt: name="nagios-plugins-basic" state=latest
  become: "yes"
  when: (have_root_sudo|bool == true) and (ansible_os_family == "Debian")

- name: Install nagios-plugins-basic (RedHat et al)
  yum: name="nagios-plugins-disk" state=present
  become: "yes"
  when: (have_root_sudo|bool == true) and (ansible_os_family == "RedHat")

# Configuration
# -------------

# send_nsca.cfg
- name: Add nsca-ng client configuration file
  template: src=conf/send_nsca.cfg.j2 dest={{barman_home}}/conf/send_nsca.cfg owner=barman
  become: "{{barman_become}}"

# SSH keys for nsca-ng gateway, if required

- name: Ensure ~/.ssh exists with correct permissions
  file: path="~/.ssh" state=directory mode=0700
  when: (nsca_gateway|length)

- name: Install id_2ndq_nsca_gateway
  copy: src="ssh/id_2ndq_nsca_gateway" dest="~/.ssh/id_2ndq_nsca_gateway" mode=0600
  when: (nsca_gateway|length)

- name: Install id_2ndq_nsca_gateway.pub
  copy: src="ssh/id_2ndq_nsca_gateway.pub" dest="~/.ssh/id_2ndq_nsca_gateway.pub" mode=0644
  when: (nsca_gateway|length)

# Install scripts
# ---------------

- name: Add check_barman_wrapper.pl
  copy: src=bin/check_barman_wrapper.pl dest={{barman_home}}/bin/check_barman_wrapper.pl owner=barman mode=0755
  become: "{{barman_become}}"

- name: Add check_disk.pl
  copy: src=bin/check_disk.pl dest={{barman_home}}/bin/check_disk.pl owner=barman mode=0755
  when: (barman_check_disk == "~/bin/check_disk.pl")

- name: Add send_barman_icinga.sh
  template: src=bin/send_barman_icinga.sh.j2 dest={{barman_home}}/bin/send_barman_icinga.sh owner=barman mode=0755
  become: "{{barman_become}}"

- name: Add send_barman_icinga.sh as cronjob (without logging)
  cron: user="barman" name="send_barman_icinga" minute="*/5" job="~/bin/send_barman_icinga.sh"
  become: "yes"
  when: (have_root_sudo|bool == true) and (add_cron|bool == true)

- name: Add send_barman_icinga.sh as cronjob (without logging)
  cron: name="send_barman_icinga" minute="*/5" job="~/bin/send_barman_icinga.sh"
  when: (have_root_sudo|bool == false) and (add_cron|bool == true)

- name: Add send_icinga_hostup.sh
  template: src=bin/send_icinga_hostup.sh.j2 dest={{barman_home}}/bin/send_icinga_hostup.sh owner=barman mode=0755
  become: "{{barman_become}}"

- name: Add send_icinga_hostup.sh as cronjob (without logging)
  cron: user="barman" name="send_icinga_hostup" minute="*" job="~/bin/send_icinga_hostup.sh"
  become: "yes"
  when: (have_root_sudo|bool == true) and (add_cron|bool == true) and (send_icinga_logging|bool == false)

- name: Add send_icinga_hostup.sh as cronjob (without logging)
  cron: name="send_icinga_hostup" minute="*" job="~/bin/send_icinga_hostup.sh"
  when: (have_root_sudo|bool == false) and (add_cron|bool == true) and (send_icinga_logging|bool == false)

- name: Add send_icinga_hostup.sh as cronjob (with logging)
  cron: user="barman" name="send_icinga_hostup" minute="*" job="~/bin/send_icinga_hostup.sh >> ~/logs/send_icinga_hostup.`{{log_date_command}}`.log 2>&1"
  become: "yes"
  when: (have_root_sudo|bool == true) and (add_cron|bool == true) and (send_icinga_logging|bool == true)

- name: Add send_icinga_hostup.sh as cronjob (with logging)
  cron: name="send_icinga_hostup" minute="*" job="~/bin/send_icinga_hostup.sh >> ~/logs/send_icinga_hostup.`{{log_date_command}}`.log 2>&1"
  when: (have_root_sudo|bool == false) and (add_cron|bool == true) and (send_icinga_logging|bool == true)
