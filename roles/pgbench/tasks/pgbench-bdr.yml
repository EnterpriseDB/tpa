---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

- set_fact:
    last_primary: "{{ _rw_instances|last }}"
  vars:
    _rw_instances: "{{
      groups|members_of(bdr_node_group, not_in=['role_readonly','role_replica'])
    }}"

- block:
  - name: Raise BDR lock timeouts for pgbench -i
    postgresql_query:
      conninfo: "{{ dsn|dbname(pgbench_dbname) }}"
      autocommit: yes
      queries: "{{ query('flattened', timeout_queries) }}"
    become_user: "{{ postgres_user }}"
    become: yes
    vars:
      lock_name: >-
        {{ ['bdr_ddl', 'bdr_ddl', 'global'][bdr_major_version-1] }}_lock_timeout
      statement_timeout:
        text: "ALTER SYSTEM SET bdr.global_lock_statement_timeout TO '3600s'"
      timeout_queries:
        - text: "ALTER SYSTEM SET bdr.{{ lock_name }} TO '600s'"
        - "{{ (bdr_major_version == 3)|ternary(statement_timeout, []) }}"
        - text: SELECT pg_reload_conf()

  - include_role: name=pgbench/init
    vars:
      pgbench_output: pgbench-bdr-init.txt

  - name: Reset BDR lock timeouts to defaults after pgbench -i
    postgresql_query:
      conninfo: "{{ dsn|dbname(pgbench_dbname) }}"
      autocommit: yes
      queries: "{{ query('flattened', reset_queries) }}"
    become_user: "{{ postgres_user }}"
    become: yes
    vars:
      lock_name: >-
        {{ ['bdr_ddl', 'bdr_ddl', 'global'][bdr_major_version-1] }}_lock_timeout
      statement_timeout:
        text: "ALTER SYSTEM SET bdr.global_lock_statement_timeout TO default"
      reset_queries:
        - "{{ (bdr_major_version == 3)|ternary(statement_timeout, []) }}"
        - text: "ALTER SYSTEM SET bdr.{{ lock_name }} TO default"
        - text: SELECT pg_reload_conf()

  when: >
    inventory_hostname == first_bdr_primary

- name: Wait for pgbench -i to replicate to BDR instances
  postgresql_query:
    conninfo: "{{ dsn|dbname(pgbench_dbname) }}"
    query: >
      select bdr.wait_slot_confirm_lsn(NULL, NULL)
  become_user: "{{ postgres_user }}"
  become: yes

- name: Run read/write workload
  include_tasks: pgbench.yml
  vars:
    pgbench_opts: -v -c 10 -j 5 -T 180 {{ pgbench_dbname }}
    pgbench_output: pgbench-bdr-rw.txt
  when: >
    inventory_hostname == last_primary

- name: Run read-only workload
  include_tasks: pgbench.yml
  vars:
    pgbench_opts: -n -c 10 -j 5 -T 180 -S {{ pgbench_dbname }}
    pgbench_output: pgbench-bdr-ro.txt
  when: >
    'replica' in role
