---

- name: Set pgbouncer_backend
  set_fact:
    pgbouncer_backend: >-
      {{ pgbouncer_backend|default('127.0.0.1') }}

- name: Set pgbouncer_backend_port
  set_fact:
    pgbouncer_backend_port: "{{
      pgbouncer_backend_port|default(
        (pgbouncer_backend in hostvars)|ternary(
          hostvars[pgbouncer_backend].postgres_port|default(5432),
          5432
        )
      )
    }}"

- name: Set pgbouncer_databases
  set_fact:
    pgbouncer_databases: "{{
      pgbouncer_databases|default([{
        'name': '*',
        'dsn': 'host=%s port=%s' % (pgbouncer_backend, pgbouncer_backend_port)
      }])
    }}"

- name: Ensure /etc/pgbouncer exists
  file:
    path: /etc/pgbouncer
    owner: "{{ postgres_user }}"
    group: "{{ postgres_group }}"
    mode: 0700
    state: directory

- name: Install pgbouncer.ini
  template:
    src: pgbouncer.ini.j2
    dest: "/etc/pgbouncer/pgbouncer.ini"
    owner: "{{ postgres_user }}"
    group: "{{ postgres_group }}"
    mode: 0640
  notify:
    - Note pgbouncer restart required

- name: Install userlist.txt
  template:
    src: userlist.txt.j2
    dest: "/etc/pgbouncer/userlist.txt"
    owner: "{{ postgres_user }}"
    group: "{{ postgres_group }}"
    mode: 0600
  notify:
    - Note pgbouncer restart required

- name: Enable pgbouncer on boot
  service:
    name: pgbouncer
    enabled: yes
