---

# For pidfile = /var/run/pgbouncer/pgbouncer.pid
- name: Ensure /var/run/pgbouncer exists
  file:
    path: /var/run/pgbouncer
    owner: "{{ postgres_user }}"
    group: "{{ postgres_group }}"
    mode: 0755
    state: directory

# For configuration files
- name: Ensure /etc/pgbouncer exists
  file:
    path: /etc/pgbouncer
    owner: "{{ postgres_user }}"
    group: "{{ postgres_group }}"
    mode: 0700
    state: directory

- name: Copy the main configuration file
  template:
    src: pgbouncer.ini.j2
    dest: "/etc/pgbouncer/pgbouncer.ini"
    owner: "{{ postgres_user }}"
    group: "{{ postgres_group }}"
    mode: 0640
  notify:
    - Note pgbouncer restart required

- name: Copy the userlist file
  template:
    src: userlist.txt.j2
    dest: "/etc/pgbouncer/userlist.txt"
    owner: "{{ postgres_user }}"
    group: "{{ postgres_group }}"
    mode: 0600
  notify:
    - Note pgbouncer restart required

- name: Enable pgbouncer on boot
  service:
    name: pgbouncer
    enabled: yes
