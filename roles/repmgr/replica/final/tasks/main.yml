---

# If this instance is registered as a replica already, we don't need to
# do anything. If it's registered as something else, it's an error, and
# we don't do anything. Only if it's not registered at all do we clone
# it and register it as a replica.

- name: Check if this instance is registered as a replica
  postgresql_query:
    conninfo: "host={{ upstream_primary }} dbname=repmgr user=repmgr"
    query: >
      SELECT (case when type='standby' then 'replica' else type end) as type
      FROM "{{ repmgr_schema }}".repl_nodes
      WHERE name='{{ inventory_hostname }}' AND active
  vars:
    repmgr_schema: 'repmgr_{{ repmgr_cluster }}'
  register: registration
  become_user: "{{ postgres_user }}"
  become: yes

- fail:
    msg: >
      {{ inventory_hostname }} is tagged as replica of {{ upstream_primary }},
      but is registered as a {{ registration.type }} already"
  when:
    registration.results|length > 0 and registration.type != 'replica'

- include: clone.yml
  when:
    registration.results|length == 0
