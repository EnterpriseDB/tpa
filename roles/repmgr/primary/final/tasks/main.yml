---

- name: Create repmgr database
  postgresql_db:
    name: repmgr
    owner: repmgr
    state: present
  become_user: "{{ postgres_user }}"
  become: yes

- name: Check if the primary is registered
  command: >
    {{ postgres_bin_dir }}/repmgr cluster show \
      -f "{{ repmgr_conf_dir }}/repmgr.conf"
  register: primary_check
  ignore_errors: True
  changed_when: False
  become_user: "{{ postgres_user }}"
  become: yes

- name: Run 'repmgr primary register' on the primary
  command: >
    {{ postgres_bin_dir }}/repmgr primary register --verbose \
      -f "{{ repmgr_conf_dir }}/repmgr.conf"
  become_user: "{{ postgres_user }}"
  become: yes
  when: primary_check is not successful
