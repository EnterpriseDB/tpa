---

# Â© Copyright EnterpriseDB UK Limited 2015-2021 - All rights reserved.

- include_role: name=src/install tasks_from=clone.yml
  vars:
    name: repmgr
    repo: "{{ repmgr_git_url }}"
    dest: "{{ repmgr_src_dir }}"
    version: "{{ repmgr_git_ref }}"
    reference: "{{ repmgr_git_reference_repo }}"

- include_role: name=src/install tasks_from=verify-branch.yml
  vars:
    source_directory: "{{ repmgr_src_dir }}"
    git_repository_ref: "{{ repmgr_git_ref }}"
  when:
    repmgr_git_ref is defined

# XXX Although a --local-source-directories attempt to build repmgr
# would be handled "for free" by the tasks above, the following code
# does an in-tree build, and would therefore fail in this scenario.

- name: Remove old build artifacts
  command: git clean -dxf
  args:
    chdir: "{{ repmgr_src_dir }}"
  tags: [build-clean, repmgr-clean]

- name: Configure repmgr if necessary
  shell: >
    test -x ./configure &&
    PATH={{ build_path }} ./configure
  args:
    chdir: "{{ repmgr_src_dir }}"
    executable: /bin/bash
  tags: [build-configure, repmgr-configure]

- name: Build and install repmgr
  shell: >
    PATH={{ build_path }} make -s USE_PGXS=1 with_llvm=no install
  args:
    chdir: "{{ repmgr_src_dir }}"
    executable: /bin/bash
