---

# Copyright Â© EnterpriseDB Corporation

- include_role: name=src/install tasks_from=clone.yml
  vars:
    name: repmgr
    repo: "{{ repmgr_git_url }}"
    dest: "{{ repmgr_src_dir }}"
    version: "{{ repmgr_git_ref }}"
    reference: "{{ repmgr_git_reference_repo }}"
  when:
    repmgr_src_dir not in mounted_sources

- name: Remove old build artifacts
  command: git clean -dxf
  args:
    chdir: "{{ repmgr_src_dir }}"
  tags: [build-clean, repmgr-clean]

- name: Configure repmgr if necessary
  shell: >
    test -x ./configure &&
    PATH={{ build_path }} ./configure
  args:
    chdir: "{{ repmgr_src_dir }}"
    executable: /bin/bash
  tags: [build-configure, repmgr-configure]

- name: Build and install repmgr
  shell: >
    PATH={{ build_path }} make -s USE_PGXS=1 with_llvm=no install
  args:
    chdir: "{{ repmgr_src_dir }}"
    executable: /bin/bash
