---

# Â© Copyright EnterpriseDB UK Limited 2015-2021 - All rights reserved.

- include_role:
    name: postgres/final
    apply:
      tags: postgres
  when: >
    'postgres' in role
  tags: postgres

- include_role:
    name: repmgr/final
    apply:
      tags: repmgr
  when: >
    'postgres' in role and
    initialise_replication is defined
  tags: repmgr

- include_role:
    name: barman/final
    apply:
      tags: barman
  when: >
    'barman' in role or backup is defined
  tags: barman

- include_role:
    name: etcd/final
    apply:
      tags: etcd
  when: >
    'etcd' in role
  tags: etcd

- include_role:
    name: haproxy/final
    apply:
      tags: haproxy
  when: >
    'haproxy' in role
  tags: haproxy

- include_role:
    name: pgbouncer/final
    apply:
      tags: pgbouncer
  when: >
    'pgbouncer' in role
  tags: pgbouncer

- include_role:
    name: postgres/cleanup
    apply:
      tags: postgres
  when: >
    'postgres' in role
  tags: postgres

# We force an immediate backup for any instances that do not have any
# backups at all.

- include_role:
    name: barman/first-backup
    apply:
      tags: first-backup
  with_items: "{{ backup|default([]) }}"
  loop_control:
    loop_var: this_barman
  vars:
    slot_name: "{{ this_barman|backup_slot_name }}"
  tags: first-backup

- include_role:
    name: postgres/pglogical
    apply:
      tags: pglogical
  vars:
    pglogical_publications: >-
      {{ publications|json_query("[?type=='pglogical']") }}
    pglogical_subscriptions: >-
      {{ subscriptions|json_query("[?type=='pglogical']") }}
  when:
    pglogical_publications is not empty
    or pglogical_subscriptions is not empty
  tags: pglogical

- include_role:
    name: postgres/bdr
    apply:
      tags: [postgres, bdr]
  when: >
    role|contains('bdr', 'primary')
  tags: [postgres, bdr]

- include_role:
    name: harp
    apply:
      tags: harp
  when:
    failover_manager == 'harp'
    and role|contains('bdr', 'primary')
  tags: harp

- include_role:
    name: efm/final
    apply:
      tags: efm
  when:
    failover_manager == 'efm'
    and ('postgres' in role or 'efm-witness' in role)
  tags: efm
