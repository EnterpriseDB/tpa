---

- name: Install required packages
  package:
    name: >
      {{ query('flattened', package_lists) }}
    state: latest
  vars:
    package_lists:
      - "{{ packages['common'] }}"
      - "{{ packages[ansible_distribution] }}"

- name: Install optional packages
  package:
    name: "{{ item }}"
    state: latest
  with_items:
    - "{{ optional_packages['common'] }}"
    - "{{ optional_packages[ansible_distribution] }}"
  ignore_errors: yes

- name: Remove unwanted packages
  package:
    name: "{{ unwanted_packages[ansible_distribution] }}"
    state: absent
