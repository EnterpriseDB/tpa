---

# Copyright © 2ndQuadrant Limited <info@2ndquadrant.com>

- name: Install apt-transport-https to support https repositories
  raw: apt-get -q -y install apt-transport-https
  register: ath_install
  changed_when: >
    ath_install is successful
    and 'already the newest version' not in ath_install.stdout

- name: Install curl to fetch repository files
  raw: apt-get -q -y install curl
  register: curl_install
  changed_when: >
    curl_install is successful
    and 'already the newest version' not in curl_install.stdout

- name: Install gpg to install apt repository keys
  raw: apt-get -q -y install gnupg2
  register: gpg_install
  changed_when: >
    gpg_install is successful
    and 'already the newest version' not in gpg_install.stdout

- name: Ensure repository list is defined
  assert:
    msg: "Repository {{ item }} is not defined in apt_repositories"
    that: item in default_apt_repositories|combine(apt_repositories)
  with_items: "{{ apt_repository_list }}"

# We need to support https://user:pass@host/… key and repository URLs,
# which work only if we enable force_basic_auth for fetch_url(). Since
# the default apt_key module does not allow this, we use a local copy
# that forwards the parameter.

- name: Install apt repository signing keys
  apt_key:
    id: "{{ r.key_id }}"
    url: "{{ r.key_url }}"
    state: present
    force_basic_auth: yes
  with_items: "{{ apt_repository_list }}"
  vars:
    repos: "{{ default_apt_repositories|combine(apt_repositories) }}"
    r: "{{ repos[item] }}"

- name: Install apt repositories
  apt_repository:
    repo: "{{ r.repo }}"
    state: present
    update_cache: no
  with_items: "{{ apt_repository_list }}"
  vars:
    repos: "{{ default_apt_repositories|combine(apt_repositories) }}"
    r: "{{ repos[item] }}"

- name: Update apt cache
  apt: update_cache=yes

- name: Install 2ndQuadrant repositories
  shell: >
    curl {{ url }} | bash
  args:
    executable: /bin/bash
    creates: "{{ file }}"
  with_items:
    - dl/default/release
    - "{{ tpa_2q_repositories|default([]) }}"
  vars:
    token: "{{ lookup('env', 'TPA_2Q_SUBSCRIPTION_TOKEN') }}"
    urltemplate: "{{
      (item == 'dl/default/release')|ternary(
        'https://access.2ndquadrant.com/api/repository/{label}/deb',
        'https://access.2ndquadrant.com/api/repository/{token}/{label}/deb'
      )
    }}"
    url: >-
      {{ urltemplate.format(token=token, label=item) }}
    file: "/etc/apt/sources.list.d/2ndquadrant-{{ item|replace('/', '-') }}.list"
