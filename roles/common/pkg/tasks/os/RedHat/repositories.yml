---

- name: Ensure repository list is defined
  assert:
    msg: "Repository {{ item }} is not defined in yum_repositories"
    that: item in default_yum_repositories|combine(yum_repositories)
  with_items: "{{ yum_repository_list }}"
  tags: public_repos

- name: Ensure that the repository password is specified if necessary
  assert:
    msg: "Please set TPA_2Q_REPO_PASSWORD=… when running deploy"
    that: >
      ':@' not in r.rpm_url
  with_items: "{{ yum_repository_list }}"
  vars:
    repos: "{{ default_yum_repositories|combine(yum_repositories) }}"
    r: "{{ repos[item] }}"
  tags: public_repos

# We need to support https://user:pass@host/… key and repository URLs,
# which work only if we enable force_basic_auth for fetch_url(). Since
# the default yum module does not allow this, we use a local copy that
# forwards the parameter.

- name: Install YUM repository packages
  yum:
    name: "{{ r.rpm_url }}"
    state: present
    force_basic_auth: yes
  with_items: "{{ yum_repository_list }}"
  vars:
    repos: "{{ default_yum_repositories|combine(yum_repositories) }}"
    r: "{{ repos[item] }}"
  tags: public_repos

# Following the instructions in
# https://wiki.postgresql.org/wiki/YUM_Installation, we exclude
# postgresql from the base repositories.

- name: Exclude postgresql packages from the base repository
  ini_file:
    dest: /etc/yum/pluginconf.d/rhnplugin.conf
    section: main
    option: exclude
    value: "postgresql* barman* repmgr*"
  tags: public_repos
