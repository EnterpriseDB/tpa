---

- name: Ensure Postgres configuration is present
  assert:
    msg: "Please include the postgres/vars role to define postgres_version"
    that:
      - postgres_version is defined
      - postgres_versionNN is defined

- assert:
    msg: "Export TPA_2Q_SUBSCRIPTION_TOKEN to use twoq_repositories"
    that:
      lookup('env', 'TPA_2Q_SUBSCRIPTION_TOKEN') != '' or
      twoq_repositories|default([])|length == 0
  tags: public_repos

# We must ensure that a usable Python (2.7.x) is installed, along with
# anything else we need to run Ansible modules such as "pkg" below.

- include_tasks: "os/{{ ansible_os_family }}/python.yml"

# hostname -f fails if it can't find the hostname in /etc/hosts, and
# installing the 2ndQuadrant repositories below might call hostname -f.
# Note that sys/hosts will overwrite /etc/hosts later.
#
# We do this here rather than in user-data to avoid any possibility that
# cloud-init will overwrite the line we add, because we have not turned
# off manage_etc_hosts yet.

- name: Add hostname to /etc/hosts temporarily
  lineinfile:
    path: /etc/hosts
    insertafter: EOF
    state: present
    line: >-
      127.0.1.1	{{ inventory_hostname }}

- include_tasks: "os/{{ ansible_os_family }}/repositories.yml"
- include_tasks: packages.yml
- include_tasks: python.yml
