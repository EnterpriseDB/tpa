---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

- include_role: name=sys/openvpn/ip
  tags: always
- include_role: name=sys/openvpn/pkg
  tags: [sys, openvpn]
- include_role: name=sys/openvpn/common
  tags: [sys, openvpn]
- include_role: name=sys/openvpn/server
  when: >
    'openvpn-server' in role
  tags: [sys, openvpn]
- include_role: name=sys/openvpn/client
  when: >
    openvpn_server is defined and openvpn_server != ''
  tags: [sys, openvpn]

- name: Ensure openvpn is enabled on boot
  service:
    name: "openvpn@{{ _vpn_name }}"
    enabled: yes
  tags: [sys, openvpn]

# The server has already been started or restarted in openvpn/server, so
# here we only apply the task to clients.

- meta: flush_handlers

- name: Start or restart openvpn on the clients
  service:
    name: "openvpn@{{ _vpn_name }}"
    state: "{{ openvpn_service_end_state|default('started') }}"
  when: >
    'openvpn-server' not in role
  tags: [sys, openvpn]

- name: Override primary IP address
  set_fact:
    ip_address: "{{ openvpn_ip }}"
    ip_addresses: ['public_ip', 'private_ip', 'openvpn_ip']
  tags: always
