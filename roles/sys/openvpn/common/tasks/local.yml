---

- name: Ensure certs directory exists locally
  local_action:
    module: file
    path: "{{ _local_cert_dir }}"
    state: directory
  run_once: yes
  become: no

- name: Copy custom openssl configuration to certs directory
  local_action:
    module: template
    src: openssl.cnf.j2
    dest: "{{ _local_cert_dir }}/openssl.cnf"
  become: no

- name: Generate CA key and self-signed CA certificate
  local_action: >
    shell
    umask 077 &&
    openssl req -new -nodes -newkey rsa:4096 -x509 -out ca.crt -keyout ca.key
    -subj '/C=GB/ST=Oxford/L=Oxford/O=2ndQuadrant/OU=2ndQuadrant TPA/CN={{ cluster_name }}'
    -days 3650
  args:
    chdir: "{{ _local_cert_dir }}"
    creates: "ca.key"
  run_once: yes
  become: no

- name: Generate host key and CSR for each instance
  local_action: >
    shell
    umask 077 &&
    openssl req -new -nodes -newkey rsa:4096
    -out "{{ inventory_hostname }}.csr" -keyout "{{ inventory_hostname }}.key"
    -subj '/C=GB/ST=Oxford/L=Oxford/O=2ndQuadrant/OU=2ndQuadrant TPA/CN={{ inventory_hostname }}'
    -days 3650
  args:
    chdir: "{{ _local_cert_dir }}"
    creates: "{{ inventory_hostname }}.key"
  become: no

- name: Select extension type for host certificate
  set_fact:
    openssl_extensions: "{{
      ('openvpn-server' in role)|ternary('server_exts', 'client_exts')
    }}"

- name: Sign each CSR with the CA certificate
  local_action: >
    shell
    umask 077 &&
    openssl x509 -req -CA ca.crt -CAkey ca.key -set_serial {{ node }}
    -in "{{ inventory_hostname }}.csr" -out "{{ inventory_hostname }}.crt"
    -extensions {{ openssl_extensions }} -extfile openssl.cnf
    -days 3650 -sha256
  args:
    chdir: "{{ _local_cert_dir }}"
    creates: "{{ inventory_hostname }}.crt"
  become: no

- name: Generate DH parameters
  local_action: >
    shell
    umask 077 &&
    openssl dhparam -out "dh2048.pem" 2048
  args:
    chdir: "{{ _local_cert_dir }}"
    creates: "dh2048.pem"
  run_once: yes
  become: no

- name: Generate TLS authentication key
  local_action: >
    shell
    umask 077 &&
    /usr/sbin/openvpn --genkey --secret "ta.key"
  args:
    chdir: "{{ _local_cert_dir }}"
    creates: "ta.key"
  run_once: yes
  become: no
