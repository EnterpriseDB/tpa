---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

- include_role:
    name: sys/pkg
    apply:
      tags: [sys, pkg]
  tags: always

- name: Set the hostname
  hostname: name="{{ inventory_hostname }}"
  when:
    platform not in ['docker']
  tags: [sys, hostname]

- name: Ensure authorized_keys allows admin access
  authorized_key:
    user: "{{ ansible_user|default('root') }}"
    key: "{{ lookup('file', cluster_dir|abspath_to(ssh_key_file + '.pub')) }}"
  when: ssh_key_file is defined

- include_tasks:
    file: tpa.yml
    apply:
      tags: [sys, tpa]
  tags: always

# Creates and mounts any additional filesystems required, e.g., any
# postgres_data/barman_data volumes specified for the instance.
- include_role:
    name: sys/volumes
    apply:
      tags: [sys, volumes]
  tags: always

# Now that the any additional volumes have been mounted, we can copy in
# any additional artifacts specified in config.yml
- include_tasks:
    file: artifact.yml
    apply:
      tags: [sys, artifacts]
  with_items: "{{ artifacts|default([]) }}"
  loop_control:
    loop_var: artifact
  tags: always

- include_role:
    name: sys/sysctl
    apply:
      tags: [sys, sysctl]
  tags: always

- include_role:
    name: sys/sysstat
    apply:
      tags: [sys, sysstat]
  tags: always

- include_role:
    name: sys/openvpn
    apply:
      tags: [sys, openvpn]
  when: >
    platform not in ['docker', 'vagrant'] and
    'role_openvpn-server' in groups
  tags: always

- include_role:
    name: sys/hosts
    apply:
      tags: [sys, hosts]
  tags: always

- include_role:
    name: sys/cloudinit
    apply:
      tags: [sys, cloudinit]
  when: >
    platform not in ['docker', 'vagrant']
  tags: always

- include_role:
    name: sys/rsyslog
    apply:
      tags: [sys, rsyslog]
  tags: always

- include_role:
    name: sys/logrotate
    apply:
      tags: [sys, rsyslog]
  tags: always
