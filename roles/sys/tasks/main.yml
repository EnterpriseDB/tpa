---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

# Creates and mounts any additional filesystems required, e.g., any
# postgres_data/barman_data volumes specified for the instance.
- include_role:
    name: sys/volumes
    apply:
      tags: [sys, volumes]
  tags: always

# Now that the any additional volumes have been mounted, we can copy in
# any additional artifacts specified in config.yml
- include_tasks:
    file: artifact.yml
    apply:
      tags: [sys, artifacts]
  with_items: "{{ artifacts|default([]) }}"
  loop_control:
    loop_var: artifact
  tags: always

# Computes memory size and other instance-specific values needed by
# later steps (e.g., setting shared_buffers).
- include_role:
    name: sys/tune
    apply:
      tags: [sys, always]
  tags: always

- include_role:
    name: sys/sysctl
    apply:
      tags: [sys, sysctl]
  vars:
    sysctl_values:
      net.ipv4.ip_forward: 1
  tags: always

- include_role:
    name: sys/sysstat
    apply:
      tags: [sys, sysstat]
  tags: always

- include_role:
    name: sys/openvpn
    apply:
      tags: [sys, openvpn]
  when: >
    platform not in ['docker', 'vagrant'] and
    'role_openvpn-server' in groups
  tags: always

- include_role:
    name: sys/hosts
    apply:
      tags: [sys, hosts]
  tags: always

- include_role:
    name: sys/cloudinit
    apply:
      tags: [sys, cloudinit]
  when: >
    platform not in ['docker', 'vagrant']
  tags: always

- include_role:
    name: sys/rsyslog
    apply:
      tags: [sys, rsyslog]
  tags: always

- include_role:
    name: sys/logrotate
    apply:
      tags: [sys, rsyslog]
  tags: always
