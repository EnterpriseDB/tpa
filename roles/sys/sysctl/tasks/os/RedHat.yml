---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

# RedHat has /etc/default/grub and grub-mkconfig, but the more common
# way to change the boot configuration from scripts is to use grubby,
# which does NOT use /etc/default/grub. So we should stick to using
# grubby to avoid trouble.

- name: Run grubby to update kernel command line
  shell: >
    if ! grep -q transparent_hugepage= /boot/grub2/grub.cfg || ! grep -q hugepages= /boot/grub2/grub.cfg;
    then grubby --update-kernel=ALL --args="hugepages={{ nr_hugepages }} transparent_hugepage=never";
    else echo unchanged;
    fi
  args:
    executable: /bin/bash
  register: grubby
  changed_when: grubby.stdout != 'unchanged'
  vars:
    sysctls: "{{ sysctl_defaults|combine(sysctl_values) }}"
    nr_hugepages: "{{ sysctls['vm.nr_hugepages'] }}"
