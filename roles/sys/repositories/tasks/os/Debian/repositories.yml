---

# Â© Copyright EnterpriseDB UK Limited 2015-2025 - All rights reserved.

- set_fact:
    apt_repository_list:
      "{{ apt_repository_list|default(default_apt_repository_list) }}"

- name: Ensure repository list is defined
  assert:
    msg: "Repository {{ item }} is not defined in apt_repositories"
    that: item in default_apt_repositories|combine(apt_repositories)
  with_items: "{{ apt_repository_list }}"

- name: Install apt repository signing keys
  apt_key:
    id: "{{ r.key_id|default(omit) }}"
    url: "{{ r.key_url }}"
    state: present
  with_items: "{{ apt_repository_list }}"
  vars:
    repos: "{{ default_apt_repositories|combine(apt_repositories) }}"
    r: "{{ repos[item] }}"

- name: Install apt repositories
  apt_repository:
    repo: "{{ repo_entry }}"
    filename: "{{ r.filename|default(omit) }}"
    mode: "{{ needs_auth|ternary('0600', '0644') }}"
    state: present
    update_cache: no
  with_items: "{{ apt_repository_list }}"
  vars:
    _file: "{{ lookup('env', 'EDB_REPO_CREDENTIALS_FILE') or '' }}"
    _credentials: "{{ _file and lookup('file', _file) or '' }}"
    repos: "{{ default_apt_repositories|combine(apt_repositories) }}"
    r: "{{ repos[item] }}"
    needs_auth:
      "{{ item == 'EDB'
          and ansible_distribution_release in ['jessie', 'stretch'] }}"
    repo_entry: "{{
        needs_auth|ternary(
          r.repo|regex_replace('https://', 'https://%s@' % _credentials), r.repo
        )
      }}"
  no_log: "{{ needs_auth }}"

- include_tasks: edb-repositories.yml
  when:
    edb_repositories is not empty

# Some extension packages require extra repositories to be set up to install dependencies

- include_tasks: extension-repositories.yml

- name: Update apt cache
  apt:
    update_cache: yes
