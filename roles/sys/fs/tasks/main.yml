---

# Given a block device name and a mountpoint, does everything required
# to make the volume available for use immediately and after subsequent
# reboots.

- name: Ensure filesystem configuration is specified
  assert:
    msg: "Please specify at least the device name and mountpoint"
    that:
      - device is defined
      - mountpoint is defined

# device is what the caller specified; _device is what we use
# internally, and is subject to being modified by luks.yml.

- name: Record device name
  set_fact:
    _device: "{{ device }}"

- block:
    - name: Set up encryption on {{ device }}
      include_tasks: "{{ encryption }}.yml"
      vars:
        luks_device: "{{ _device }}"
    - name: Set noauto in mount options for {{ _device }}
      set_fact:
        mountopts: "noauto{% if mountopts %},{{mountopts}}{% endif -%}"
      when: >
        'noauto' not in mountopts
  when: encryption is defined

- name: Set readahead on {{ _device }} to {{ '%d' % ((readahead|int)/2048) }}MB
  shell: >
    blockdev --getra "{{ _device }}" &&
    blockdev --setra "{{ readahead }}" "{{ _device }}"
  args:
    executable: /bin/bash
  register: ra
  changed_when: >
    ra|succeeded and ra.stdout != readahead|string

- name: Set readahead on {{ _device }} at startup
  lineinfile:
    path: /etc/tpa/rc.local
    line: >-
      blockdev --setra "{{ readahead }}" "{{ _device }}"
    state: present
    insertbefore: EOF

- name: Create filesystem on {{ _device }}
  filesystem:
    dev: "{{ _device }}"
    fstype: "{{ fstype }}"
    opts: "{{ fsopts|default(omit) }}"

- name: Mount {{ _device }} under {{ mountpoint }}
  mount:
    src: "{{ _device }}"
    name: "{{ mountpoint }}"
    fstype: "{{ fstype }}"
    opts: "{{ mountopts }}"
    state: mounted
