---

# Uploads (playbook_dir/keys/)id_user{,.pub} to ~user/.ssh.
#
# - role: sys/ssh/install
#   user: xxx
#   ssh_key_dir: '/some/other/dir'
#   ssh_key_name: 'id_someothername'

# We copy the files as the target user and assume that they will be
# created with the correct uid/gid. Of course, most of the time the
# directory will be created correctly by the authorized_key module.

- name: Ensure that ~{{ ssh_user }}/.ssh exists
  file:
    path: "~{{ ssh_user }}/.ssh"
    state: directory
    mode: 0700
  become_user: "{{ ssh_user }}"
  become: yes

- name: Install keypair {{ _ssh_key_name }} for user {{ ssh_user }}
  action: copy
  args: "{{item}}"
  with_items:
    - src: "{{ _ssh_key_dir }}/{{ _ssh_key_name }}"
      dest: "~{{ ssh_user }}/.ssh/id_rsa"
      mode: 0600
    - src: "{{ _ssh_key_dir }}/{{ _ssh_key_name }}.pub"
      dest: "~{{ ssh_user }}/.ssh/id_rsa.pub"
      mode: 0640
  become_user: "{{ ssh_user }}"
  become: yes
