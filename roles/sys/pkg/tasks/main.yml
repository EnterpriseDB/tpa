---

# Copyright Â© EnterpriseDB Corporation

# Replace expired 2ndQuadrant apt repository keys, if needed.

- include_tasks: "os/{{ ansible_os_family }}/2ndquadrant-repository-keys.yml"
  when:
    ansible_os_family == "Debian"

# Ensure that a usable Python is installed, along with anything else we
# need to run Ansible modules such as "pkg" below.

- include_tasks: "os/{{ ansible_os_family }}/python.yml"

- name: Include pre-deploy hook
  include_tasks: "{{ hook }}"
  when:
    lookup('first_found', dict(files=hook, skip=True))
  vars:
    hook: "{{ cluster_dir }}/hooks/pre-deploy.yml"

# Configure package repositories ({apt,yum}_repositories,
# tpa_2q_repositories).

- set_fact:
    tpa_2q_repositories:
      - products/2ndqpostgres/release
  when:
    postgresql_flavour == '2q'
    and tpa_2q_repositories is not defined

- include_tasks:
    file: "os/{{ ansible_os_family }}/repositories.yml"
    apply:
      tags: public_repos

- name: Include post-repo hook
  include_tasks: "{{ hook }}"
  when:
    lookup('first_found', dict(files=hook, skip=True))
  vars:
    hook: "{{ cluster_dir }}/hooks/post-repo.yml"

# Install (non-Postgres-related) packages.

- include_tasks: packages.yml
