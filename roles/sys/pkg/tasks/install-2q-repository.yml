---

# Â© Copyright EnterpriseDB UK Limited 2015-2022 - All rights reserved.

- name: Install 2ndQuadrant repo and tail log if it fails
  block:

  - name: Install 2ndQuadrant repository {{ repo.repo }}
    shell: >
      set -o pipefail && curl -sS "{{ repo.url }}" | bash
    args:
      executable: /bin/bash
      creates: "{{ use_volatile_subscriptions|ternary(omit, repo.file) }}"
    register: reposub
    failed_when: >
      reposub.rc != 0 or 'error: ' in reposub.stdout.lower()

  rescue:

  - name: Show last few lines of installation log file, if it exists
    block:
    - name: set log_file
      set_fact:
        log_file: >
          {{ inst_log in ansible_failed_result.stdout
          |ternary(ansible_failed_result.stdout,ansible_failed_result.stderr)
          |regex_search('\/tmp\/2ndq_packages_installation\.log\..[a-z]+') }}

    - name: Fetch lines from {{ log_file }}
      shell: >
        set -o pipefail &&
        ls -tr {{ log_file }}
        | tail -n1
        | xargs tail -n5
      args:
        executable: /bin/bash
      register: inst_log_tail
      changed_when: False

    - name: Display lines from failed installation log
      fail:
        msg: "{{ inst_log_tail.stdout }}"
      when:
        not inst_log_tail.skipped

    vars:
      inst_log: /tmp/2ndq_packages_installation.log
    when:
      inst_log in ansible_failed_result.stdout
      or inst_log in ansible_failed_result.stderr

  - name: "Failed task '{{ ansible_failed_task.name }}'"
    fail:
      msg: "{{ ansible_failed_result }}"
