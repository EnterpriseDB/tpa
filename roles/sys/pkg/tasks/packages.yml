---

# Â© Copyright EnterpriseDB UK Limited 2015-2022 - All rights reserved.

- name: Check if sudo is available
  shell: >
    if ! command -v sudo >/dev/null 2>&1; then echo yes; fi
  register: needs_sudo
  changed_when: False
  check_mode: no

- name: Install required packages
  package:
    name: >
      {{ package_lists|flatten }}
    state: latest
  vars:
    package_lists:
      - "{{ default_packages['common'] }}"
      - "{{ packages['common']|default([]) }}"
      - "{{ default_packages[ansible_distribution] }}"
      - "{{ packages[ansible_distribution]|default([]) }}"
      - "{{ (needs_sudo.stdout.strip() == 'yes')|ternary(['sudo'], []) }}"

- name: Install optional packages
  package:
    name: "{{ item }}"
    state: latest
  with_items:
    - "{{ default_optional_packages['common'] }}"
    - "{{ optional_packages['common']|default([]) }}"
    - "{{ default_optional_packages[ansible_distribution] }}"
    - "{{ optional_packages[ansible_distribution]|default([]) }}"
  ignore_errors: yes

- name: Remove unwanted packages
  package:
    name: >
      {{ package_lists|flatten }}
    state: absent
  vars:
    package_lists:
      - "{{ default_unwanted_packages[ansible_distribution] }}"
      - "{{ unwanted_packages[ansible_distribution]|default([]) }}"
