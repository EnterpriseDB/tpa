---

# Â© Copyright EnterpriseDB UK Limited 2015-2025 - All rights reserved.

# If we haven't already done so, we must run some SQL scripts to set up
# the contents of the pem_database.

- name: Execute pemserver.sql
  community.postgresql.postgresql_script:
    connect_params: "{{ dsn|dbname(pem_database) }}"
    path: "{{ pem_base_dir }}/share/pemserver.sql"
  become_user: "{{ postgres_user }}"
  become: yes

# postgres expert was deprecated in PEM 10
# so we only need to set it up for older versions
- name: Execute postgresexpert.sql
  community.postgresql.postgresql_script:
    connect_params: "{{ dsn|dbname(pem_database) }}"
    path: "{{ pem_base_dir }}/share/postgresexpert.sql"
  become_user: "{{ postgres_user }}"
  become: yes
  when: not pem_is_v10_or_higher

- name: Grant role pem_admin to current user
  postgresql_query:
    conninfo: "{{ dsn|dbname(pem_database) }}"
    query: GRANT pem_admin TO current_user
  become_user: "{{ postgres_user }}"
  become: yes
