---

- include: basics.yml

- name: Appoint control node
  set_fact: control_hostname="{{ item }}"
  when: "hostvars[item].ec2_tag_node == '1'"
  with_items: play_hosts

- name: Unarchive Postgres-XL tarball onto control node
  unarchive:
    src: "{{ pgxl_tar_name }}"
    dest: /opt
    creates: "/opt/Postgres-XL-{{pgxlversion}}/bin/pgxc_ctl"
  when: inventory_hostname == control_hostname

- name: Copy /opt/Postgres-XL-{{pgxlversion}} to other nodes
  command: rsync -qa "{{ hostvars[control_hostname].ec2_private_ip_address }}:/opt/Postgres-XL-{{pgxlversion}}" /opt
  args:
    creates: "/opt/Postgres-XL-{{pgxlversion}}/bin/pgxc_ctl"
  when: inventory_hostname != control_hostname

- name: Link /opt/pgxl to /opt/Postgres-XL-{{pgxlversion}}
  file:
    path: /opt/pgxl
    src: "/opt/Postgres-XL-{{pgxlversion}}"
    state: link

- block:
    - name: Install pgxc_ctl.conf on control node
      template:
        src: pgxc_ctl.conf.j2
        dest: ~postgres/pgxc_ctl.conf
    - name: Run pgxc_ctl init all
      command: echo pgxc_ctl -c ~postgres/pgxc_ctl.conf init all
  when: inventory_hostname == control_hostname
  sudo_user: postgres
  sudo: true
