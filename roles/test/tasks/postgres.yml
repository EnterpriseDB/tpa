---

- name: Check if PGDATA has been initialised
  stat:
    path: "{{ postgres_data_dir }}/PG_VERSION"
  register: pgdata
  become_user: "{{ postgres_user }}"
  become: yes

- name: Set pgdata_initialised
  set_fact:
    pgdata_initialised: "{{ pgdata.stat.exists }}"

- name: Run pg_controldata
  command: >
    {{ postgres_bin_dir }}/pg_controldata {{ postgres_data_dir }}
  when: pgdata_initialised
  register: controldata
  become_user: "{{ postgres_user }}"
  become: yes

- include_tasks: output.yml
  vars:
    output_file: pg_controldata.txt
    content: |
      {{ controldata.stdout }}
  when:
    controldata is not skipped
