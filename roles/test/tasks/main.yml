---

- assert:
    msg: "output_dir must be defined"
    that: output_dir is defined

- name: Ensure that each instance has an output subdirectory
  local_action:
    module: file
    path: "{{ output_dir }}/{{ inventory_hostname }}"
    state: directory

- name: Create group(s) based on the value of bdr_node_group
  group_by:
    key: "{{ bdr_node_group }}"
  when: bdr_node_group is defined

- name: Run postgres tests
  block:
    - name: Check if PGDATA has been initialised
      stat:
        path: "{{ postgres_data_dir }}/PG_VERSION"
      register: pgdata
      become_user: "{{ postgres_user }}"
      become: yes

    - name: Set pgdata_initialised
      set_fact:
        pgdata_initialised: "{{ pgdata.stat.exists }}"

    - name: Check if repmgr.conf exists
      stat:
        path: "{{ repmgr_conf_file }}"
      register: repmgrconf
      become_user: "{{ postgres_user }}"
      become: yes

    - name: Set repmgr_initialised
      set_fact:
        repmgr_initialised: "{{ repmgrconf.stat.exists }}"

    - include_tasks: postgres.yml
      when: pgdata_initialised

    - include_tasks: repmgr.yml
      when: pgdata_initialised
      tags: repmgr
  when: >
    'postgres' in role
  tags: postgres

- include_tasks: barman.yml
  when: >
    'barman' in role
  tags: barman

- include_role: name=pgbench
  when: >
    'postgres' in role and pgdata_initialised
  tags: pgbench
