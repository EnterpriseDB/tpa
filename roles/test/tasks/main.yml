---

- assert:
    msg: "output_dir must be defined"
    that: output_dir is defined

- name: Ensure that each instance has an output subdirectory
  local_action:
    module: file
    path: "{{ output_dir }}/{{ inventory_hostname }}"
    state: directory

- name: Run postgres tests
  block:
    - name: Check if PGDATA has been initialised
      stat:
        path: "{{ postgres_data_dir }}/PG_VERSION"
      register: pgdata
      become_user: "{{ postgres_user }}"
      become: yes

    - name: Set pgdata_initialised
      set_fact:
        pgdata_initialised: "{{ pgdata.stat.exists }}"

    - include_tasks: postgres.yml
      when: pgdata_initialised
  when: >
    'postgres' in role
  tags: postgres

- include_tasks: barman.yml
  when: >
    'barman' in role
  tags: barman

- include_role: name=pgbench
  when: >
    'postgres' in role and pgdata_initialised
  tags: pgbench
