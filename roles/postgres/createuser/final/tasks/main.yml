---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

- name: Create Postgres users
  postgresql_user:
    port: "{{ postgres_port }}"
    name: "{{ item.username }}"
    encrypted: yes
    password: "md5{{ (vars[item.username+'_password'] + item.username)|hash('md5') }}"
    role_attr_flags: "{{ item.role_attrs|join(',') }}"
  with_items: "{{ postgres_users }}"
  become_user: "{{ postgres_user }}"
  become: yes

- name: Grant roles to Postgres users if required
  postgresql_membership:
    port: "{{ postgres_port }}"
    groups: "{{ item.granted_roles }}"
    target_role: "{{ item.username }}"
    state: present
  with_items: "{{ postgres_users }}"
  become_user: "{{ postgres_user }}"
  become: yes
  when:
    item.granted_roles is not empty
