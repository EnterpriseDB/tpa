---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

# Instances join the group with join_target_dsn set to first_bdr_primary
# unless they have a different upstream defined. If so, they must wait
# until the upstream has joined the group itself, so we perform group
# joins in two phases: first for instances without any upstream, and
# then for the remainder.

- name: Join BDR node groups
  include_tasks: bdr3/join-inner.yml
  with_items: >
    {{ groups[bdr_node_group]|difference([first_bdr_primary]) }}
  loop_control:
    loop_var: bdr_node
  vars:
    node_bdr_database_facts: >
      {{ hostvars[bdr_node].cluster_facts.databases[hostvars[bdr_node].bdr_database] }}
  when:
    hostvars[bdr_node].upstream is not defined
    and node_bdr_database_facts.bdr.node_group is empty

- name: Join BDR node groups with specified upstream
  include_tasks: bdr3/join-inner.yml
  vars:
    bdr_upstream: "{{ hostvars[bdr_node].upstream }}"
    bdr_upstream_dsn: "{{ hostvars[bdr_upstream].bdr_node_dsn }}"
    node_bdr_database_facts: >
      {{ hostvars[bdr_node].cluster_facts.databases[hostvars[bdr_node].bdr_database] }}
  with_items: >
    {{ groups[bdr_node_group]|difference([first_bdr_primary]) }}
  loop_control:
    loop_var: bdr_node
  when:
    hostvars[bdr_node].upstream is defined
    and node_bdr_database_facts.bdr.node_group is empty
