---

# Â© Copyright EnterpriseDB UK Limited 2015-2021 - All rights reserved.

- name: Remove unnecessary replication sets
  postgresql_query:
    conninfo: "{{ dsn|dbname(bdr_database) }}"
    queries:
    - text: SELECT bdr.drop_replication_set(set_name := %s)
      args:
      - "{{ item.set_name }}"
  with_items: "{{ existing_sets }}"
  vars:
    _set_names: "{{ publication_sets|json_query('[*].name') }}"
    _group_names: "{{ bdr_node_groups|json_query('[*].name') }}"
  when:
    publications is defined
    and item.set_name not in _set_names|union(_group_names)
  changed_when: True
  become_user: "{{ postgres_user }}"
  become: yes
