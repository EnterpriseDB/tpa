---
#- name: clone or update pglogical extension git
  git: repo="{{pglogical_ext_client_git_url}}" dest="{{pglogical_ext_client_git_checkout_dir}}"
       version="{{pglogical_ext_client_git_ref}}"
       reference="{{pglogical_ext_client_git_reference_repo}}"
  when: pglogical_ext_client_git_install

#- name: make build directory
  file: state=directory path="{{pglogical_ext_client_git_builddir}}"
  when: pglogical_ext_client_git_install

- name: configure pglogical extension - make all
  shell: "{{pglogical_ext_client_git_make_command}} USE_PGXS=1 clean && {{pglogical_ext_client_git_make_command}} USE_PGXS=1 all && {{pglogical_ext_client_git_make_command}} USE_PGXS=1 install"
  args:
    chdir: "{{pglogical_ext_client_git_builddir}}"
  environment:
    PATH: "{{item.install_dir}}/bin:{{ansible_env.PATH}}"
  when: pglogical_ext_client_git_install
  with_items:
    - { install_dir: "{{postgres_git_install_dir}}" }
    - { install_dir: "{{postgres_9_5_git_install_dir}}" }

- name: run make regresscheck
  shell: "{{pglogical_ext_client_git_make_command}} USE_PGXS=1 check "
  args:
    chdir: "{{pglogical_ext_client_git_builddir}}"
  environment:
    PATH: "{{item.install_dir}}/bin:{{ansible_env.PATH}}"
  when: pglogical_ext_client_git_install
  with_items:
    - { install_dir: "{{postgres_git_install_dir}}" }
    - { install_dir: "{{postgres_9_5_git_install_dir}}" }
