---

- name: Force-stop PostgreSQL
  shell: "{{item.install_dir}}/bin/pg_ctl -D {{item.datadir}} -w stop -m immediate"
  environment:
    PATH: "{{item.install_dir}}/bin:{{ansible_env.PATH}}"
    PGPORT: "{{item.port|int}}"
    PGUSER: "{{postgres_superuser}}"
  register: postgres_pg_ctl_stop_r
  changed_when: "postgres_pg_ctl_stop_r.rc == 0"
  failed_when: false
  with_items:
    - { install_dir: "{{postgres_git_install_dir}}", datadir: "{{postgres_datadir}}", port: "{{postgres_port}}" }
    - { install_dir: "{{postgres_9_5_git_install_dir}}", datadir: "{{postgres_9_5_datadir}}", port: "{{postgres_9_5_port}}" }
    - { install_dir: "{{postgres_9_4_git_install_dir}}", datadir: "{{postgres_9_4_datadir}}", port: "{{postgres_9_4_port}}" }

- name: delete datadir
  file: state=absent path="{{item.datadir}}"
  with_items:
    - { datadir: "{{postgres_datadir}}" }
    - { datadir: "{{postgres_9_5_datadir}}" }
    - { datadir: "{{postgres_9_4_datadir}}" }
