---

- name: Ensure that ~postgres/.pgpass exists
  file:
    path: ~postgres/.pgpass
    owner: "{{ postgres_user }}"
    group: "{{ postgres_group }}"
    mode: 0600
    state: touch

- name: Add postgres password to .pgpass
  lineinfile:
    path: ~postgres/.pgpass
    regexp: '^\*:\*:\*:postgres:'
    line: >-
      *:*:*:postgres:{{ escaped_password }}
  vars:
    escaped_password: >-
      {{ postgres_password|regex_replace('\\', '\\\\')|replace(':', '\:') }}

- name: Add repmgr password to .pgpass
  lineinfile:
    path: ~postgres/.pgpass
    regexp: '^\*:\*:\*:repmgr:'
    line: >-
      *:*:*:repmgr:{{ escaped_password }}
  vars:
    escaped_password: >-
      {{ repmgr_password|regex_replace('\\', '\\\\')|replace(':', '\:') }}
  when:
    repmgr_password is defined
