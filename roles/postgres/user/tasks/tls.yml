---

- name: Generate self-signed TLS key and certificate
  shell: >
    umask 077 &&
    /bin/echo -e "--\nState\nCity\nOrganization\nOrganizationalUnit\nlocalhost.localdomain\nroot@localhost.localdomain\n" |
    /usr/bin/openssl req -newkey rsa:2048 -keyout "{{ cluster_name }}.key" -nodes -x509 -days 365 -out "{{ cluster_name }}.crt"
  args:
    chdir: /etc/tpa
    creates: "{{ cluster_name }}.crt"
    executable: /bin/bash
  notify:
    - Note Postgres restart required

- name: Set correct ownership and mode on key/certificate files
  file:
    path: "{{ item }}"
    owner: "{{ postgres_user }}"
    group: "{{ postgres_group }}"
    mode: 0600
  with_items:
    - "/etc/tpa/{{ cluster_name }}.key"
    - "/etc/tpa/{{ cluster_name }}.crt"
