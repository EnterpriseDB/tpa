---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

# We can remove the pgbouncer.get_auth() function and the pgbouncer
# schema in every database, because by now we've switched to using
# pg_catalog.pgbouncer_get_auth() instead.

- name: Ensure pgbouncer schema is removed
  postgresql_query:
    conninfo: "{{ dsn|dbname(item) }}"
    queries:
      - text: DROP FUNCTION IF EXISTS pgbouncer.get_auth(text)
      - text: DROP SCHEMA IF EXISTS pgbouncer
  register: drop_schema
  become_user: "{{ postgres_user }}"
  become: yes
  with_items: "{{ cluster_facts.databases.keys()|list }}"
  when: >
    item not in ['template0', 'bdr_supervisordb']
    and 'pgbouncer' in cluster_facts.databases[item].schemas
    and (item not in cluster_facts.bdr_databases
      or inventory_hostname == first_bdr_primary
      or 'bdr' not in role)
