---

# Â© Copyright EnterpriseDB UK Limited 2015-2021 - All rights reserved.

# Handle setting synchronous_standby_names for non-BDR instances (see
# postgres/bdr/tasks/postgres-reconfig.yml for BDR instances).

- include_tasks: sync-replicas.yml
  when:
    synchronous_standby_names is defined
    and 'bdr' not in role

# Clean up old pgbouncer.get_auth() function if required.

- include_tasks: pgbouncer.yml
  when: >
    'replica' not in role

# If the bdr extension has been created in template1 and inherited by
# other databases (which is how we used to set it up), we should drop
# the extension in all but bdr_database.

- include_tasks: bdr-extension.yml
  vars:
    dbs_with_unused_bdr_extension: "{{
      cluster_facts.databases.values()
      |selectattr('bdr', 'defined')
      |selectattr('bdr.node', 'empty')
      |list
    }}"
  when: >
    'bdr' in role
    and 'primary' in role
    and dbs_with_unused_bdr_extension is not empty
