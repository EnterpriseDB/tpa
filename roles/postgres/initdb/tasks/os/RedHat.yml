---

# Do we have postgresqlNN-setup (from postgres-common) available? If so,
# we use it to create the cluster and make sure it starts up on boot.
# Otherwise, we fall back to initdb.

- name: Check for postgresql{{pgversionNN}}-setup
  stat: path="{{ postgres_bin_dir }}/postgresql{{pgversionNN}}-setup"
  register: setup

- block:
    - name: Create /etc/systemd/system/postgresql-{{pgversion}}.service
      template:
        src: postgresql.service.j2
        dest: /etc/systemd/system/postgresql-{{pgversion}}.service
      when: postgres_data_dir != default_postgres_data_dirs[ansible_os_family]
    - name: Run postgresql{{pgversionNN}}-setup to initialise data directory
      command: >
        {{ postgres_bin_dir }}/postgresql{{pgversionNN}}-setup initdb
      environment:
        TZ: UTC
        PGSETUP_INITDB_OPTIONS: >
          {% for x in postgres_initdb_opts %}{{x|quote}} {% endfor %}
  when: setup.stat.exists

- include: ../initdb.yml
  when: not setup.stat.exists
