---

# We take it for granted that we can connect to localhost as postgres to
# gather cluster facts.

- name: Collect facts about the Postgres cluster
  cluster_discovery:
    conninfo: ""
  become_user: "{{ postgres_user }}"
  become: yes
  when: >
    pgdata_initialised

- name: Ensure cluster_facts is set for all hosts
  set_fact:
    cluster_facts: "{{ cluster_facts|default({}) }}"

# If the role or upstream of the server has changed from what it was
# initially set to in config.yml, we override it here.

- name: Override instance role if required
  set_fact:
    role: "{{
      role
      |reject('equalto', 'primary')
      |reject('equalto', 'replica')
      |list|union([cluster_facts.role])
    }}"
  when: >
    'role' in cluster_facts and
    (('primary' in role and 'replica' in cluster_facts) or
     ('replica' in role and 'replica' not in cluster_facts))

- name: Record where this instance is configured to stream from
  set_fact:
    streaming_from: "{{ primary_conninfo|parse_conninfo('host') }}"
  when: >
    primary_conninfo != ''
  vars:
    primary_conninfo: "{{ cluster_facts|try_subkey('replica.primary_conninfo', '') }}"

- name: Override upstream if required
  set_fact:
    upstream: "{{ streaming_from }}"
  when:
    streaming_from is defined and
    (upstream is not defined or upstream != streaming_from)
