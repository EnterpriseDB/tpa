---

# We start, restart or reload Postgres depending on whether any tasks have
# notified the 'Note Postgres restart required' or
# 'Note Postgres reload required' handlers.
# In any case, Postgres will be running after this role completes.

- meta: flush_handlers

- name: Start, restart or reload Postgres
  service:
    name: "{{ postgres_service_name }}"
    state: "{{ postgres_service_end_state|default('started') }}"
  when:
    pgdata_initialised

- name: Wait for Postgres to become available
  command: >
    {{ postgres_bin_dir }}/pg_isready --timeout 5
  become_user: "{{ postgres_user }}"
  become: yes
  register: ready
  until: >
    ready.rc == 0
  failed_when: ready.rc > 1
  changed_when: False
  ignore_errors: yes
  retries: 6
  delay: 10
  when:
    pgdata_initialised
