---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

# Now that Postgres is up and running, we can perform additional tasks
# like creating users, databases, and extensions.

# First, we ensure that the users in postgres_users exist and have the
# desired attributes.
#
# The entries in postgres_users may be specified in config.yml, or come
# from invocations of postgres/createuser by other roles in TPAexec (to
# create, for example, the users required by repmgr or barman). We now
# generate passwords for any entries where postgres/createuser has not
# already generated one.
#
# postgres_users:
# - username: xyzzy
#   generate_password: true
#   role_attrs:
#   - superuser
#   - replication
#
# If an entry in postgres_users specifies ``generate_password: false``,
# we neither generate nor set a password for that user.

- name: Generate missing passwords
  include_role: name=secret
  vars:
    secret_name: "{{ item.username }}_password"
  with_items: "{{ postgres_users }}"
  when:
    secret_name not in vars
    and item.generate_password|default(true)

- name: Create Postgres users
  postgresql_user:
    port: "{{ postgres_port }}"
    name: "{{ item.username }}"
    password: "{{
      encrypted_password if generated_password is defined else omit
    }}"
    encrypted: yes
    role_attr_flags: "{{
      item.role_attrs|default([])|join(',') or omit
    }}"
  vars:
    secret_name: >-
      {{ item.username }}_password
    generated_password: >-
      {{ vars.get(secret_name) }}
    encrypted_password: >-
      md5{{ (generated_password + item.username)|hash('md5') }}
  with_items: "{{ postgres_users|default([]) }}"
  become_user: "{{ postgres_user }}"
  become: yes

# We act on "granted_roles" after the extensions are created, because
# some of the roles we want to grant may not exist until then (e.g.,
# bdr_application).

# We've already installed configuration files for any extensions that we
# care about; now it's time to issue CREATE EXTENSION commands.

- name: Install default Postgres extensions
  postgresql_ext:
    port: "{{ postgres_port }}"
    state: present
    db: "{{ item.0 }}"
    name: "{{ item.1 }}"
  with_nested:
    - [postgres, template1]
    - "{{ postgres_extensions|default([]) }}"
  become_user: "{{ postgres_user }}"
  become: true

# Now that extensions have been initialised, we can complete the task of
# granting roles to the appropriate users.

- name: Grant roles to Postgres users if required
  postgresql_membership:
    port: "{{ postgres_port }}"
    groups: "{{ item.granted_roles }}"
    target_role: "{{ item.username }}"
    state: present
  with_items: "{{ postgres_users|default([]) }}"
  become_user: "{{ postgres_user }}"
  become: yes
  when:
    item.granted_roles|default([]) is not empty

- include_tasks:
    file: pgbouncer.yml
    apply:
      tags: pgbouncer
  when: >
    postgres_users|json_query("[?username=='pgbouncer']") != []
    and ('bdr' not in role or inventory_hostname == first_bdr_primary)

- name: Include postgres-config-final hook
  include_tasks: "{{ hook }}"
  when:
    lookup('first_found', dict(files=hook, skip=True))
  vars:
    hook: "{{ cluster_dir }}/hooks/postgres-config-final.yml"
  tags: always
