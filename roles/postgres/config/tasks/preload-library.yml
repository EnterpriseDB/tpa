---

# Copyright © 2ndQuadrant Limited <info@2ndquadrant.com>

# This include file expects to be passed the name of a library to add to
# the list in shared_preload_libraries.

- assert:
    that:
      - library is defined

# We're willing to be a bit flexible about what we read in here. We
# accept multiple lines setting shared_preload_libraries (last one
# wins), and commented-out assignments are ignored.

- name: Read current value of shared_preload_libraries
  shell: >
    eval "libs=$(cat 2>/dev/null {{ conf }} {{ override }}|sed -n 's/^shared_preload_libraries *= *//p'|tail -1)" && echo $libs
  args:
    executable: /bin/bash
  changed_when: False
  register: libs
  vars:
    conf: "{{ _include_dir }}/0000-tpa.conf"
    override: "{{ _include_dir }}/8888-shared_preload_libraries.conf"

# But when it comes to writing out the file again, we don't make any
# attempt to retain whatever was in it before; as the warning clearly
# says, this file—like any other in _include_dir—is subject to being
# overwritten.

- name: Append {{ library }} to shared_preload_libraries
  template:
    src: variable.j2
    dest: "{{ spl_config }}"
    owner: "{{ postgres_user }}"
    group: "{{ postgres_group }}"
    mode: 0644
  vars:
    spl_config: "{{ _include_dir }}/8888-shared_preload_libraries.conf"
    variable: shared_preload_libraries
    value: >
      '{{ libs.stdout and libs.stdout.split(',')|map('trim')|list|union([library])|join(', ') or library }}'
  notify:
    - Note Postgres restart required
