---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

# Here we install any configuration required for the extensions to be
# installed. The "CREATE EXTENSION" commands will be issued later, via
# postgres/config/final.

- name: Set list of Postgres extensions
  set_fact:
    postgres_extensions: "{{
      postgres_extensions|default(
        default_postgres_extensions
        |union(extra_postgres_extensions)
        |union(('bdr' in role)|ternary(bdr_extensions, []))
      )
    }}"

- name: Remove pg_visibility for Postgres <9.6
  set_fact:
    postgres_extensions: "{{
      postgres_extensions
      |reject('equalto', 'pg_visibility')
      |list
    }}"
  when: postgres_version is version('9.6', '<')

# We install a default configuration for the extensions we care about.
# We don't need to have conditional logic in this template, because the
# configuration will be ignored if we aren't installing a particular
# extension after all.

- name: Install default extension configuration file
  template:
    src: extensions.conf.j2
    dest: "{{ _include_dir }}/1111-extensions.conf"
    owner: "{{ postgres_user }}"
    group: "{{ postgres_group }}"
    mode: 0644
  notify:
    - Note Postgres restart required

# Some extensions need entries in shared_preload_libraries.

- name: Add entries to shared_preload_libraries
  include_tasks: preload-library.yml
  when: library in postgres_extensions|default([])
  with_items:
    - pg_stat_statements
    - pglogical
    - bdr
  loop_control:
    loop_var: library
  tags: always
