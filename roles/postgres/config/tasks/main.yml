---

# This role is applied to every postgres instance with a valid PGDATA.
#
# We aspire to the following configuration layout:
#
# postgres_data_dir/
#   pg_hba.conf
#   postgresql.conf
#   conf.d/
#     0000-tpa.conf
#     0001-tpa_restart.conf
#     1111-extensions.conf
#     8888-{{ variable_name }}*.conf
#     8900-replica.conf
#     8901-replica_restart.conf
#     9900-role-settings.conf
#     9999-override.conf
#
# On a primary, we create pg_hba.conf and postgresql.conf, make the
# latter include conf.d, and create the various files inside conf.d.
#
# On a replica, we assume that the above configuration has been cloned
# and install the two replica override files (which include only those
# instance-specific settings that differ from the primary). As a minor
# concession to existing replicas, we make sure the include_dir+conf.d
# setup is in place, but do not create the other configuration files.
#
# We do not support making replica-specific changes to pg_hba.conf as a
# matter of principle (which is that such differences may interfere with
# switchover/failover operations).

- include_tasks: primary.yml
  when: >
    'replica' not in role

- include_tasks: replica.yml
  when: >
    'replica' in role
