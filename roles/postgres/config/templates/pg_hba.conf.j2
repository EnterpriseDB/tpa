{# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com> #}
# Automatically generated by postgres/config from pg_hba.conf.j2.
#
# Any changes made to this file may be overwritten.

# TYPE  DATABASE        USER            ADDRESS                 METHOD
local   all             {{ postgres_user }}                     peer
local   replication     all                                     peer
local   all             all                                     {{ postgres_hba_local_auth_method }}
{% if 'pgbouncer' in role %}
hostssl all {{ pgbouncer_auth_user }} 127.0.0.1/32 md5
{% endif %}
host    all             all             127.0.0.1/32            {{ password_encryption }}
host    all             all             ::1/128                 {{ password_encryption }}
host    replication     all             127.0.0.1/32            {{ password_encryption }}
host    replication     all             ::1/128                 {{ password_encryption }}
{% for net in cluster_networks|default([]) %}
host    postgres        barman          {{ net }}   {{ password_encryption }}
host    repmgr          repmgr          {{ net }}   {{ password_encryption }}
host    replication     all             {{ net }}   {{ password_encryption }}
host    all             all             {{ net }}   {{ password_encryption }}
{% else %}
{%   for h in groups[cluster_tag] %}
{%     set role=hostvars[h].get('role', []) %}
{%     set addr=hostvars[h].ip_address %}
{%     set type='hostssl' %}
{%     if addr == hostvars[h].get('openvpn_ip', '') and not hba_force_hostssl %}
{%       set type='host' %}
{%     endif %}
{%     set addr=addr+'/32' %}
{%     set method=password_encryption %}
{%     if hba_force_certificate_auth %}
{%       set method='cert' %}
{%       if hba_cert_authentication_map %}
{%         set method=method+' map='+hba_cert_authentication_map %}
{%       endif %}
{%     endif %}
# {{ h }}
{%     if 'pgbouncer' in role %}
hostssl all {{ pgbouncer_auth_user }} {{ addr }} md5
{%     endif %}
{%     if 'barman' in role %}
{{type}} postgres barman {{ addr }} {{ method }}
{{type}} replication streaming_barman {{ addr }} {{ method }}
{%     endif %}
{%     if 'postgres' in role %}
{{type}} all all {{ addr }} {{ method }}
{{type}} replication all {{ addr }} {{ method }}
{%     endif %}
{%     if 'haproxy' in role %}
host haproxy haproxy {{ addr }} {{ password_encryption }}
hostssl all all {{ addr }} {{ password_encryption }}
{%     endif %}
{%   endfor %}
{% endfor %}

{% for l in postgres_hba_settings %}
{{l}}
{% endfor %}
hostssl all all 0.0.0.0/0 {{ password_encryption }}
