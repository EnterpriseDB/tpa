---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

- name: Set postgres_version
  set_fact:
    postgres_version: "{{ version }}"
    postgres_versionNN: "{{ version|replace('.','') }}"
  vars:
    version: "{{ postgres_version|default(default_postgres_version) }}"
  tags: always

- name: Set postgres_{user,home,port} etc.
  set_fact:
    postgres_user: "{{ postgres_user|default(default_postgres_user) }}"
    postgres_group: "{{ postgres_group|default(default_postgres_user) }}"
    postgres_home: "{{ postgres_home|default(default_postgres_home_dirs[ansible_os_family]) }}"
    postgres_bin_dir: "{{ postgres_bin_dir|default(default_postgres_bin_dirs[ansible_os_family]) }}"
    postgres_data_dir: "{{ postgres_data_dir|default(default_postgres_data_dir) }}"
    postgres_host: "{{ postgres_host|default('localhost') }}"
    postgres_port: "{{ postgres_port|default(5432) }}"
    postgres_service_name: postgres
    postgres_installation_method: "{{ postgres_installation_method|default(default_postgres_installation_method) }}"
    install_from_source: "{{ install_from_source|default([]) }}"
    barman_user: "{{ barman_user|default(default_barman_user) }}"
    barman_group: "{{ barman_group|default(default_barman_group) }}"
    barman_home: "{{ barman_home|default(default_barman_home) }}"
    backup_name: "{{ backup_name|default(inventory_hostname) }}"
    repmgr_conf_dir: "{{ repmgr_conf_dir|default(default_repmgr_conf_dir) }}"
    bdr_database: "{{ bdr_database|default(default_bdr_database) }}"
    bdr_node_group: "{{ bdr_node_group|default(default_bdr_node_group) }}"
    wal_or_xlog: "{{ wal_string }}"
  vars:
    default_postgres_installation_method: >-
      {{ postgres_installation_source|default('pkg') }}
    wal_string: >-
      {%- if postgres_version is version('10', '>=') -%}wal
      {%- else -%}xlog
      {%- endif -%}
  tags: always

- name: Set default config paths
  set_fact:
    postgres_conf_dir: "{{ postgres_conf_dir|default('') or postgres_data_dir }}"
    repmgr_conf_file: "{{ repmgr_conf_dir }}/repmgr.conf"
  tags: always

- name: Set default DSNs
  set_fact:
    dsn: "port={{ postgres_port }}"
    postgres_dsn: "port={{ postgres_port }} dbname=postgres"
    node_dsn: >-
      host={{ inventory_hostname }} port={{ postgres_port }}
    repmgr_node_dsn: >-
      host={{ inventory_hostname }} port={{ postgres_port }} dbname=repmgr user=repmgr
    bdr_node_dsn: >-
      host={{ inventory_hostname }} port={{ postgres_port }} dbname={{ bdr_database }} user={{ postgres_user }}
  tags: always
