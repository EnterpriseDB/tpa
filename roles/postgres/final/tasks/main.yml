---

# Postgres is now running.

# We force an immediate backup for any instances that do not have any
# backups at all.

- include: ../../../barman/first-backup/tasks/main.yml
  static: no
  when: >
    backup is defined

# Were we invoked with pgbench=run?

- block:
    - block:
        - name: Determine if pgbench -i was run already
          postgresql_query:
            conninfo: "dbname=postgres user=postgres"
            query: >
              select count(*) as exists from information_schema.tables
              where table_name='pgbench_history'
          register: pgbench_history
        - include_role: name=pgbench/init
          when:
            pgbench_history.exists == 0
        - name: Run read/write pgbench
          include_tasks: pgbench.yml
          vars:
            pgbench_opts: -v -c 10 -j 5 -T 180
      when: >
        'primary' in role

    - name: Run read-only pgbench on replicas
      include_tasks: pgbench.yml
      vars:
        pgbench_opts: -n -c 10 -j 5 -T 180 -S
      when: >
        'replica' in role
  when: >
    pgbench|default('') == 'run'
  become_user: "{{ postgres_user }}"
  become: yes
  tags: pgbench
