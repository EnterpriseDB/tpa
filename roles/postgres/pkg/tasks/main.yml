---

# Given a Postgres version, we perform distribution-specific tasks to
# enable repositories and install Postgres packages.

- include_tasks: "os/{{ ansible_distribution }}.yml"
  tags: [postgres, pkg]

# At the moment, however, package installation is not distribution
# specific. This can be moved into os/ if that ever changes.
#
# We also install the python-psycopg2 package (because we need it to use
# Ansible's postgresql_* modules). If we install Postgres from source—or
# can't satisfy the python-psycopg2 package dependencies for some other
# reason—we'll need to "pip install psycopg2" after adding pgbindir to
# PATH (because pg_config is not always in PATH).

- name: Install Postgres packages
  package:
    name: >
      {{ query('flattened', package_lists) }}
    state: "{{
      (postgres_package_version is defined)|ternary('present', 'latest')
    }}"
  vars:
    package_lists:
      - "{{ postgres_packages|packages_for(ansible_distribution, postgres_package_version) }}"
      - "{{ postgres_debug_packages|packages_for(ansible_distribution, postgres_package_version) }}"
  tags: [postgres, pkg]

- name: Install additional Postgres packages
  package:
    name: >
      {{ query('flattened', package_lists) }}
    state: latest
  vars:
    package_lists:
      - "{{ additional_postgres_packages[ansible_distribution] }}"
      - "{{ ('bdr' in role)|ternary(bdr_packages[ansible_distribution], []) }}"
      - "{{ extra_postgres_packages[ansible_distribution] }}"
      - python-psycopg2
  tags: [postgres, pkg]

# On Postgres 9.5, pgespresso is required to support rsync-based backups
# from a replica. (To do so, we also have to create the extension on the
# corresponding primary, which we don't do by default yet, because the
# extension has known crash-the-server problems.)

- name: Install pgespresso packages for Postgres 9.5 and below
  package:
    name: "{{ pgespresso_packages[ansible_os_family] }}"
    state: latest
  when: >
    postgres_version is version(9.5, '<=')
  vars:
    pgespresso_packages:
      Debian:
        - postgresql-{{postgres_version}}-pgespresso
      RedHat:
        - pgespresso{{postgres_versionNN}}
  tags: [postgres, pkg]

# We install our own service units later, so we disable the packaged
# versions here.

- name: Disable default postgresql services
  systemd:
    name: "{{ default_postgres_service_names[ansible_os_family] }}"
    state: stopped
    masked: yes
