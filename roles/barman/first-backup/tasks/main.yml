---

# We force an immediate backup for any instances that do not have any
# backups at all.

- name: Count the number of backups for each instance
  shell: >
    barman list-backup {{ backup_name }} | grep -v FAILED | wc -l
  args:
    executable: /bin/bash
  register: backups
  delegate_to: "{{ backup }}"
  changed_when: False
  become_user: barman
  become: yes
  when: >
    backup is defined

- include: first-backup.yml
  static: no
  when: >
    backup is defined and backups.stdout == '0'
