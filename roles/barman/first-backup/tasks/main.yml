---

# We force an immediate backup for any instances that do not have any
# backups at all.

- name: Count the number of backups for each instance
  command: >
    barman diagnose
  register: diagnosis
  delegate_to: "{{ backup }}"
  changed_when: False
  become_user: barman
  become: yes

- set_fact:
    backups: "{{
      diagnosis.stdout|from_json
      |json_query('servers.%s.backups' % backup_name)
    }}"

- include_tasks: first-backup.yml
  when: >
    backups|json_query("*.{status:status}|[?status=='DONE']")|length == 0
