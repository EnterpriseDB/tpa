---

- name: Ensure ~barman/.ssh exists
  file: path=~barman/.ssh state=directory owner=barman group=barman mode=0755
  delegate_to: "{{barman_hostname}}"
  run_once: true

- name: Upload keypair barman server
  copy: src={{item}} dest=~barman/.ssh owner=barman group=barman mode=0600
  with_items:
    - "{{playbook_dir}}/id_rsa"
    - "{{playbook_dir}}/id_rsa.pub"
  delegate_to: "{{barman_hostname}}"
  run_once: true

- name: Set public key permissions
  file: path=~barman/.ssh/id_rsa.pub mode=0644
  delegate_to: "{{barman_hostname}}"
  run_once: true

- name: Install authorized keys
  authorized_key:
    user: barman
    key: "{{ lookup('file', playbook_dir+'/id_rsa.pub') }}"
  delegate_to: "{{barman_hostname}}"
  run_once: true

- name: Add dbservers to barman's known_hosts
  shell: ssh-keyscan -H "{{ item }}" >> ~barman/.ssh/known_hosts
  with_items: db_servers
  become_user: barman
  become: yes
  delegate_to: "{{barman_hostname}}"
