---

# Â© Copyright EnterpriseDB UK Limited 2015-2025 - All rights reserved.

# We have the following package sources available to us:
#
# 1. Repositories defined in {apt,yum}_repositories and listed in
#    {apt,yum}_repository_list (to activate the definitions). This
#    includes PGDG, EPEL, EDB Repos 1.0, and any extra user-defined
#    repositories. If you want to use the EDB repo, you must have an
#    EDB_REPO_CREDENTIALS_FILE.
#
# 2. Repositories listed in edb_repositories, which may be empty. We
#    always need an EDB_SUBSCRIPTION_TOKEN to access these repositories.
#    This is the preferred mechanism for new clusters, and everything we
#    need for PGD5 should come from them, but apart from that, everyone
#    does not have access to them yet (so we must use older repositories
#    in those cases).
#
# In principle, we want config.yml to spell out exactly which of these
# sources to use in any given cluster. However, must maintain backwards
# compatibility with decisions we've made in the past to implicitly add
# repositories in certain circumstances.

- set_fact:
    edb_repositories: "{{ edb_repositories|default([]) }}"
    edb_repos_token: "{{ lookup('env', 'EDB_SUBSCRIPTION_TOKEN') }}"

- assert:
    that:
      edb_repositories is not empty
      or bdr_version|default('0') is not version('5', '>=')
      or disable_repository_checks|default(false)
    fail_msg: >-
      You must set edb_repositories to use the PGD-Always-ON architecture

- assert:
    that: edb_repositories is empty or edb_repos_token != ''
    fail_msg: >-
      You must obtain a token from
      https://www.enterprisedb.com/repos-downloads and
      'export EDB_SUBSCRIPTION_TOKEN=<token>' to use edb_repositories

# To use EDB repositories (e.g., for EPAS), get a username/password from
# https://www.enterprisedb.com/user/register?destination=/repository-access-request
# and export EDB_REPO_CREDENTIALS_FILE=/path/to/file in the environment,
# where the file contains a single line with "username:password".

- name: Require EDB_REPO_CREDENTIALS_FILE for legacy EDB repository access
  assert:
    that:
      lookup('env', 'EDB_REPO_CREDENTIALS_FILE') != ''
    fail_msg: >-
      Export EDB_REPO_CREDENTIALS_FILE to use the EDB repository
      (see https://www.enterprisedb.com/user/ for credentials)
  when: >
    'EDB' in apt_repository_list|default([])
    or 'EDB' in yum_repository_list|default([])

- name: Validate EDB_REPO_CREDENTIALS_FILE setting
  vars:
    _file: "{{ lookup('env', 'EDB_REPO_CREDENTIALS_FILE') }}"
  when:
    _file != ''
  block:
  - stat:
      path: "{{ _file }}"
    register: _credsfile
    delegate_to: localhost
  - assert:
      msg: "EDB_REPO_CREDENTIALS_FILE={{ _file }} must exist and have mode 0600"
      that:
      - _credsfile.stat.exists
      - _credsfile.stat.mode == '0600'
  - assert:
      msg: "EDB_REPO_CREDENTIALS_FILE={{ _file }} must contain username:password"
      that:
      - _credentials != ''
      - _credentials.split(':')|length == 2
    vars:
      _credentials: "{{ lookup('file', _file) }}"
