---

# We generate a random secret using pwgen and store it in an encrypted
# file under the local vault directory.
#
# If ansible-playbook is invoked with the right --vault-password-file
# argument (or --ask-vault-pass), this will work transparently and not
# store unencrypted secrets on disk.

- assert:
    msg: "Please specify the secret_name to generate"
    that:
      - secret_name is defined

# Write «secret_name: '…contents…'» in YAML format into ansible-vault,
# so that we can load the result back in with include_vars.

- name: Generate encrypted secret {{ secret_name }}
  local_action: >
    shell ( flock -w 0.01 -n 9 || exit 99;
    /usr/bin/printf "{{ secret_name }}: >-\\n  $(pwgen -1y 32)\n" |
    ansible-vault encrypt --vault-password-file {{ _vault_passfile }} --output {{ secret_name }}.yml;
    exit 88 ) 9>/tmp/secret
  register: secret
  failed_when:
    secret.rc not in [0, 88, 99]
  changed_when:
    secret.rc == 88
  args:
    chdir: "{{ _vault_dir }}"
    creates: "{{ secret_name }}.yml"
  no_log: true
  sudo: no
  vars:
    _vault_passfile: vault_pass.txt

- name: Load generated secret {{ secret_name }}
  include_vars: "{{ _vault_dir }}/{{ secret_name }}.yml"
  no_log: true
