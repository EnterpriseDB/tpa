---

# We wait for each instance's reachability check to pass.
#
# This is normally quite fast, but some instances may take a long time
# to become reachable (or it may never happen). For more details, see:
#
# http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/monitoring-system-instance-status-check.html
# http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/TroubleshootingInstances.html
#
# (Note that it's also possible that just trying repeatedly to ssh into
# the instance will get us in faster than waiting for the checks to pass
# willâ€”but that's only when we can get in at all. On the whole, this has
# caused enough debugging problems that it's worth waiting longer.)

- name: Wait for instance reachability checks to pass
  local_action:
    module: ec2_instance_status
    instance_id: "{{ ec2_id }}"
    region: "{{ ec2_region }}"
  register: i
  until: >
    i.result.instance_state.name == 'running'
    and i.result.system_status.status == 'ok'
    and i.result.instance_status.status == 'ok'
    and i.result.system_status|json_query("details[?name=='reachability'].status|[0]") == 'passed'
    and i.result.instance_status|json_query("details[?name=='reachability'].status|[0]") == 'passed'
  retries: 60
