---

- include_tasks: hostvars.yml
  tags: always
- include_tasks: wait.yml
  tags: always

- name: Retrieve user-data failure log entries
  raw: >
    test -s {{ faillog }} && cat {{ faillog }}
  register: failures
  failed_when: False
  changed_when: >
    'stdout_lines' in failures and failures.stdout_lines|count > 0
  vars:
    faillog: /var/log/tpa-firstboot-failures.log

- name: Fail if user-data execution failed
  fail:
    msg: "{{ failures.stdout }}"
  when: >
    'stdout_lines' in failures and failures.stdout_lines|count > 0
