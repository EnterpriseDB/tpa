# We need to retrieve the instance's availability zone, which (a) can
# not always be inferred from config.yml (can be left unspecified), and
# (b) isn't provided by the inventory plugin. It's available directly
# from the instance metadata.
#
# If we ever need to retrieve more meta-data in future, we could parse
# the output of "aws ec2 describe-instances" or use ec2_instance_facts,
# or (depending on what it is) consider extending the inventory plugin.
#
# XXX Note this is superseded by setting the availability zone directly
# from ec2_instance_status, and therefore not included at all for now.

- name: Retrieve current availability zone
  raw: >
    if command -v wget >/dev/null 2>&1; then wget -q -O - {{ zone_url }};
    elif command -v curl >/dev/null 2>&1; then curl -s {{ zone_url }};
    else exit 2;
    fi
  register: az
  vars:
    zone_url: http://169.254.169.254/latest/meta-data/placement/availability-zone

- name: Set availability zone as fact
  set_fact:
    ec2_availability_zone: "{{ az.stdout }}"
