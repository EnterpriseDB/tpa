---

- assert:
    msg: "Ansible 2.6.x is required"
    that:
      - ansible_version.major == 2
      - ansible_version.minor == 6
  tags: prereqs

- name: Set tpa_dir
  set_fact:
    tpa_dir: "{{ lookup('env', 'TPA_DIR') or (role_path|regex_replace('/roles/platforms/vars/*', '')) }}"

- name: Ensure that local dependencies are installed
  become: no
  assert:
    msg: "Please install {{ item }} locally"
    that: path != ''
  with_items:
    - flock
  vars:
    path: "{{ lookup('pipe', 'command -v {{ item }} || true') }}"
  run_once: yes

- name: Ensure that password generation works correctly
  become: no
  assert:
    msg: "Please fix bin/password (e.g., install pwgen)"
    that:
      - password != ''
  vars:
    password: "{{ lookup('pipe', '{{ tpa_dir }}/bin/password || true') }}"
  run_once: yes

- include_tasks: ssh.yml

- include_role:
    name: "platforms/{{ platform }}"

- include_role: name=platforms/common
