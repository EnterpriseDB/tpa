---

- name: Set up TPA cluster nodes
  hosts: tag_Name_TestPlatforms
  gather_facts: no
  sudo_user: root
  sudo: true

  pre_tasks:
    - include: ../../../platforms/aws/hostvars.yml

    - name: Set the cluster_hostname for each node
      set_fact:
        cluster_hostname: "tpa-{{ node }}"
      tags: always

  roles:
    - role: postgres/vars
      postgres_version: 9.5

    - role: common

    - role: sys/tune
      tags: always

    - role: sys/sysctl
      tags: [sys, sysctl]

    - role: sys/fs
      device: /dev/xvdb
      mountpoint: "{{ postgres_home }}"
      tags: [sys, fs]

    - role: postgres/pkg
    - role: postgres/initdb

    - role: sys/ssh
      user: postgres
      tags: [sys, ssh]
