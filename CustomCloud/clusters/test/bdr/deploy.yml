---

- name: Set up TPA BDR node
  hosts: tag_Name_TPA_BDR
  gather_facts: no
  sudo_user: root
  sudo: true
  vars:
    pgversion: "9.4" 
    use_2ndquadrant_postgres: 'no'
    pg_device: /dev/xvdb
    pg_mountpoint: /var/lib/postgresql
    
  pre_tasks:

    - name: Set the node id as a fact
      set_fact: node_id="{{ ec2_tag_node }}"
      tags: always

    - name: Store the VPN address (basically ec2 PRIVATE IP address) as a fact
      set_fact:
        vpn_address: "{{ hostvars[item].ec2_private_ip_address }}"
      when: "hostvars[item].ec2_tag_node == node_id"
      with_items: "{{ play_hosts }}"
      tags: always

  roles:

    - role: common
      tags: common

    # Setup complete. Update, Upgrade and restart the instances
    - role: sys/instance
      tags: instance

    # Install the BDR packages and basic configuration files.
    - role: bdr/pkg
      tags: bdr
    
    - role: postgres/initdb
      tags: postgres

    - role: bdr/config
      tags: bdr
