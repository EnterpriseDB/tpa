---

- name: Set up TPA BDR cluster

  # This play targets all hosts in the cluster.
  hosts: tag_Cluster_TPA_BDR
  gather_facts: no
  any_errors_fatal: True
  max_fail_percentage: 0

  sudo_user: root
  sudo: true
  vars_files:
    - vars/main.yml

  pre_tasks:
    - include: ../../../platforms/aws/hostvars.yml

    # VPN server hostname: all deploys which we will use sys/openvpn will need this
    - name: Define vpn server hostname
      set_fact:
        vpn_server_hostname: "{{ item }}"
      with_items: "groups['tag_role_openvpn_server']"
      tags: always

  roles:

    - role: common

    - role: postgres/vars
      vars:
        postgres_version: 9.4
      tags: always

    # Setup complete. Update, Upgrade and restart the instances
    - role: sys/tune
      tags: always

    - role: sys/sysctl
      vars:
        sysctl_values:
          net.ipv4.ip_forward: 1
      tags: [sys, sysctl]

    - role: sys/fs
      vars:
        device: /dev/xvdb
        mountpoint: "{{ postgres_home }}"
      tags: [sys, fs]

    - role: sys/openvpn
      vpn_network: 192.168.33.0/24

    - role: sys/hosts
      tags: [sys, hosts]

    - role: sys/rsyslog
      tags: [sys, rsyslog]

- name: Set up TPA BDR nodes
  hosts: tag_Cluster_TPA_BDR:&tag_role_bdr
  gather_facts: no
  sudo_user: root
  sudo: true
  vars_files:
    - vars/main.yml

  roles:

    # Install the BDR packages and basic configuration files.
    - role: bdr/pkg
      when: >
        'bdr' in role
      tags: bdr

    - role: bdr/config
      when: >
        'bdr' in role
      tags: bdr

    - role: bdr/node
      when: >
        'bdr' in role
      tags: bdr

    - role: barman
      tags: barman

- name: Set up Barman node
  hosts: tag_Cluster_TPA_BDR:&tag_role_barman
  gather_facts: no
  sudo_user: root
  sudo: true
  vars_files:
    - vars/main.yml

  roles:

    # Setup backup from the BDR nodes
    - role: barman
      tags: barman

- name: Set up pgbouncer node
  hosts: tag_Cluster_TPA_BDR:&tag_role_pgbouncer
  gather_facts: no
  sudo_user: root
  sudo: true
  vars_files:
    - vars/main.yml

  roles:

    - role: pgbouncer
      tags: pgbouncer
