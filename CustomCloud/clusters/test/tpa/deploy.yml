---

- name: Set up TPA cluster nodes
  hosts: tag_Cluster_TPA
  sudo_user: root
  sudo: true

  pre_tasks:

    - include: ../../../platforms/aws/hostvars.yml
      tags: always

  roles:

    - role: common
      tags: common

    # Declare that we want to install Postgres 9.5. This just sets a few
    # handy defaults up front. The actual package installation happens a
    # few steps later.
    - role: postgres/vars
      vars:
        postgres_version: 9.5
      tags: always

    # Computes memory size and other instance-specific computations for
    # use in later steps (e.g. shared_buffers).
    - role: sys/tune
      tags: always

    # Set kernel-level configuration parameters persistently.
    - role: sys/sysctl
      tags: [sys, sysctl]

    # Set up any additional filesystems required. The block device
    # layout is instance-specific.
    - role: sys/fs
      vars:
        device: /dev/xvdb
        mountpoint: "{{ postgres_home }}"
      tags: [sys, fs]

    - role: postgres
      when: >
        'postgres' in role

    # Set up Barman backups.
    - role: barman
      tags: barman

    # Set up repmgr
    - role: repmgr
      tags: repmgr

    - role: postgres/final
      when: >
        'postgres' in role
      tags: [postgres, final]
