---

- name: Set up TPA BDR2 RHEL cluster
  hosts: tag_Cluster_BDR2TestRHEL
  any_errors_fatal: True
  max_fail_percentage: 0
  sudo_user: root
  sudo: true

  vars:
    ansible_distribution: RedHat
    ansible_distribution_release: 7.3

  pre_tasks:
    - include: ../../../platforms/aws/hostvars.yml
      tags: always
  # This is temporary hack for internal repository
    - name: Add internal-testing-bdr_2.0 repository
      yum_repository:
        name: internal-testing-bdr_2.0
        description: Internal-testing repository for bdr_2.0 rpm-centos-7 - x86_64
        baseurl: https://{{ lookup('env', 'BDR_USERNAME') }}:{{ lookup('env', 'BDR_PASSWORD') }}@ci.2ndquadrant.com/packages/internal-testing/bdr_2.0/latest/rpm/centos-7/x86_64/
        gpgkey: https://{{ lookup('env', 'BDR_USERNAME') }}:{{ lookup('env', 'BDR_PASSWORD') }}@ci.2ndquadrant.com/packages/internal-testing/RPM-GPG-KEY-2NDQ-INTERNAL-TESTING
        gpgcheck: yes

  roles:
    - role: common

    - role: postgres/vars
      vars:
        postgres_version: 9.6
      tags: always

    - role: postgres/repo
      tags: always

    - role: sys/tune
      tags: always

    - role: sys/sysctl
      vars:
        sysctl_values:
          net.ipv4.ip_forward: 1
      tags: [sys, sysctl]

    - role: sys/openvpn
      vpn_network: 192.168.33.0/24

    - role: sys/hosts
      tags: [sys, hosts]

    - role: sys/rsyslog
      tags: [sys, rsyslog]

    - role: bdr
      when: >
        'bdr' in role
      tags: bdr

    - role: barman
      tags: barman

    - role: pgbouncer
      tags: pgbouncer

    - role: postgres/final
      when: >
        'bdr' in role
      tags: [postgres, final]

    - role: bdr/node
      when: >
        'bdr' in role
      tags: bdr
