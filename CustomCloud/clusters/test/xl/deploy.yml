---

- name: Set up XLCloudTest cluster nodes
  hosts: tag_Cluster_XLCloudTest
  remote_user: ubuntu
  sudo_user: root
  sudo: true
  vars:
    pgxlversion: "9.5.4"
    pgxl_data_device: /dev/xvda
    pgxl_data_mountpoint: /data
    ansible_python_interpreter: '/usr/bin/python2.7'

  pre_tasks:

    - block:
        - name: Ensure cluster directory is specified
          assert:
            msg: "Please rerun with «-e cluster=/path/to/dir»"
            that:
              - cluster is defined and cluster != ''

        - name: Derive full path to cluster directory
          set_fact: cluster_dir="{{ cluster|realpath }}"

        - name: Load cluster configuration file
          include_vars: "{{ cluster_dir }}/config.yml"

        - name: Ensure cluster configuration is complete
          assert:
            msg: "Please define cluster configuration in {{cluster}}/config.yml"
            that:
              - cluster_name is defined and cluster_name != ''
              - instances | length > 0
      tags: always

    - include: ../../../platforms/aws/hostvars.yml
      tags: always

    - set_fact:
        node_id: "{{ ec2_tag_node }}"
      tags: always

    - name: Appoint control node
      set_fact: control_hostname="{{ item }}"
      when: "hostvars[item].ec2_tag_node == '1'"
      with_items: play_hosts

  roles:

    - role: common
      tags: common

    - role: sys/tune
      tags: systune

    - role: sys/sysctl
      tags: sysctl

    - role: sys/instance
      tags: upgrade

    - role: postgres/vars
      tags: vars

    - role: postgres-xl/src
      tags: xl

    - role: postgres-xl/config
      tags: config

    - role: postgres-xl/initall
      tags: initall
