---

- name: Set up TPA image nodes
  hosts: tag_Cluster_TPAImages
  any_errors_fatal: True
  max_fail_percentage: 0
  sudo_user: root
  sudo: true

  pre_tasks:
    - include: ../../platforms/aws/hostvars.yml
      tags: always

  roles:
    - role: postgres/vars
      vars:
        postgres_version: 9.6

    - role: common/pkg
    - role: postgres/pkg
    - role: pglogical/pkg
    - role: sys/openvpn/pkg
    - role: pgbouncer/pkg
    - role: barman/pkg
    - role: repmgr/pkg

    - role: sys/upgrade

- name: Generate AMIs
  hosts: tag_Cluster_TPAImages
  tasks:
    - name: Generate new AMIs
      ec2_ami:
        name: "2Q-TPA-{{ ansible_distribution }}-{{ lookup('pipe', 'date +%Y%m%d') }}"
        region: "{{ ec2_region }}"
        instance_id: "{{ ec2_id }}"
        wait: yes
      delegate_to: localhost
      tags: ami
