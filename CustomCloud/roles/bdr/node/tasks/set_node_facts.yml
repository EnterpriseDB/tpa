---

- name: Export bdr_node_dsn fact
  set_fact:
    bdr_node_dsn: "host={{ vpn_address }} port={{postgres_port}} dbname={{bdr_db_name}} user=postgres"

- name: Check for bdr node setup in the database
  shell: "{{pgbindir}}/psql '{{bdr_node_dsn}}' -qAtw -c \"SELECT 1 FROM bdr.bdr_nodes WHERE node_status != 'k' LIMIT 1;\""
  register: bdr_node_result

- name: Set bdr_node_exists fact
  set_fact:
    bdr_node_exists: "{{ bdr_node_result.stdout|int == 1 }}"

- name: Set bdr_control_host
  set_fact: bdr_control_host="{{ item }}"
  when: "hostvars[item].ec2_tag_node == '1'"
  with_items: play_hosts

- name: Set bdr_other_hosts
  set_fact: bdr_other_hosts="{{ play_hosts | difference([bdr_control_host]) | list }}"
