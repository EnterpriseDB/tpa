---

# Run these tasks only on the first node

- name: Appoint control node
  set_fact: control_hostname="{{ item }}"
  when: "hostvars[item].ec2_tag_node == '1'"
  with_items: play_hosts

- block:
  - name: Execute bdr_group_create
    shell: "{{pgbindir}}/psql '{{bdr_node_dsn}}' -qAtw -c \"SELECT bdr.bdr_group_create(local_node_name := '{{inventory_hostname}}', node_external_dsn := '{{bdr_node_dsn}}');\""
    when: not bdr_node_exists

  - name: Ensure that the node is ready to replicate
    shell: "{{pgbindir}}/psql '{{bdr_node_dsn}}' -qAtw 'SELECT bdr.bdr_node_join_wait_for_ready();'"
    when: not bdr_node_exists

# Configure other nodes from first node

  - name: Execute bdr_group_join
    shell: "{{pgbindir}}/psql '{{hostvars[item].bdr_node_dsn}}' -qAtw -c \"SELECT bdr.bdr_group_join(local_node_name := '{{item}}', node_external_dsn := '{{hostvars[item].bdr_node_dsn}}', join_using_dsn := '{{bdr_node_dsn}}');\""
    when: "hostvars[item].ec2_tag_node != '1' and not hostvars[item].bdr_node_exists"
    with_items: play_hosts

  - name: Ensure that the node is ready to replicate
    shell: "{{pgbindir}}/psql '{{hostvars[item].bdr_node_dsn}}' -qAtw -c 'SELECT bdr.bdr_node_join_wait_for_ready();'"
    when: "hostvars[item].ec2_tag_node != '1' and not hostvars[item].bdr_node_exists"
    with_items: play_hosts
  when: (control_hostname == inventory_hostname)

