---

- name: Install apt repository signing keys
  apt_key:
    id: "{{ item.value.key_id }}"
    url: "{{ item.value.key_url }}"
    state: present
  with_dict: "{{ default_apt_repositories|combine(apt_repositories) }}"

- name: Install apt repositories
  apt_repository:
    repo: "{{ item.value.repo|trim }}"
    state: present
    update_cache: no
  with_dict: "{{ default_apt_repositories|combine(apt_repositories) }}"

- name: Update apt cache
  apt: update_cache=yes

- block:
    - name: Install postgresql-common package
      package: name=postgresql-common state=latest
    - name: Change contents of /etc/postgresql-common/createcluster.conf file
      lineinfile:
         dest="/etc/postgresql-common/createcluster.conf"
         regexp=^#create_main_cluster
         line="create_main_cluster = false"
  when: ansible_distribution == 'Debian'

- name: Install Postgres packages
  package: name={{ item }} state=latest
  with_items: "{{ postgres_packages[ansible_distribution] }}"
