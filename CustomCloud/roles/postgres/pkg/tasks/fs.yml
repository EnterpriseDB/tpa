---

# Create a filesystem and mount it under pg_mountpoint
# blkid works fine on both Ubuntu and Centos
- block:
  - name: Check if {{ pg_device }} needs a filesystem
    shell: sudo blkid "{{ pg_device }}"
    register: fstype
    ignore_errors: true
  when: pg_mountpoint is defined

- block:

    - name: Create ext4 filesystem on PG volume {{ pg_device }}
      command: mkfs.ext4 "{{ pg_device }}"

    - name: Mount filesystem under {{ pg_mountpoint }}
      mount:
        name: "{{ pg_mountpoint }}"
        src: "{{ pg_device }}"
        fstype: ext4
        opts: noauto
        state: mounted

  when: (pg_mountpoint is defined and 'ext4' not in fstype.stdout)
