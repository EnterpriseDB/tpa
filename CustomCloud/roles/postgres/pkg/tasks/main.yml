---

- name: Ensure Postgres configuration is present
  assert:
    that:
      - pgversion is defined

# Given a Postgres version, we perform distribution-specific tasks to
# enable repositories and install Postgres packages.

- include: "os/{{ ansible_os_family }}.yml"
  tags: [postgres, pkg]

# At the moment, however, package installation is not distribution
# specific. This can be moved into os/ if that ever changes.
#
# We also install the python-psycopg2 package (because we need it to use
# Ansible's postgresql_* modules). If we install Postgres from source—or
# can't satisfy the python-psycopg2 package dependencies for some other
# reason—we'll need to "pip install psycopg2" after adding pgbindir to
# PATH (because pg_config is not always in PATH).

- name: Install Postgres packages
  package: name={{ item }} state=latest
  with_items:
    - "{{ postgres_packages[ansible_distribution] }}"
    - "{{ extra_postgres_packages[ansible_distribution] }}"
    - python-psycopg2
  tags: [postgres, pkg]

# We set pgbindir based on what packages we installed. Unfortunately, we
# can not assume that all Postgres binaries (e.g., pg_config) will be in
# our (or even postgres's) PATH.

- name: Set postgres_bin_dir based on distribution
  set_fact:
    pgbindir: "{{ postgres_bin_dir|default(default_postgres_bin_dirs[ansible_os_family]) }}"
    postgres_bin_dir: "{{ postgres_bin_dir|default(default_postgres_bin_dirs[ansible_os_family]) }}"
  tags: always
