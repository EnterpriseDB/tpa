---

- name: Ensure Postgres configuration is present
  assert:
    that:
      - pgversion is defined

- include: fs.yml
- include: packages.yml
- include_vars: "{{ansible_distribution}}.yml"

- name: Install psycopg2
  command: pip install psycopg2
  environment:
    PATH: /usr/local/bin:/usr/bin:/bin:{{ pgbindir }}

- name: Ensure the data directory exists
  file:
    path: "{{pgdata}}"
    state: directory
    owner: postgres
    group: postgres
    mode: 0700

- block:
    - name: Set PGDATA in postgresql-{{pgversion}}.service
      lineinfile:
        dest: "/lib/systemd/system/postgresql-{{pgversion}}.service"
        line: "Environment=PGDATA={{pgdata}}"
        regexp: "^Environment=PGDATA="
        state: present
    - name: Run initdb with the right data directory
      command: "{{pgbindir}}/postgresql{{pgversionNN}}-setup initdb"
      args:
        creates: "{{pgdata}}/PG_VERSION"
  when: ansible_distribution == 'redhat'

# If data checksum is required, we need to delete old directories
# We cannot just move them, because pg_createcluster will use a
# different port number to avoid collision with existing clusters
- block:
    - name: Check if Data Checksum is already enabled
      shell: psql -t -c "show data_checksums"
      register: dc_result
      sudo_user: postgres
  when: enable_data_checksum == 'yes'

- block:
    - name: Enable Data Checksum
      service: name="{{pgservice}}" state=stopped
      sudo_user: root
    - name: Remove existing cluster directory
      file: state=absent path="{{pgdata}}"
    - name: Remove existing config directory
      file: state=absent path="{{pgconf}}"
    - name: invoke pg_createcluster with --data-checksums
      command: pg_createcluster -p 5432 --start {{pgversion}} main -- --data-checksums
      sudo_user: root
  when: (enable_data_checksum == 'yes' and 'off' in dc_result.stdout)

- name: Install Postgres configuration files
  template:
    src="{{ item }}.j2" dest="{{ pgconf }}/{{ item }}"
    owner=postgres group=postgres mode=0640
  with_items:
    - pg_hba.conf
    - postgresql.conf
  register: pgconfig

- name: Restart Postgres
  service: name="{{pgservice}}" state=restarted
  when: pgconfig.changed

- name: Disable Postgres autostart on reboot
  service:
     name: postgresql
     enabled: no

# This will work ok once, but will fail when some nodes are
# converted into standby instances. Hence need to check for
# primary tag here..
- block:
  - name: Add pg_stat_statements to template1
    shell: psql -d template1 -c "CREATE EXTENSION IF NOT EXISTS pg_stat_statements"
    sudo_user: postgres

  - name: Add pg_stat_statements to postgres
    shell: psql -d postgres -c "CREATE EXTENSION IF NOT EXISTS pg_stat_statements"
    sudo_user: postgres
  when: (primary_hostname is defined and inventory_hostname == primary_hostname)

- include: ssh.yml
