---

# Postgres is now running.
#
# On any primary that we just set up, we load some data.

- include: load-data.yml
  static: no
  when: >
    'primary' in role and initdb is defined
  tags: pgbench

# We force an immediate backup for any instances that do not have any
# backups at all.

- name: Count the number of backups for each instance
  shell: >
    barman list-backup {{ backup_name }} | grep -v FAILED | wc -l
  register: backups
  delegate_to: "{{ backup }}"
  changed_when: False
  become_user: barman
  become: yes
  when: >
    backup != ''

- include: first-backup.yml
  static: no
  when: >
    backup != '' and backups.stdout == '0'

- block:
    - name: Run read/write pgbench
      include: pgbench.yml
      vars:
        pgbench_opts: -v -c 10 -j 5 -T 180
      static: no
      when: >
        'primary' in role

    - name: Run read-only pgbench on replicas
      include: pgbench.yml
      vars:
        pgbench_opts: -n -c 10 -j 5 -T 180 -S
      static: no
      when: >
        'replica' in role
  when: >
    pgbench|default('') == 'run'
  tags: pgbench
