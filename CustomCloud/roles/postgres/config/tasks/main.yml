# The caller may define postgres_hba_template or postgres_hba_settings
# to generate a custom pg_hba.conf (failing which we leave the default
# alone).

- name: Install pg_hba.conf from postgres_hba_template (optional)
  template:
    src: "{{postgres_hba_template}}"
    dest: "{{postgres_data_dir}}/pg_hba.conf"
  when: postgres_hba_template != ''

- name: Generate pg_hba.conf from postgres_hba_settings (optional)
  template:
    src: pg_hba.conf.j2
    dest: "{{postgres_data_dir}}/pg_hba.conf"
  when: postgres_hba_settings|length > 0

# The caller may define postgres_config_template to generate
# postgresql.conf (failing which we leave the default alone).

- name: Install postgresql.conf from postgres_config_template (optional)
  template:
    src: "{{postgres_config_template}}"
    dest: "{{postgres_data_dir}}/postgresql.conf"
  when: postgres_config_template != ''

- name: Create include_dir for extra configuration settings
  file:
    path: "{{postgres_data_dir}}/conf.d"
    state: directory 

- name: Enable include_dir in postgresql.conf
  lineinfile:
    dest: "{{postgres_data_dir}}/postgresql.conf"
    line: "include_dir = 'conf.d'"
    state: present
    regexp: "^#?include_dir"

- name: Generate managed.conf from postgres_config_settings (optional)
  template:
    src: managed.conf.j2
    dest: "{{postgres_data_dir}}/conf.d/managed.conf"
