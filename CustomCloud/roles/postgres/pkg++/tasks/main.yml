---

- name: Install Postgres configuration files
  template:
    src="{{ item }}.j2" dest="{{ pgconf }}/{{ item }}"
    owner=postgres group=postgres mode=0640
  with_items:
    - pg_hba.conf
    - postgresql.conf
  register: pgconfig
  
- name: Find the total RAM in kB
  command: awk '/^MemTotal:/ { print $2}' /proc/meminfo 
  register: memtotal
      
- name: Configure shared_buffers
  lineinfile:
     dest="{{ pgconf }}/postgresql.conf"
     regexp=^shared_buffers
     line="shared_buffers = {{ (memtotal.stdout|int/4096)|int|abs }}MB"     
  register: shared_buffers
  
- name: Restart Postgres
  service: name="{{pgservice}}" state=restarted
  when: pgconfig.changed

- name: Disable Postgres autostart on reboot
  service:
     name: postgresql
     enabled: no

# This will work ok once, but will fail when some nodes are
# converted into standby instances. Hence need to check for
# primary tag here..
- block:
  - name: Ensure pg_stat_statements is present in postgres
    postgresql_ext:
      state: present
      name: pg_stat_statements
      db: postgres
    sudo_user: postgres

  - name: Ensure pgstattuple is present in postgres
    postgresql_ext:
      state: present
      name: pgstattuple
      db: postgres
    sudo_user: postgres

  - name: Ensure pg_stat_statements is present in template1
    postgresql_ext:
      state: present
      name: pg_stat_statements
      db: template1
    sudo_user: postgres

  - name: Ensure pgstattuple is present in template1
    postgresql_ext:
      state: present
      name: pgstattuple
      db: template1
    sudo_user: postgres
    when: (primary_hostname is defined and inventory_hostname == primary_hostname)
