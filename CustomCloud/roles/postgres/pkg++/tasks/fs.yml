---

# Create a filesystem and mount it under pg_mountpoint
# blkid works fine on both Ubuntu and Centos
- block:
  - name: Check if {{ pg_device }} needs a filesystem
    shell: sudo blkid "{{ pg_device }}"
    register: fstype
    ignore_errors: true
  when: pg_mountpoint is defined

# The readahead on pg device is set to 32768 (in units of 512-byte sectors) 
# The value represents 16MB of readahead
- name: Configure block device readahead setting 
  shell: blockdev --setra 32768 "{{ pg_device }}"
  sudo: true
    
- name: Make readahead setting persistent after reboot
  lineinfile: 
    dest: /etc/rc.local
    mode: u+x
    insertbefore: "exit 0"
    line: blockdev --setra 32768 "{{ pg_device }}"

- block:

    - name: Create ext4 filesystem on PG volume {{ pg_device }}
      command: mkfs.ext4 "{{ pg_device }}"

    - name: Mount filesystem under {{ pg_mountpoint }}
      mount:
        name: "{{ pg_mountpoint }}"
        src: "{{ pg_device }}"
        fstype: ext4
        opts: noauto
        state: mounted

  when: (pg_mountpoint is defined and 'ext4' not in fstype.stdout)
