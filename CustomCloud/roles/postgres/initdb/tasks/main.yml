---

- name: Set Postgres data directory
  set_fact:
    postgres_data_dir: "{{ postgres_data_dir|default(default_postgres_data_dirs[ansible_os_family]) }}"
    postgres_conf_dir: "{{ postgres_conf_dir|default(default_postgres_conf_dirs[ansible_os_family]) }}"
    postgres_service_name: "{{ postgres_service_name|default(default_postgres_service_names[ansible_os_family]) }}"
  tags: always

- name: Set default postgres_conf_dir
  set_fact:
    postgres_conf_dir: "{{ postgres_data_dir }}"
  when: >
    postgres_conf_dir == ''
  tags: always

# postgres_data_dir is something like /var/lib/pgsql/9.6/data. We can
# expect postgres_home (/var/lib/pgsql) to exist and have the right
# ownership (postgres:postgres), but we may need to create the next
# level of subdirectories.

- name: Ensure the data directory exists
  file:
    path: "{{ postgres_data_dir }}"
    owner: postgres
    group: postgres
    mode: 0700
    state: directory
  tags: [postgres, initdb]

- name: Check to see if the data directory is empty
  stat: path="{{ postgres_data_dir }}/PG_VERSION"
  register: pgdata
  tags: [postgres, initdb]

- block:
    - set_fact: initdb=True
    - include: "os/{{ ansible_os_family }}.yml"
  when: not pgdata.stat.exists
  tags: [postgres, initdb]
