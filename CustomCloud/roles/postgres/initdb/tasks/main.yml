---

- name: Set Postgres data directory
  set_fact:
    postgres_data_dir: "{{ postgres_data_dir|default(default_postgres_data_dirs[ansible_os_family]) }}"
    postgres_conf_dir: "{{ postgres_conf_dir|default(default_postgres_conf_dirs[ansible_os_family]) }}"
    postgres_service_name: "{{ postgres_service_name|default(default_postgres_service_names[ansible_os_family]) }}"
  tags: always

- name: Set default postgres_conf_dir
  set_fact:
    postgres_conf_dir: "{{ postgres_data_dir }}"
  when: >
    postgres_conf_dir == ''
  tags: always

- name: Ensure postgres directories exist and have the right permissions
  file:
    path: "{{ item }}"
    owner: postgres
    group: postgres
    mode: 0700
    state: directory
  with_items:
    - "{{ postgres_home }}"
    - "{{ postgres_data_dir }}"
  tags: [postgres, initdb]

- name: Check to see if the data directory is empty
  stat: path="{{ postgres_data_dir }}/PG_VERSION"
  register: pgdata
  tags: [postgres, initdb]

- block:
    - set_fact: initdb=True
    - include: "os/{{ ansible_os_family }}.yml"
  when: not pgdata.stat.exists
  tags: [postgres, initdb]
