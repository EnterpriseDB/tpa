---

# Do we have pg_createcluster (from postgres-common) available? If so,
# we use it to create the cluster and make sure it starts up on boot.
# Otherwise, we fall back to initdb.

- name: Check for pg_createcluster
  command: which pg_createcluster
  ignore_errors: yes
  register: common

- name: Run pg_createcluster to create data directory
  command: >
    pg_createcluster -d {{ postgres_data_dir }} -p 5432 --start-conf auto {{ pgversion }} main -- \
      {% for x in postgres_initdb_opts %}{{x|quote}} {% endfor %}
  become: true
  when: common|succeeded

- include: initdb.yml
  when: common|failed
