---

# roles/icinga-host/tasks/icinga.yml
#
# Install icinga packages and configuration files

- name: Preset icinga/check_external_commands
  debconf: name=icinga-common question='icinga/check_external_commands' value=true vtype=boolean

- name: Install icinga meta package
  apt: pkg=icinga state=latest

- name: Remove icinga doc package
  apt: pkg=icinga-doc state=absent

- name: Remove unwanted icinga sample configuration files
  file: path=/etc/icinga/objects/{{item}} state=absent
  with_items:
    - contacts_icinga.cfg
    - extinfo_icinga.cfg
    - generic-host_icinga.cfg
    - generic-service_icinga.cfg
    - hostgroups_icinga.cfg
    - localhost_icinga.cfg
    - services_icinga.cfg
    - timeperiods_icinga.cfg

- name: htpasswd file
  copy: src=htpasswd.users dest=/etc/icinga/htpasswd.users

# For the following two items, see: /usr/share/doc/icinga-common/README.Debian
# Note: we should probably find a way of executing dpkg-statoverride as
# described in the above file, rather than setting the permissions directly

- name: Set permissions for /var/lib/icinga/rw
  file: path=/var/lib/icinga/rw owner=nagios group=www-data mode=2710

- name: Set permissions for /var/lib/icinga
  file: path=/var/lib/icinga owner=nagios group=nagios mode=751
  notify: Restart icinga

- name: icinga.cfg
  copy: src=icinga/icinga.cfg dest=/etc/icinga/icinga.cfg
  notify: Reload icinga

- name: commands.cfg
  copy: src=icinga/commands.cfg dest=/etc/icinga/commands.cfg
  notify: Reload icinga

- name: resource.cfg
  copy: src=icinga/resource.cfg dest=/etc/icinga/resource.cfg owner=root group=nagios mode=0640
  notify: Reload icinga

- name: icinga object configuration files
  copy: src={{item}} dest=/etc/icinga/objects/
  with_fileglob: "icinga/*.cfg"
  notify: Reload icinga

- name: Apache configuration file for icingca
  template: src=rdba-icinga-ssl.j2 dest=/etc/apache2/sites-available/rdba-icinga-ssl
  notify: Restart apache

- name: Apache site-enabled link
  file: src=../sites-available/rdba-icinga-ssl dest=/etc/apache2/sites-enabled/rdba-icinga-ssl state=link force=yes
  notify: Restart apache

- name: enable mod_rewrite
  apache2_module: state=present name=rewrite
  notify: Restart apache

- name: .rtrc for icinga
  copy: src=icinga/.rtrc dest=/var/lib/nagios/.rtrc owner=nagios group=nagios mode=0600

- name: rt wrapper
  copy: src=icinga/rt_wrapper.pl dest=/usr/local/bin/rt_wrapper.pl owner=root group=root mode=0755

- name: spool directory for perfdata
  file: path=/var/lib/icinga/graphios owner=nagios group=nagios state=directory mode=0750 
