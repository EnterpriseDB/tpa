---

# roles/client/tasks/nsca-debian-old.yml
#
# Compile nsca-ng client on old Debian-based systems (Debian <= 7 and Ubuntu <= 12.04)

  # Check that standard directories exist
- name: Ensure ~/var directory exists
  file: path=~/var state=directory

  # Fetch dependencies
- name: Install nsca dependencies
  apt: name={{ item }} state=latest
  with_items:
    - build-essential
    - make
  become: true

- name: Download nsca-ng 1.4
  get_url: url=http://www.nsca-ng.org/download/nsca-ng-1.4.tar.gz dest=~/var/nsca-ng-1.4.tar.gz

- name: Extract the nsca-ng archive
  unarchive: src=~/var/nsca-ng-1.4.tar.gz dest=~/var copy=no

  # Build nsca-ng
- name: Build confuse for nsca-ng
  command: build-aux/make-confuse
  args:
    chdir: ~/var/nsca-ng-1.4
    creates: ~/var/nsca-ng-1.4/lib/confuse/lib/libconfuse.a

- name: Build openssl for nsca-ng
  command: build-aux/make-openssl
  args:
    chdir: ~/var/nsca-ng-1.4
    creates: ~/var/nsca-ng-1.4/lib/ssl/lib/libssl.a

- name: Configure nsca-ng
  command: ./configure
  args:
    chdir: ~/var/nsca-ng-1.4
    creates: ~/var/nsca-ng-1.4/Makefile

- name: Build nsca-ng
  command: make
  args:
    chdir: ~/var/nsca-ng-1.4
    creates: ~/var/nsca-ng-1.4/src/client/send_nsca

  # Deploy the executable
- name: Copy send_nsca
  synchronize: mode=pull src=~/var/nsca-ng-1.4/src/client/send_nsca dest=~/bin/send_nsca
  delegate_to: "{{inventory_hostname}}"

