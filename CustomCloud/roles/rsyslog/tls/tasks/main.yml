---

- name: Ensure {{playbook_dir}}/certs exists locally
  local_action:
    module: file
    path: "{{ playbook_dir }}/certs"
    state: directory
  run_once: yes
  sudo: no

- name: Generate a Certificate Authority Private Key file using certtool
  local_action: command certtool --generate-privkey --outfile ca_key.pem
  args:
    chdir: "{{ playbook_dir }}/certs"
  run_once: yes
  sudo: no

- name: Combine the template file with the private key file to create the CA Certificate file
  local_action: command certtool --generate-self-signed \
                --template ca.j2 \
                --load-privkey ca_key.pem \
                --outfile ca_certificate.pem
  args:
    chdir: "{{ playbook_dir }}/certs"
  run_once: yes
  sudo: no

- name: Copy the certificate from local node to all hosts
  copy: src=ca_certificate.pem dest=/etc/rsyslog.d/ca_certificate.pem
