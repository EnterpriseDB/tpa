# Modules
$ModLoad imuxsock.so
$ModLoad imklog.so
$ModLoad imudp.so
$ModLoad imtcp.so

# Listen on network
$UDPServerAddress 0.0.0.0
$UDPServerRun 514
$InputTCPServerAddress 0.0.0.0
$InputTCPServerRun 514

# Config for TLS
$DefaultNetstreamDriver gtls

# Specify the certificate files
$DefaultNetstreamDriverCAFile    /etc/pki/rsyslog/ca.pem
$DefaultNetstreamDriverCertFile  /etc/pki/rsyslog/rsyslog-cert.pem
$DefaultNetstreamDriverKeyFile   /etc/pki/rsyslog/rsyslog-key.pem

# Because we can't predict hostnames, and because cloud servers
# are dynamically deployed and we don't want to have to create
# unique certificates for each one, we will validate the
# certificate itself but not insist that the name match.
$InputTCPServerStreamDriverAuthMode x509/certvalid

## How to accept connections
$InputTCPServerStreamDriverMode 1 # run driver in TLS-only mode

# Enable non-kernel facility klog messages
$KLogPermitNonKernelFacility on

# Reduce any duplicates
$RepeatedMsgReduction on
# Enable disk mode for receive buffer
$WorkDirectory /var/spool/rsyslog
$MainMsgQueueFileName mainq

# Permissions
$FileOwner syslog
$FileGroup adm
$FileCreateMode 0640
$DirCreateMode 0755
$Umask 0022
$PrivDropToUser syslog
$PrivDropToGroup syslog

# Basic local logging
*.info;\
	mail.none;\
	authpriv.none;\
	cron.none		/var/log/messages

auth,authpriv.*			/var/log/auth.log
kern.*					-/var/log/kern.log
mail.*					-/var/log/mail.log
cron.*					/var/log/cron.log

*.emerg					:omusrmsg:*

# Configure per host logging for postgresql
$template DailyPerHostLogs,"/var/log/hosts/%HOSTNAME%/%PROGRAMNAME%.%$YEAR%-%$MONTH%-%$DAY%.log"
if $programname == 'postgres' then -?DailyPerHostLogs;RSYSLOG_FileFormat
