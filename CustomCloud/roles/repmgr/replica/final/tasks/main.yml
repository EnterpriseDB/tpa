---

# If the replica is already registered, we don't need to do anything.

- name: Check if the replica is registered
  command: >
    {{ psql }} '{{ primary_conninfo }}' -qAtw -c
    "SELECT 'replica' FROM \"{{ repmgr_schema }}\".repl_nodes WHERE type='standby' and name='{{ inventory_hostname }}'"
  vars:
    psql: '{{ postgres_bin_dir }}/psql'
    primary_conninfo: 'host={{ upstream_primary }} user=repmgr dbname=repmgr'
    repmgr_schema: 'repmgr_{{ upstream_primary }}'
  register: regtype
  changed_when: False
  become_user: postgres
  become: yes

# Just to be on the safe side, fail if the instance is registered as
# something other than a replica.

- fail:
    msg: >
      {{ inventory_hostname }} is tagged as replica of {{ upstream_primary }},
      but is registered as a {{ regtype.stdout }} already"
  when: >
    regtype.stdout != '' and regtype.stdout != 'replica'

- include: clone.yml
  when: >
    regtype.stdout == ''
