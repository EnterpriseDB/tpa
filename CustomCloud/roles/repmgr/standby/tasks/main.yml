---

- name: Check if the standby is registered
  shell: repmgr -f /etc/repmgr/repmgr.conf cluster show | grep {{hostvars[inventory_hostname]['vpn_address']}}
  sudo_user: postgres
  ignore_errors: True
  changed_when: False
  register: standby

- block:
    - name: Stop Postgres
      service: name=postgresql state=stopped
      sudo_user: root
    - name: Move existing cluster directory
      command: mv /var/lib/postgresql/{{pgversion}}/main /var/lib/postgresql/{{pgversion}}/main.backup
      ignore_errors: yes
    - name: Create new cluster directory
      file: path=/var/lib/postgresql/{{pgversion}}/main state=directory
    - name: Run repmgr standby clone
      command: repmgr -D /var/lib/postgresql/{{pgversion}}/main -d repmgr -U repmgr --verbose standby clone {{hostvars[primary_hostname]['vpn_address']}}
    - name: Move over conf files to proper location
      command: mv {{pgdata}}/{{item}} {{pgconf}}/{{item}}
      with_items:
        - postgresql.conf
        - pg_hba.conf
        - pg_ident.conf
    - name: Start Postgres
      service: name=postgresql state=started
      sudo_user: root
    - name: Run repmgr standby register
      command: repmgr -f /etc/repmgr/repmgr.conf --verbose standby register
  when: standby|failed
  sudo_user: postgres

- name: Start repmgrd after standby registration
  sudo_user: root
  service: name=repmgrd state=restarted
