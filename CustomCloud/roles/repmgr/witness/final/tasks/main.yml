---

- name: Create repmgr database
  postgresql_db:
    name: repmgr
    owner: repmgr
    state: present
  become_user: postgres
  become: yes

- name: Check if the witness is registered
  shell: >
    {{ postgres_bin_dir }}/psql 'host={{ upstream_primary }} user=repmgr dbname=repmgr' \
      -qAtw -c "SELECT type FROM \"repmgr_{{ upstream_primary }}\".repl_nodes WHERE type = 'witness' and name = '{{ inventory_hostname }}';"
  register: witness
  ignore_errors: True
  changed_when: False
  become_user: postgres
  become: yes

- name: Run 'repmgr witness register' on the witness
  command: >
    {{ postgres_bin_dir }}/repmgr witness register --verbose \
      -f "{{ repmgr_conf_dir }}/repmgr.conf" \
      -h "{{ upstream_primary }}"
  become_user: postgres
  become: yes
  when: witness.stdout.find('witness') == -1
