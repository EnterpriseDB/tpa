---

- include_vars: "{{ansible_distribution}}.yml"

- name: "Update postgresql.conf on {{current_host}}"
  lineinfile:
     dest="{{ postgres_conf_dir }}/postgresql.conf"
     regexp='\/bin\/true'
     line="archive_command = 'rsync -a %p barman@{{barman_hostname}}:{{ barman_home }}/{{ customerid + \'_\' + serviceid + \'_\' + hostvars[current_host]["db"] + hostvars[current_host]["node"] | lower}}/incoming/%f'"
  delegate_to: "{{ current_host }}"
  register: pgconfig

- name: Restart Postgres on "{{current_host}}"
  service: name="{{pgservice}}" state=restarted
  when: pgconfig.changed
  delegate_to: "{{ current_host }}"
