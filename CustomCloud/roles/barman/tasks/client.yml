---

# These tasks are executed on any instance that needs to be backed up.
#
# First, we delegate some per-client server configuration tasks to the
# designated backup server for each host.

- name: Check if Barman client configuration file exists
  stat:
    path: "{{ _config_file }}"
  delegate_to: "{{ backup }}"
  register: conf

- name: Install Barman client configuration file
  template:
    src: barman.d.conf.j2
    dest: "{{ _config_file }}"
    owner: barman
    group: barman
    mode: 0600
  delegate_to: "{{ backup }}"

# If we created the client configuration file, then this is the first
# time we're setting up backups for this server.

- block:
    - set_fact: initialise_backup=True

    - name: Set client configuration to inactive pending initialisation
      ini_file:
        dest: "{{ _config_file }}"
        section: "{{ backup_name }}"
        option: active
        value: "false"
      delegate_to: "{{ backup }}"
  when: not conf.stat.exists

- name: Set up a cron job to take regular backups
  cron:
    user: barman
    cron_file: /etc/cron.d/barman
    name: Backup from server {{ backup_name }}
    minute: "{{ _barman_backup_interval[0] }}"
    hour: "{{ _barman_backup_interval[1] }}"
    day: "{{ _barman_backup_interval[2] }}"
    month: "{{ _barman_backup_interval[3] }}"
    weekday: "{{ _barman_backup_interval[4] }}"
    job: >
      [ -x /usr/bin/barman ] && /usr/bin/barman backup {{ backup_name }}
    state: present
  delegate_to: "{{ backup }}"
