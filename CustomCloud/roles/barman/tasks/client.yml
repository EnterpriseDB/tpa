---

# These tasks are executed on any instance that needs to be backed up.
#
# First, we delegate some per-client server configuration tasks to the
# designated backup server for each host.

- name: Install Barman configuration file for each client
  template:
    src: barman.d.conf.j2
    dest: "/etc/barman.d/{{ _backup_name }}.conf"
    owner: barman
    group: barman
    mode: 0600
  delegate_to: "{{ backup }}"

- name: Set up a cron job to take regular backups
  cron:
    user: barman
    cron_file: /etc/cron.d/barman
    name: Backup from server {{ _backup_name }}
    job: >
      [ -x /usr/bin/barman ] && /usr/bin/barman backup {{ _backup_name }}
    state: present
  delegate_to: "{{ backup }}"
