---
- block:
    - name: PostgreSQL | Add PostgreSQL repository apt-key
      apt_key:
        id: ACCC4CF8
        url: "https://www.postgresql.org/media/keys/ACCC4CF8.asc"
        state: present

    - name: PostgreSQL | Add PostgreSQL repository
      apt_repository:
        repo: 'deb http://apt.postgresql.org/pub/repos/apt/ {{ ansible_distribution_release }}-pgdg main'
        state: present
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

- block:
    - name: Install PGDG repository RPM
      command: rpm -ivh http://yum.postgresql.org/9.4/redhat/rhel-7-x86_64/pgdg-redhat94-9.4-1.noarch.rpm
      register: rpm
      changed_when: "'is already installed' not in rpm.stdout"
      ignore_errors: yes
    - name: Ensure that barman comes from PGDG
      ini_file:
        dest: /etc/yum/pluginconf.d/rhnplugin.conf
        section: main
        option: exclude
        value: barman*
  when: ansible_distribution == 'RedHat'

- name: Download barman for debian
  apt: pkg=barman state=latest update_cache=yes
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'
  tags: packages

- name: Download barman for redhat
  yum: pkg=barman state=latest update_cache=yes
  when: ansible_distribution == 'RedHat'
  tags: packages
