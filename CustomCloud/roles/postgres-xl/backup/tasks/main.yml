---

# Generate a list of hosts with proper variables set up
# to pass on to the barman role
- name: Add backup server to backup_nodes group
  add_host:
    name: "{{item}}-barman"
    ansible_host: "{{ hostvars[item].public_ip }}"
    ip_address: "{{ hostvars[item].ip_address }}"
    groups: [backup_nodes, "{{ hostvars[item].cluster_tag }}"]
    ansible_os_family: "{{ hostvars[item].ansible_os_family }}"
    ansible_distribution_release: "{{ hostvars[item].ansible_distribution_release }}"
    ansible_pkg_mgr: "{{ hostvars[item].ansible_pkg_mgr }}"
    cluster_name: "{{ hostvars[item].cluster_name }}"
    role: "{{ hostvars[item].role }}"
    parent_inventory_hostname: "{{item}}"
    backup: ""
  with_items: "{{ groups['tag_role_barman'] }}"

- name: Add coordinators to backup_nodes group
  add_host:
    name: "{{item.0}}-{{ item.1 }}"
    ansible_host: "{{ hostvars[item.0].public_ip}}"
    ip_address: "{{ hostvars[item.0].ip_address}}"
    groups: [backup_nodes, "{{ hostvars[item.0].cluster_tag }}"]
    backup_name: "{{item.0}}-coord-{{item.1}}"
    postgres_port: "20002"
    backup: "{{ groups['tag_role_barman'][0] }}-barman"
    ansible_os_family: "{{ hostvars[item.0].ansible_os_family }}"
    ansible_distribution_release: "{{ hostvars[item.0].ansible_distribution_release }}"
    ansible_pkg_mgr: "{{ hostvars[item.0].ansible_pkg_mgr }}"
    cluster_name: "{{ hostvars[item.0].cluster_name }}"
    role: "{{ hostvars[item.0].role }}"
    parent_inventory_hostname: "{{item.0}}"
  with_nested_dependents:
        - groups['tag_role_coordinator']
        - hostvars[item.0].ec2_tag_co_list|default([])

- name: Add datanodes to backup_nodes group
  add_host:
    name: "{{item.0}}-{{ item.1 }}"
    ansible_host: "{{ hostvars[item.0].public_ip}}"
    ip_address: "{{ hostvars[item.0].ip_address}}"
    groups: [backup_nodes, "{{ hostvars[item.0].cluster_tag }}"]
    backup_name: "{{item.0}}-datanode-{{item.1}}"
    postgres_port: "{{item.1|int+20003}}"
    backup: "{{ groups['tag_role_barman'][0] }}-barman"
    ansible_os_family: "{{ hostvars[item.0].ansible_os_family }}"
    ansible_distribution_release: "{{ hostvars[item.0].ansible_distribution_release }}"
    ansible_pkg_mgr: "{{ hostvars[item.0].ansible_pkg_mgr }}"
    cluster_name: "{{ hostvars[item.0].cluster_name }}"
    role: "{{ hostvars[item.0].role }}"
    parent_inventory_hostname: "{{item.0}}"
  with_nested_dependents:
        - groups['tag_role_datanode']
        - hostvars[item.0].ec2_tag_dn_list|default([])
