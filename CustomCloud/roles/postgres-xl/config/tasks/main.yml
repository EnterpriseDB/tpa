---

# TODO: this module temporarily holds tasks previously found in postgres-xl/pkg
# which are now shared with postgres-xl/src
# All tasks should be reviewed, improved, and moved to other more appropriate roles
# (mostly making use or adapting sys/fs)


- name: Ensure that /pgxl exists
  file:
    path: /pgxl
    state: directory
    owner: postgres
    group: postgres
    mode: 0755

# The following filesystem-level tasks should not be here at all. They
# should use sys/fs (or perhaps sys/fs can be declared as a dependency
# of this role, but 'config' isn't the right name for this role in that
# case). Note that these are somewhat instance-type-specific. Also,
# they're entirely too enthusiastic about blowing away existing
# filesystems. Also, too much hardcoded stuff.

- name: Check if /dev/xvdb needs a filesystem
  shell: lsblk --noheadings --output FSTYPE /dev/xvdb
  register: fstype

- name: Create file system on /dev/xvdb
  filesystem: fstype=ext4 dev=/dev/xvdb force=yes
  when: fstype.stdout != 'ext4'

- name: Mount /pgxl/data
  mount: name=/pgxl/data src=/dev/xvdb fstype=ext4 state=mounted

- name: Check if /dev/xvdc needs a filesystem
  shell: lsblk --noheadings --output FSTYPE /dev/xvdc
  register: fstype

- name: Create file system on /dev/xvdc
  filesystem: fstype=ext4 dev=/dev/xvdc force=yes
  when: fstype.stdout != 'ext4'

- name: Mount /pgxl/wal
  mount: name=/pgxl/wal src=/dev/xvdc fstype=ext4 state=mounted

- name: Check if /dev/xvdd needs a "swap" filesystem
  shell: lsblk --noheadings --output FSTYPE /dev/xvdd
  register: fstype

- block:
    - name: Create swap
      command: "mkswap /dev/xvdd"

    - name: Set swap
      mount: src=/dev/xvdd name=none fstype=swap dump=0 passno=0 state=present

    - name: Activate swap
      command: "swapon /dev/xvdd"
  when: fstype.stdout != 'swap'
