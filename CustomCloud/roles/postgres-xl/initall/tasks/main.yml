---

- name: Appoint control node
  set_fact: control_hostname="{{ item }}"
  when: "hostvars[item].ec2_tag_node == '1'"
  with_items: play_hosts

- name: Check if pgxc_ctl.conf exists
  stat: path=~postgres/pgxc_ctl.conf
  register: conf
  when: inventory_hostname == control_hostname

- block:
    - name: Install pgxc_ctl.conf on control node
      template:
        src: pgxc_ctl.conf.j2
        dest: ~postgres/pgxc_ctl.conf
    - name: Run pgxc_ctl init all
      shell: pgxc_ctl -c ~postgres/pgxc_ctl.conf init all
      args:
        executable: /bin/bash
      environment:
        LC_ALL: en_US.UTF-8
        PATH: /opt/pgxl/bin:/usr/local/bin:/usr/bin:/bin
  when: inventory_hostname == control_hostname and not conf.stat.exists
  sudo_user: postgres
  sudo: true
