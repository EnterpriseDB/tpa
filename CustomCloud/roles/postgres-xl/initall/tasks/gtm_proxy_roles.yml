---

# check if the implicit GTM Proxies are running on datanodes
# or not
- block:
  - name: Check if GTM Proxy exists 
    stat: path=/pgxl/data/gtm_pxy{{gpindex}}
    register: dirstat

  - name: Add GTM Proxy if it does not exist
    shell: pgxc_ctl -c ~postgres/pgxc_ctl.conf add gtm_proxy gtm_pxy{{gpindex}} {{inventory_hostname}} 20001 /pgxl/data/gtm_pxy{{gpindex}}
    args:
      executable: /bin/bash
    environment:
      LC_ALL: en_US.UTF-8
      PATH: /opt/pgxl/bin:/usr/local/bin:/usr/bin:/bin
    when: not dirstat.stat.exists
    sudo_user: postgres
    sudo: true
    delegate_to: "{{ control_hostname }}"
  when: "dtype == 'gtm-proxy' and '{{ inventory_hostname }}' == '{{ gphost }}'"
