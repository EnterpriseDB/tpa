---

- name: Appoint control node
  set_fact: control_hostname="{{ item }}"
  when: "hostvars[item].ec2_tag_node == '1'"
  with_items: play_hosts

- name: Ensure that /opt/Postgres-XL-{{pgxlversion}} exists
  file:
    path: /opt/Postgres-XL-{{pgxlversion}}
    state: directory
    owner: postgres
    group: postgres
    mode: 0755

- name: Unarchive Postgres-XL tarball onto control node
  unarchive:
    src: "{{ pgxl_tar_name }}"
    dest: /opt
    creates: "/opt/Postgres-XL-{{pgxlversion}}/bin/pgxc_ctl"
  when: inventory_hostname == control_hostname

- name: Copy /opt/Postgres-XL-{{pgxlversion}} to other nodes
  command: rsync -e 'ssh -o StrictHostKeyChecking=yes' -qa \
    "{{ hostvars[control_hostname].ec2_private_ip_address }}:/opt/Postgres-XL-{{pgxlversion}}" /opt
  args:
    creates: "/opt/Postgres-XL-{{pgxlversion}}/bin/pgxc_ctl"
  sudo_user: postgres
  sudo: yes
  when: inventory_hostname != control_hostname

- name: Link /opt/pgxl to /opt/Postgres-XL-{{pgxlversion}}
  file:
    path: /opt/pgxl
    src: "/opt/Postgres-XL-{{pgxlversion}}"
    state: link

- name: Enhance soft system limits for user postgres
  shell: echo "postgres  soft   nofile   4096" >> /etc/security/limits.conf

- name: Enhance hard system limits for user postgres
  shell: echo "postgres  hard   nofile   32768" >> /etc/security/limits.conf

- name: Ensure that /pgxl exists
  file:
    path: /pgxl
    state: directory
    owner: postgres
    group: postgres
    mode: 0755

- name: Check if /dev/xvdb needs a filesystem
  shell: lsblk --noheadings --output FSTYPE /dev/xvdb
  register: fstype

- name: Create file system on /dev/xvdb
  filesystem: fstype=ext4 dev=/dev/xvdb force=yes
  when: fstype.stdout != 'ext4'

- name: Mount /pgxl/data
  mount: name=/pgxl/data src=/dev/xvdb fstype=ext4 state=mounted

- name: Check if /dev/xvdc needs a filesystem
  shell: lsblk --noheadings --output FSTYPE /dev/xvdc
  register: fstype

- name: Create file system on /dev/xvdc
  filesystem: fstype=ext4 dev=/dev/xvdc force=yes
  when: fstype.stdout != 'ext4'

- name: Mount /pgxl/wal
  mount: name=/pgxl/wal src=/dev/xvdc fstype=ext4 state=mounted

- name: Check if /dev/xvdd needs a "swap" filesystem
  shell: lsblk --noheadings --output FSTYPE /dev/xvdd
  register: fstype

- block:
    - name: Create swap
      command: "mkswap /dev/xvdd"

    - name: Set swap
      mount: src=/dev/xvdd name=none fstype=swap dump=0 passno=0 state=present

    - name: Activate swap
      command: "swapon /dev/xvdd"
  when: fstype.stdout != 'swap'

- name: Ensure that /pgxl/data exists
  file:
    path: /pgxl/data
    state: directory
    owner: postgres
    group: postgres
    mode: 0755

- name: Ensure that /pgxl/wal exists
  file:
    path: /pgxl/wal
    state: directory
    owner: postgres
    group: postgres
    mode: 0755

