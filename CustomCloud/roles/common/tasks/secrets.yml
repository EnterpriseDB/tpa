---

# We generate random secrets using pwgen and store them in individual
# files under _vault_dir, whence they may later be loaded by the roles
# that need them, using:
#
#   - include_var: '{{ playbook_dir }}/vault/some_secret.yml'
#
# If ansible-playbook is invoked with the right --vault-password-file
# argument (or --ask-vault-pass), this will work transparently and not
# store unencrypted secrets on disk.

- name: Generate encrypted secrets
  local_action: >
    shell echo "{{ item }}: >-\n  $(pwgen -1y 32)" |
    ansible-vault encrypt --vault-password-file {{ _vault_passfile }} --output {{ item }}.yml
  args:
    chdir: "{{ _vault_dir }}"
    creates: "{{ item }}.yml"
  run_once: yes
  sudo: no
  with_items: "{{ secrets }}"
