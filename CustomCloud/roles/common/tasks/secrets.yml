---

- name: Ensure "{{ _vault_dir }}" directory exists locally
  local_action:
    module: file
    path: "{{ _vault_dir }}"
    state: directory
  run_once: yes
  sudo: no

- name: Generate the vault passphrase for this cluster
  local_action: >
    command bash -c "pwgen -1y 32 > {{ _vault_dir }}/{{ _vault_passfile }}"
  args:
    creates: "{{ _vault_dir }}/{{ _vault_passfile }}"
  run_once: yes
  sudo: no

- name: Generate encrypted {{ item }} entry
  local_action: >
    command bash -c "echo \"{{ item }}: `pwgen -1y 32`\" | ansible-vault encrypt --output {{ _vault_dir }}/{{ item }}.yml --vault-password-file {{ _vault_dir }}/{{ _vault_passfile }}"
  args:
    creates: "{{ _vault_dir }}/{{ item }}.yml"
  run_once: yes
  sudo: no
  with_items: "{{ vault_roles }}"
