---

- name: Ensure "{{ _vault_dir }}" directory exists locally
  local_action:
    module: file
    path: "{{ _vault_dir }}"
    state: directory
  run_once: yes
  sudo: no

- name: Generate the vault passphrase for this cluster
  local_action: >
    shell pwgen -1y 32 > {{ _vault_passfile }}
  args:
    chdir: "{{ _vault_dir }}"
    creates: "{{ _vault_passfile }}"
  run_once: yes
  sudo: no

- name: Generate encrypted {{ item }} entry
  local_action: >
    shell echo "{{ item }}: >-\n  $(pwgen -1y 32)" |
    ansible-vault encrypt --vault-password-file {{ _vault_passfile }} --output {{ item }}.yml
  args:
    chdir: "{{ _vault_dir }}"
    creates: "{{ item }}.yml"
  run_once: yes
  sudo: no
  with_items: "{{ vault_roles }}"
