---

# Read the version string and append it to the /etc/tpa/tpa.log file
# on the instance. If this '/etc/tpa' directory does not exist, then
# we will create it first and we always APPEND to the tpa.log file
# to preserve earlier deployment history if any

- name: Ensure that /etc/tpa directory exists
  file:
    path: /etc/tpa
    state: directory
    mode: 0755

- name: Read the TPA version string
  set_fact:
    tpa_version: "{{ lookup('file', '../../../../VERSION.md') }}" #relative to playbook_dir

- name: Read the deploy timestamp 
  set_fact:
    deploy_timestamp: "{{ lookup('pipe','date \"+%Y-%m-%d %T %Z %::z\"') }}"

- name: Append to tpa.log file
  lineinfile:
    dest: "/etc/tpa/tpa.log"
    create: yes 
    state: present
    insertafter: EOF
    line: "-------------------------------------------\nTPA {{ tpa_version }}\n{{ deploy_timestamp }}" 
