---

# Instead of running setup, we detect and set some facts ourselves. Once
# we need to support more distributions, we will need a separate play to
# run setup.

- name: Get rid of "are you sure you want to continue connecting..." ssh interactive output
  known_hosts:
    name="{{item}}"
    state=present
    key="{{ lookup('pipe', 'ssh-keyscan -t rsa {{ item }}') }}"
  with_items: "{{ play_hosts }}"
  sudo: false
  delegate_to: 127.0.0.1
  run_once: true

- name: bootstrap python 2.7
  raw: sudo apt-get update -qq && sudo apt-get install -qq python2.7

- name: Determine what distribution we're running
  shell: (test -f /etc/debian_version && echo debian) || (test -f /etc/redhat-release && echo redhat)
  register: distribution
  changed_when: False

- name: Set ansible_distribution
  set_fact:
    ansible_distribution: "{{ distribution.stdout }}"

- name: Set Linux Distribution Codename
  shell: lsb_release -cs
  register: codename
  when: ansible_distribution == 'debian'

- name: Set ansible_distribution_release
  set_fact:
    ansible_distribution_release: "{{ codename.stdout }}"
  when: ansible_distribution == 'debian'

- name: Set ansible_pkg_mgr based on ansible_distribution
  set_fact:
    ansible_pkg_mgr: "{{dict(redhat='yum', debian='apt')[ansible_distribution]}}"

- name: Determine Python version
  command: "{{ ansible_python_interpreter }} -c 'import platform; print platform.python_version()'"
  register: version
  changed_when: False

- name: Set ansible_python_version
  set_fact:
    ansible_python_version: "{{ version.stdout }}"
