---

# If ansible_distribution is not specified in the inventory, we perform
# "lightweight" distribution detection. We support Debian, RedHat, and
# Ubuntuâ€”and we aren't worried about detecting older versions of these
# platforms accurately (since we control what runs on the machines).
#
# We can't rely on there being a usable Python installed yet.

- block:
    - name: Try to run lsb_release -ics
      raw: lsb_release -ics
      sudo: false
      ignore_errors: yes
      changed_when: False
      register: lsb_release

    - name: Set ansible_distribution based on lsb_release
      set_fact:
        ansible_distribution: "{{ lsb_release.stdout_lines[0] }}"
        ansible_distribution_release: "{{ lsb_release.stdout_lines[1] }}"
      when: lsb_release|succeeded

    - block:
        - name: Look for /etc/redhat-release
          raw: test -f /etc/redhat-release && echo RedHat
          ignore_errors: yes
          changed_when: False
          register: redhat

        - name: Set ansible_distribution based on /etc/redhat-release
          set_fact:
            ansible_distribution: "{{ redhat.stdout_lines[0] }}"
          when: redhat|succeeded
      when: lsb_release|failed
  when: ansible_distribution is not defined

- name: Ensure ansible_distribution is supported
  assert:
    msg: "ansible_distribution must be set to Debian/RedHat/Ubuntu"
    that:
      - ansible_distribution is defined
      - ansible_distribution in ('Debian', 'RedHat', 'Ubuntu')

- name: Set ansible_pkg_mgr based on ansible_distribution
  set_fact:
    ansible_pkg_mgr: "{{ dict(Debian='apt', RedHat='yum', Ubuntu='apt')[ansible_distribution] }}"
  when: ansible_pkg_mgr is not defined
