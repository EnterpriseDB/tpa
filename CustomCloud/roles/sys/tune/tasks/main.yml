---

- name: Calculate total system memory size
  command: >
    awk '/^MemTotal: / {print int($2/1024)}' /proc/meminfo
  changed_when: False
  register: mem

# The following is really just:
#
# - set_fact: ansible_memtotal_mb="{{ mem.stdout }}"
#
# but we do it this way so that the fact remains an integer afterwards,
# and can be used without sprinkling |int everywhere (which one does not
# have to do with the value from the setup module).

- name: Set ansible_memtotal_mb based on memory size
  action: set_fact
  args: >
    {{ ('{"ansible_memtotal_mb": ' ~ mem.stdout ~ '}')|from_json }}
  when: not ansible_memtotal_mb

- name: Derive a value for shared_buffers_mb
  action: set_fact
  args: >
    {{
      ('{"shared_buffers_mb": ' ~
        ("%d"|format((ansible_memtotal_mb*shared_buffers_ratio)|round)) ~
       '}')|from_json
    }}
  when: not shared_buffers_mb
