---

# Given a block device name and a mountpoint, does everything required
# to make the volume available for use immediately and after subsequent
# reboots.

- name: Ensure filesystem configuration is specified
  assert:
    msg: "Please specify at least the device name and mountpoint"
    that:
      - device is defined
      - mountpoint is defined

- name: Set up encryption on {{ device }}
  include: "{{ encryption }}.yml"
  when: encryption is defined

- name: Set readahead on {{ device }} to {{ '%d' % ((readahead|int)/2048) }}MB
  shell: >
    blockdev --getra "{{ device }}" &&
    blockdev --setra "{{ readahead }}" "{{ device }}"
  register: ra
  changed_when: >
    ra|succeeded and ra.stdout != "{{ readahead }}"

# TODO: We need to make the readahead setting persistent by adding the
# above command to /etc/rc.local.

- name: Create filesystem on {{ device }}
  filesystem:
    dev: "{{ device }}"
    fstype: "{{ fstype }}"
    opts: "{{ fsopts|default(omit) }}"

- name: Mount {{ device }} under {{ mountpoint }}
  mount:
    src: "{{ device }}"
    name: "{{ mountpoint }}"
    fstype: "{{ fstype }}"
    opts: "{{ mountopts }}"
    state: mounted

# TODO: If the caller specifies an SELinux context, we should use
# semanage and restorecon to set the context on the mountpoint:
#
# $ semanage fcontext -a -t postgresql_db_t "/opt/postgresql(/.*)?"
# $ restorecon -R -v /opt/postgresql
#
# https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/SELinux_Users_and_Administrators_Guide/sect-Managing_Confined_Services-PostgreSQL-Configuration_Examples.html
