---

# Enable password-less SSH access between all nodes for a given user.

- name: Ensure {{playbook_dir}}/keys exists locally
  local_action:
    module: file
    path: "{{ playbook_dir }}/keys"
    state: directory
  run_once: yes
  sudo: no

- name: Generate ssh keypair for {{user}}
  local_action: command ssh-keygen -N "" -f id_{{user}}
  args:
    chdir: "{{ playbook_dir }}/keys"
    creates: id_{{user}}.pub
  run_once: yes
  sudo: no

# authorized_key will create .ssh if needed, and set the uid and gid
# properly based on the user's /etc/passwd entry.

- name: Install authorized_keys file
  authorized_key:
    user: "{{user}}"
    key: "{{ lookup('file', playbook_dir+'/keys/id_'+user+'.pub') }}"

- name: Install private and public key files
  action: copy
  args: "{{item}}"
  with_items:
    - mode: 0600
      src: "{{playbook_dir}}/keys/id_{{user}}"
      dest: "~{{user}}/.ssh/id_rsa"
    - mode: 0640
      src: "{{playbook_dir}}/keys/id_{{user}}.pub"
      dest: "~{{user}}/.ssh/id_rsa.pub"

- name: Set owner/group for files
  shell: chown -c --reference authorized_keys *
  args:
    chdir: "~{{user}}/.ssh"
  register: chown
  changed_when: chown.stdout != ''
