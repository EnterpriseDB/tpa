---

# Creates a keypair named id_user in playbook_dir/keys.
#
# Either the key filename or its location may be overriden by setting
# ssh_key_file and ssh_key_dir respectively.

- set_fact:
    ssh_key_dir: "{{ ssh_key_dir|default(playbook_dir+'/keys') }}"
    ssh_key_file: "{{ ssh_key_file|default('id_'+user) }}"

- name: Ensure {{ ssh_key_dir }} exists locally
  local_action:
    module: file
    path: "{{ ssh_key_dir }}"
    state: directory
  run_once: yes
  sudo: no

- name: Generate ssh keypair {{ ssh_key_file }}
  local_action: >
    command ssh-keygen -N "" -C "{{ user~'@'~cluster_name }}" -f "{{ ssh_key_file }}"
  args:
    chdir: "{{ ssh_key_dir }}"
    creates: "{{ ssh_key_file }}"
  run_once: yes
  sudo: no
