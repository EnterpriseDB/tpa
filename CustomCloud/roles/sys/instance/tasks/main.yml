---

#
# Update packages, upgrade packages and restart the instance
#

- block:
  - name: Check if there are packages to be installed/upgraded
    command: /usr/lib/update-notifier/apt-check --package-names
    register: packages

  - name: Upgrade all packages to their latest versions
    apt: update_cache=yes upgrade=dist
    when: packages.stderr != ""

  - name: Check if a reboot is required
    register: file
    stat: path=/var/run/reboot-required

  - name: Check if THP is enabled
    command: cat /sys/kernel/mm/transparent_hugepage/enabled
    register: thp

  - name: Insert/update disabling THP configuation block in /etc/rc.local
    blockinfile:
      dest: /etc/rc.local
      mode: u+x
      insertbefore: "exit 0"
      block: |
       if test -f /sys/kernel/mm/transparent_hugepage/enabled; then
         echo never > /sys/kernel/mm/transparent_hugepage/enabled
       fi
       if test -f /sys/kernel/mm/transparent_hugepage/defrag; then
         echo never > /sys/kernel/mm/transparent_hugepage/defrag
       fi
    when: (thp.stdout.find('[never]') == -1)
    
  - name: Check if explicit huge pages is enabled
    command: cat /proc/sys/vm/nr_hugepages 
    register: hugepages
    
  - name: Find the total RAM in kB 
    command: awk '/^MemTotal:/ { print $2}' /proc/meminfo 
    register: memtotal  
 
# We calculate explicit huge pages using the value of total memory
# We get the total memory and divide it by 4 to get shared_buffers
# Adding 3% of total memory to shared_buffers and dividing them by huge page size
# which gives us a value for setting huge pages number
# Size of huge pages is 2MB for x86 architectures and it might be different on other platforms 

  - name: Configure explicit huge pages
    sysctl:
      name: vm.nr_hugepages
      value: "{{ (((memtotal.stdout|int/4096) + ((memtotal.stdout|int*0.03)/1024))/2)|int|abs }}"
      state: present
      sysctl_file: /etc/sysctl.conf
      reload: yes
    when: hugepages.stdout|int == 0     
    
  - name: Reboot the instance[s]
    shell: sleep 5 && shutdown -r now "TPA updates triggered"
    async: 1
    poll: 0
    sudo: true
    ignore_errors: true
    when: (file.stat.exists == true) or (thp.stdout.find('[never]') == -1)

  - name: Wait for instance[s] to restart. This may take some time..
    local_action:
      module: wait_for
        host="{{ inventory_hostname }}"
        port=22
        delay=10
        timeout=300
    sudo: false
    when: file.stat.exists == true
  when: ansible_distribution == 'debian'
    
