---

#
# Update packages, upgrade packages and restart the instance
#

- block:
  - name: Check if there are packages to be installed/upgraded
    command: /usr/lib/update-notifier/apt-check --package-names
    register: packages

  - name: Upgrade all packages to their latest versions
    apt: update_cache=yes upgrade=dist
    when: packages.stderr != ""

  - name: Check if a reboot is required
    register: file
    stat: path=/var/run/reboot-required

#
# Reboot the instances
#

  - name: Reboot the instance[s]
    shell: sleep 5 && shutdown -r now "TPA updates triggered"
    async: 1
    poll: 0
    sudo: true
    ignore_errors: true
    when: (file.stat.exists == true) or (thp.stdout.find('[never]') == -1)

  - name: Wait for instance[s] to restart. This may take some time..
    local_action:
      module: wait_for
        host="{{ inventory_hostname }}"
        port=22
        delay=10
        timeout=300
    sudo: false
    when: file.stat.exists == true
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'
