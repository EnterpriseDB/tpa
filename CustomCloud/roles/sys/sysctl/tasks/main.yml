---

# Set any sysctl values specified by the caller, which may augment or
# override the default values defined in by this role.

- name: Set sysctl values
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.conf
    reload: yes
  with_dict: "{{ sysctl_defaults|combine(sysctl_values) }}"

# Transparent huge page support cannot be controlled by a sysctl. The
# right way to disable it is to append "transparent_hugepage=never" to
# the kernel command line (GRUB_CMDLINE_LINUX in /etc/default/grub), so
# that the kernel never creates any THPs at all; but for simplicity, we
# just turn it off after startup for now.

- name: Set transparent_hugepage/enabled in /etc/rc.local
  lineinfile:
    dest: /etc/rc.local
    mode: 0755
    line: >-
      test -f /sys/kernel/mm/transparent_hugepage/enabled &&
      echo {{ transparent_hugepage }} > /sys/kernel/mm/transparent_hugepage/enabled
    state: present
    insertbefore: "exit 0"
