---

#
# Disable transparent huge pages
#

  - name: Check if THP is enabled
    command: cat /sys/kernel/mm/transparent_hugepage/enabled
    register: thp

  - name: Insert/update disabling THP configuration block in /etc/rc.local
    blockinfile:
      dest: /etc/rc.local
      mode: u+x
      insertbefore: "exit 0"
      block: |
       if test -f /sys/kernel/mm/transparent_hugepage/enabled; then
         echo never > /sys/kernel/mm/transparent_hugepage/enabled
       fi
       if test -f /sys/kernel/mm/transparent_hugepage/defrag; then
         echo never > /sys/kernel/mm/transparent_hugepage/defrag
       fi
    when: (thp.stdout.find('[never]') == -1)

#
# Configure explicit huge pages
#
    
  - name: Check if explicit huge pages is enabled
    command: cat /proc/sys/vm/nr_hugepages 
    register: hugepages
    
  - name: Find the total RAM in kB 
    command: awk '/^MemTotal:/ { print $2}' /proc/meminfo 
    register: memtotal  
 
# We calculate explicit huge pages using the value of total memory
# We get the total memory and divide it by 4 to get shared_buffers
# Adding 3% of total memory to shared_buffers and dividing them by huge page size
# which gives us a value for setting huge pages number
# Size of huge pages is 2MB for x86 architectures and it might be different on other platforms 

  - name: Configure explicit huge pages
    sysctl:
      name: vm.nr_hugepages
      value: "{{ (((memtotal.stdout|int/4096) + ((memtotal.stdout|int*0.03)/1024))/2)|int|abs }}"
      state: present
      sysctl_file: /etc/sysctl.conf
      reload: yes
    when: hugepages.stdout|int == 0     

#
# Disable zone_reclaim_mode 
#

  - name: Check if zone_reclaim_mode is enabled
    command: cat /proc/sys/vm/zone_reclaim_mode
    register: zone_reclaim_mode

  - name: Disable zone_reclaim_mode if is enabled
    sysctl:
      name: vm.zone_reclaim_mode
      value: 0
      state: present
      sysctl_file: /etc/sysctl.conf
      reload: yes
    when: zone_reclaim_mode.stdout|int != 0
    
#
# OS write cache setup 
#

# Changes below will make dirty pages get flush once there are 4GB worth of dirty pages
# or 256MB of dirty background pages. It will also expire dirty pages after 10 seconds.

  - name: Set vm dirty bytes
    sysctl:
      name: vm.dirty_bytes
      value: 4294967296
      state: present
      sysctl_file: /etc/sysctl.conf
      reload: yes

  - name: Set vm dirty background bytes
    sysctl:
      name: vm.dirty_background_bytes
      value: 268435456
      state: present
      sysctl_file: /etc/sysctl.conf
      reload: yes

  - name: Set vm dirty ratio
    sysctl:
      name: vm.dirty_ratio
      value: 0
      state: present
      sysctl_file: /etc/sysctl.conf
      reload: yes

  - name: Set vm dirty background ratio
    sysctl:
      name: vm.dirty_background_ratio
      value: 0
      state: present
      sysctl_file: /etc/sysctl.conf
      reload: yes

  - name: Set dirty expire centisecs
    sysctl:
      name: vm.dirty_expire_centisecs
      value: 1000
      state: present
      sysctl_file: /etc/sysctl.conf
      reload: yes
