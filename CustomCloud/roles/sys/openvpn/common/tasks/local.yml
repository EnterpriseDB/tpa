---

- name: Ensure certs directory exists locally
  local_action:
    module: file
    path: "{{ _local_cert_dir }}"
    state: directory
  run_once: yes
  sudo: no

- name: Generate CA key and self-signed CA certificate
  local_action: >
    shell
    umask 077 &&
    openssl req -new -nodes -newkey rsa:4096 -x509 -out ca.crt -keyout ca.key
    -subj '/C=GB/ST=Oxford/L=Oxford/O=2ndQuadrant/OU=2ndQuadrant TPA/CN={{ cluster_name }}'
  args:
    chdir: "{{ _local_cert_dir }}"
    creates: "ca.key"
  run_once: yes
  sudo: no

- name: Generate host key and CSR for each instance
  local_action: >
    shell
    umask 077 &&
    openssl req -new -nodes -newkey rsa:4096
    -out "{{ inventory_hostname }}.csr" -keyout "{{ inventory_hostname }}.key"
    -subj '/C=GB/ST=Oxford/L=Oxford/O=2ndQuadrant/OU=2ndQuadrant TPA/CN={{ inventory_hostname }}'
  args:
    chdir: "{{ _local_cert_dir }}"
    creates: "{{ inventory_hostname }}.key"
  sudo: no

- name: Set extension type for server_exts
  set_fact:
    openssl_extensions: server_exts
  when: >
    'openvpn-server' in role
  tags: openvpn

- name: Set extension type for client_exts
  set_fact:
    openssl_extensions: client_exts
  when: >
    'openvpn-server' not in role
  tags: openvpn

- name: Copy openssl.cnf.j2 to local
  local_action: template dest="{{ _local_cert_dir }}/openssl.cnf.j2" src="openssl.cnf.j2"
  sudo: no

- name: Sign each CSR with the CA certificate
  local_action: >
    shell
    umask 077 &&
    openssl x509 -extensions "{{ openssl_extensions  }}"  -req -CA ca.crt -CAkey ca.key -CAcreateserial -in "{{ inventory_hostname }}.csr" -out "{{ inventory_hostname }}.crt" -days 3650 -sha256 -extfile openssl.cnf.j2
  args:
    chdir: "{{ _local_cert_dir }}"
    creates: "{{ inventory_hostname }}.crt"
  sudo: no

- name: Generate DH parameters
  local_action: >
    shell
    umask 077 &&
    openssl dhparam -out "dh2048.pem" 2048
  args:
    chdir: "{{ _local_cert_dir }}"
    creates: "dh2048.pem"
  run_once: yes
  sudo: no

- name: Generate TLS authentication key
  local_action: >
    shell
    umask 077 &&
    /usr/sbin/openvpn --genkey --secret "ta.key"
  args:
    chdir: "{{ _local_cert_dir }}"
    creates: "ta.key"
  run_once: yes
  sudo: no
