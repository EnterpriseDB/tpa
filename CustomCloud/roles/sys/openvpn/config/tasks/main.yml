---

- name: Ensure openvpn configuration is present
  assert:
    msg: "Please define vpn_network in CIDR format"
    that:
      - vpn_network is defined

- name: Create openvpn configuration directory
  file:
    path: "{{ vpn_dir }}"
    owner: root
    group: root
    mode: 0755
    state: directory

- block:
    - name: Create openvpn client configuration directory
      file:
        path: "{{ vpn_dir }}/ccd"
        owner: root
        group: root
        mode: 0755
        state: directory

    - name: Install main server configuration file
      template:
        src: server.conf.j2
        dest: "/etc/openvpn/{{ _vpn_name }}.conf"
        owner: root
        group: root
        mode: 0644

    # XXX We shouldn't use play_hosts here.

    - name: Install client-configuration-database files on the server
      template:
        src: ccd.j2
        dest: "{{ vpn_dir }}/ccd/{{ item }}"
        owner: root
        group: root
        mode: 0644
      with_items: "{{ play_hosts|difference(inventory_hostname) }}"
  when: >
    'openvpn-server' in role

- name: Install main client configuration file
  template:
    src: client.conf.j2
    dest: "/etc/openvpn/{{ _vpn_name }}.conf"
    owner: root
    group: root
    mode: 0644
  when: >
    not 'openvpn-server' in role and
    openvpn_server is defined and openvpn_server != ''

- name: Ensure certs directory exists locally
  local_action:
    module: file
    path: "{{ playbook_dir }}/certs"
    state: directory
  run_once: yes
  sudo: no

- include: ca.yml
- include: certs.yml

# XXX We should do this only if some part of the configuration has
# changed, but in this case it's not easy to determine.

- name: Make sure openvpn is started
  service: name="{{ dict(Debian='openvpn', RedHat='openvpn@'+cluster_name)[ansible_os_family] }}" state=started
