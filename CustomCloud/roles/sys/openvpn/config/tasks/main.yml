---

- name: Ensure openvpn configuration is present
  assert:
    that:
      - vpn_network is defined
      - vpn_netmask is defined

# XXX We could use a v2 block: to better encapsulate separate server and
# client configuration actions.

- name: Create openvpn configuration directory
  file: path=/etc/tpa/openvpn mode=0755
    owner=root group=root state=directory

- block:
    - name: Create client configuration directory
      file: path=/etc/tpa/openvpn/ccd mode=0755
        owner=root group=root state=directory

    - name: Install main server configuration file
      template: src=server.conf.j2 dest="/etc/tpa/openvpn/server.conf"
        mode=0644 owner=root group=root

    - name: Install client-configuration-database files on the server
      template: src=ccd.j2 dest="/etc/tpa/openvpn/ccd/{{ item }}" mode=0644
      with_items: "{{ play_hosts|difference(inventory_hostname) }}"
  when: >
    'openvpn-server' in role

- name: Install main client configuration file
  template: src=client.conf.j2 dest="/etc/tpa/openvpn/client.conf"
    mode=0644 owner=root group=root
  when: >
    not 'openvpn-server' in role

# XXX We should do this only if some part of the configuration has
# changed, but in this case it's not easy to determine.

- name: Make sure openvpn is started
  service: name="{{ dict(Debian='openvpn', RedHat='openvpn@'+cluster_name)[ansible_os_family] }}" state=started
