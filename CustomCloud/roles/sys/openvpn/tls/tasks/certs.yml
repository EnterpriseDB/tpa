---

- name: Ensure that /etc/tpa/openvpn exists
  file:
    path: /etc/tpa/openvpn
    state: directory
    mode: 0755
  run_once: yes

- name: Generate the host certificate
  shell: >
    umask 077 &&
    /usr/bin/openssl genrsa -out "{{ cluster_name }}-host-CA.key" 4096
  args:
    chdir: /etc/tpa/openvpn/
    creates: "{{ cluster_name }}-host-CA.key"
  run_once: yes

- name: Generate the certificate signing request
  shell: >
    umask 077 &&
    /bin/echo -e "--\nState\nCity\nOrganization\nOrganizationalUnit\nlocalhost.localdomain\nroot@localhost.localdomain\n" |
    /usr/bin/openssl req -new -key "{{ cluster_name }}-host-CA.key" -out "{{ cluster_name }}-host-CA.csr"
  args:
    chdir: /etc/tpa/openvpn/
    creates: "{{ cluster_name }}-host-CA.csr"
  run_once: yes

- name: Self sign the csr with our CA certificate
    shell: >
    umask 077 &&
    /bin/echo -e "--\nState\nCity\nOrganization\nOrganizationalUnit\nlocalhost.localdomain\nroot@localhost.localdomain\n" |
    /usr/bin/openssl x509 -req -in "{{ cluster_name }}-host-CA.csr" -CA "{{ cluster_name }}-root-CA.pem" -CAkey "{{ cluster_name }}-root-CA.key" -CAcreateserial -out "{{ cluster_name }}-host.crt" -days 3650 -sha256
  args:
    chdir: /etc/tpa/openvpn/
    creates: "{{ cluster_name }}-host.crt"
  run_once: yes

- name: Set correct ownership and mode on key/certificate files
  file:
    path: "{{ item }}"
    owner: postgres
    group: postgres
    mode: 0600
  with_items:
    - "/etc/tpa/openvpn/{{ cluster_name }}-root-CA.csr"
    - "/etc/tpa/openvpn/{{ cluster_name }}-host.crt"

