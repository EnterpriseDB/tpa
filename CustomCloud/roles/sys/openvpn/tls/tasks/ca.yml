---

- name: Generate the CA certificate
  local_action:
    module: >
    shell
    umask 077 &&
    /usr/bin/openssl genrsa -out "{{ cluster_name }}-root-CA.key" 4096
  args:
    chdir: "{{ playbook_dir }}/certs"
    creates: "{{ cluster_name }}-root-CA.key"
  run_once: yes
  sudo: no

- name: Create DH parameters
  local_action:
    module: >
    shell
    umask 077 &&
    /usr/bin/openssl dhparam -out "{{ cluster_name }}-dh4096.pem" 4096
  args:
    chdir: "{{ playbook_dir }}/certs"
    creates: "{{ cluster_name }}-dh4096.pem"
  run_once: yes
  sudo: no

- name: Create TA key
  local_action:
    module: >
    shell
    umask 077 &&
    /usr/local/sbin/openvpn --genkey --secret "{{ cluster_name }}-ta.key"
  args:
    chdir: "{{ playbook_dir }}/certs"
    creates: "{{ cluster_name }}-ta.key"
  run_once: yes
  sudo: no

- name: Self sign the CA certificate
  local_action:
    module: >
    shell
    umask 077 &&
    /bin/echo -e "--\nState\nCity\nOrganization\nOrganizationalUnit\nlocalhost.localdomain\nroot@localhost.localdomain\n" |
    /usr/bin/openssl req -x509 -new -nodes -key "{{ cluster_name }}-root-CA.key" -sha256 -days 3650 -out "{{ cluster_name }}-root-CA.pem"
  args:
    chdir: "{{ playbook_dir }}/certs"
    creates: "{{ cluster_name }}-root-CA.pem"
  run_once: yes
  sudo: no

- name: Copy the certificate from localhost to all hosts
  copy: src="{{ playbook_dir }}/certs/{{ cluster_name }}-root-CA.pem"  dest="/etc/tpa/openvpn/{{ cluster_name }}-root-CA.pem"

- name: Copy TA key from localhost to all hosts
  copy: src="{{ playbook_dir }}/certs/{{ cluster_name }}-ta.key"  dest="/etc/tpa/openvpn/{{ cluster_name }}-ta.key"
