#!/bin/bash
{#
    This template is filled in and provided to newly-launched instances
    as a user-data script to execute on first boot.
#}

exec >> /var/log/tpa-firstboot.log 2>&1

echo "$(date): start"

set -x

{#
    Install awscli if it's not available. We need it to attach/detach
    EBS volumes and to download things from S3.
#}
{% include 'user-data/awscli.j2' %}

{#
    Attach existing EBS volumes to the instance if requested.
#}
{% if item.volumes|select('has_subkey', 'volume_id')|list|count > 0 %}
{% include 'user-data/attach-volumes.j2' %}
{% endif %}

{#
    Next, create any RAID arrays that are required on this system.
#}
{% if item.volumes|select('has_subkey', 'raid_device')|list|count > 0 %}
{% include 'user-data/mdadm.j2' %}
{% endif %}

{#
    Install new SSH host keys downloaded from S3.
#}
{% include 'user-data/ssh-hostkeys.j2' %}

{#
    If requested, add an SSH public key to ~/.ssh/authorized_keys.
#}
{% if install_authorized_key|default(false) %}
{% include 'user-data/authorized-key.j2' %}
{% endif %}

{#
    Adjust sshd configuration (Port, PermitRootLogin, etc.).
#}
{% include 'user-data/sshd-config.j2' %}

{% if extra_user_data|d() %}
{{ extra_user_data }}
{% endif %}

echo "$(date): end"
