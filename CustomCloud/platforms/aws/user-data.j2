#!/bin/bash

exec >> /var/log/tpa-firstboot.log 2>&1

echo "$(date): start"

type yum &>/dev/null && yum -y install unzip curl python
type apt-get &>/dev/null && apt-get -q -y update && apt-get -q -y install unzip curl python2.7

curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o awscli-bundle.zip && \
    unzip awscli-bundle.zip -d /tmp && \
    python2.7 /tmp/awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws

for k in rsa ecdsa; do
    for p in "" .pub; do
        /usr/local/bin/aws s3api get-object \
            --bucket "{{ cluster_bucket }}" \
            --key "hostkeys/$k$p.txt" \
            /etc/ssh/ssh_host_${k}_key$p
    done
done

F=/etc/sysconfig/sshd
if [ -f $F ]; then
    LINE="AUTOCREATE_SERVER_KEYS=''"
    grep -qx "$LINE" $F || echo "$LINE" >> $F
fi

find /etc/ssh -iname ssh_host_\*_key\* '!' -iname ssh_host_rsa_key\* '!' -iname ssh_host_ecdsa_key\* -exec rm {} \;

echo "$(date): end"
