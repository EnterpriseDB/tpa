# Â© Copyright EnterpriseDB UK Limited 2015-2023 - All rights reserved.

name: Finalise Integration Test
description: Capture output data, deprovision and remove cluster

inputs:
  cluster: # id of input
    required: false
    description: "Name of the cluster directory"
    default: "cluster"
  path:
    required: false
    description: Working directory
    default: .

runs:
  using: "composite"

  steps:

    - name: Start teardown output group
      run: echo "::group::Teardown"
      shell: bash
      if: always()

    - name: Archive the cluster logs
      run: ./bin/tpaexec archive-logs "${{ inputs.path }}/${{ inputs.cluster }}" -vv &>/tmp/archive-logs
      shell: bash
      if: always()

    - name: Display archive-logs output on failure only
      run: cat /tmp/archive-logs
      shell: bash
      if: failure()

    - name: Archive the cluster directory
      run: |
        tar cvzf "${{ inputs.path }}/cluster-${{ inputs.cluster }}.tar.gz" \
          --exclude="local-repo" "${{ inputs.path }}/${{ inputs.cluster }}"
      shell: bash
      if: always()

    - name: Save cluster artifacts before deletion
      uses: actions/upload-artifact@v3
      with:
        name: cluster-${{ github.run_number }}-${{ github.run_attempt }}
        path: "${{ inputs.path }}/cluster-*.tar.gz"
      if: always()

    - name: Deprovision the cluster
      run: ./bin/tpaexec deprovision "${{ inputs.path }}/${{ inputs.cluster }}" -vv &>/tmp/deprovision
      shell: bash {0}
      if: always()

    - name: Display deprovision output on failure only
      run: cat /tmp/deprovision
      shell: bash
      if: failure()

    - name: Remove cluster directory
      run: rm -rf "${{ inputs.path }}/${{ inputs.cluster }}"
      shell: bash
      if: always()

    - name: End teardown output group
      run: echo "::endgroup::"
      shell: bash
      if: always()

outputs: { }
