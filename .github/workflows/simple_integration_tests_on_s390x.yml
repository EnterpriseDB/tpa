# Â© Copyright EnterpriseDB UK Limited 2015-2025 - All rights reserved.

name: Integration Tests on s390x architecture

on:
  pull_request:
    types:
      - review_requested
    branches:
      - main
  workflow_dispatch:

env:
  EDB_REPO_CREDENTIALS: ${{ secrets.EDB_REPO_CREDENTIALS }}
  EDB_REPO_CREDENTIALS_FILE: /tmp/edb_repo.conf
  EDB_SUBSCRIPTION_TOKEN: ${{ secrets.CLOUDSMITH_READ_ALL }}
  FOUNDATION_TUNNEL_LOGIN: ${{ secrets.FOUNDATION_TUNNEL_LOGIN }}
  FOUNDATION_VER: ${{ vars.FOUNDATION_PACKAGING_VERSION }}
  GITHUB_TOKEN: ${{ secrets.GH_SLONIK }}
  SLES_REG_TOKEN: ${{ secrets.SLES_REG_TOKEN }}
  TPA_2Q_SUBSCRIPTION_TOKEN: ${{ secrets.TPA_2Q_SUBSCRIPTION_TOKEN }}

jobs:

  load-matrix:
    name: Load Matrix
    runs-on: ubuntu-24.04
    outputs:
      json: ${{ steps.load-yaml.outputs.json }}
    steps:
    - uses: actions/checkout@v5
      with:
        token: ${{ env.GITHUB_TOKEN }}
    - uses: ./.github/actions/load-yaml
      id: load-yaml
      with:
        file: .github/config/matrix.yml
        key: s390x

  integration-test:
    name: Integration test
    needs: load-matrix
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.load-matrix.outputs.json) }}
      max-parallel: 3
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout source repository
      id: checkout-source
      uses: actions/checkout@v5
      with:
        repository: EnterpriseDB/tpa-internal
        token: ${{ env.GITHUB_TOKEN }}

    - uses: ./.github/actions/integration-test
      with:
        cluster: ${{ matrix.tpa_architecture }}-${{ matrix.tpa_postgres_flavour }}-${{ matrix.tpa_postgres_version }}-${{ matrix.tpa_os_image }}
        cpu_architecture: s390x
        source_directory: ${{ github.workspace }}
        tpa_architecture: ${{ matrix.tpa_architecture }}
        tpa_failover_manager: ${{ matrix.tpa_failover_manager }}
        tpa_os_image: "tpa/${{ matrix.tpa_os_image }}"
        tpa_package_cache: "false"
        tpa_postgres_flavour: ${{ matrix.tpa_postgres_flavour }}
        tpa_postgres_version: ${{ matrix.tpa_postgres_version }}
