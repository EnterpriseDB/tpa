# Â© Copyright EnterpriseDB UK Limited 2015-2024 - All rights reserved.

name: Simple Integration Tests

on:
  push:
    branches-ignore:
      - main
      - 'rc/**'
  pull_request:
    types:
      - review_requested
    branches:
      - main
  pull_request_review:
    types:
      - submitted
  workflow_dispatch:
    inputs:
      ref:
        default: "main"
        description: "Specific TPA branch to test against"
        required: true
  

env:
  LANG: "C.UTF-8"
  TPA_2Q_SUBSCRIPTION_TOKEN: ${{ secrets.TPA_2Q_SUBSCRIPTION_TOKEN }}
  EDB_REPO_CREDENTIALS: ${{ secrets.EDB_REPO_CREDENTIALS }}
  EDB_REPO_CREDENTIALS_FILE: /tmp/edb_repo.conf
  EDB_SUBSCRIPTION_TOKEN: ${{ secrets.CLOUDSMITH_READ_ALL }}
  SLES_REG_TOKEN: ${{ secrets.SLES_REG_TOKEN }}
  ANSIBLE_SKIP_TAGS: pgbench
  PYTHONWARNINGS: once

jobs:

  load-matrix:
    name: Load Matrix
    runs-on: ubuntu-20.04
    outputs:
      json: ${{ steps.load-yaml.outputs.json }}
    steps:
    - uses: actions/checkout@v3

    - uses: ./.github/actions/load-yaml
      id: load-yaml
      with:
        file: .github/config/matrix.yml
        key: simple

  integration-test:
    # In addition to the event triggers above, this job only runs when any of these conditions are met:
    #  * a PR review is requested from the tpaexec-dev-team
    #  * a PR review is marked as approved
    #  * a manual run is executed
    if: >
      (github.event.requested_team && github.event.requested_team.name == 'tpaexec-dev-team')
      || (github.event.review
          && github.event.review.state == 'approved'
          && startsWith(github.event.pull_request.base.ref, 'main'))
      || github.event_name == 'workflow_dispatch'
    # env not supported here
    # || env.ACT
    name: Integration test
    needs: load-matrix
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.load-matrix.outputs.json) }}
    runs-on: ubuntu-20.04

    steps:
    - uses: actions/checkout@v3

    - name: Checkout source repository
      id: checkout-source
      uses: actions/checkout@v3
      with:
        repository: EnterpriseDB/tpa-internal
        ref: ${{ github.event.inputs.ref }}
        path: source
        token: ${{secrets.GH_SLONIK}}

    - uses: ./.github/actions/integration-test
      with:
        source_directory: ${{ github.workspace }}/source
        cluster: ${{ matrix.tpa_architecture }}-${{ matrix.tpa_postgres_flavour }}
        tpa_architecture: ${{ matrix.tpa_architecture }}
        tpa_postgres_flavour: ${{ matrix.tpa_postgres_flavour }}
        tpa_postgres_version: ${{ matrix.tpa_postgres_version }}
        tpa_failover_manager: ${{ matrix.tpa_failover_manager }}
