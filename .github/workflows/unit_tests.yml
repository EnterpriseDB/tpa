# Â© Copyright EnterpriseDB UK Limited 2015-2024 - All rights reserved.

name: Unit Tests

on:
  workflow_dispatch:
  pull_request:
    types:
      - review_requested
    branches:
      - main
  pull_request_review:
    types:
      - submitted
env:
  CLOUDSMITH_TOKEN: ${{ secrets.CLOUDSMITH_READ_ALL }}
  LANG: "C.UTF-8"
  TPA_2Q_SUBSCRIPTION_TOKEN: ${{ secrets.TPA_2Q_SUBSCRIPTION_TOKEN }}
  EDB_REPO_CREDENTIALS: ${{ secrets.EDB_REPO_CREDENTIALS }}
  EDB_REPO_CREDENTIALS_FILE: /tmp/edb_repo.conf

jobs:

  unit-test:
    name: Unit Test
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout source repository
      id: checkout-source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{secrets.GH_SLONIK}}

    - uses: ./.github/actions/install-requirements

    - name: Install tox
      run: |
       /usr/libexec/edb-python39/bin/python3 -m venv /tmp/unit_test;
       /tmp/unit_test/bin/pip install tox;

    - name: Run tests with tox
      working-directory: ${{ github.workspace }}
      run: |
        TOX_PARALLEL_NO_SPINNER=1 /tmp/unit_test/bin/tox -e py39-test,dep -p auto
