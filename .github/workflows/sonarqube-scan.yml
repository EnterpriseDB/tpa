name: Foundation-Security/SonarQube Scan

on:
  push:
    tags:
      - '**'
  pull_request:
  workflow_dispatch:

jobs:
 SonarQube:
    name: SonarQube Scan Job
    runs-on: ubuntu-20.04
    steps:
      - name: Trigger Workflow
        uses: actions/github-script@v6
        env:
          REPOSITORY: ${{ github.repository }}
          REF: ${{ github.ref }}
          PULL_REQUEST_KEY: '${{github.event.number}}'
          PULL_REQUEST_BRANCH: '${{github.head_ref}}'
          PULL_REQUEST_BASE_BRANCH: '${{github.base_ref}}'
        with:
          github-token: ${{ secrets.TPAEXEC_CI }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: 'EnterpriseDB',
              repo: 'tpaexec-ci',
              workflow_id: 'sonarqube-scan.yml',
              ref: 'master',
              inputs: {
                repository: process.env.REPOSITORY,
                ref: process.env.REF,
                pr_key: process.env.PULL_REQUEST_KEY,
                pr_branch_ref: process.env.PULL_REQUEST_BRANCH,
                pr_base_branch_ref: process.env.PULL_REQUEST_BASE_BRANCH
              },
            })
