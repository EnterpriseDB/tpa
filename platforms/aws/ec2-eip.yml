---

- name: Associate elastic IPs with instances
  ec2_eip:
    state: present
    region: "{{ item.1.tagged_instances[0].region }}"
    device_id: "{{ item.1.tagged_instances[0].id }}"
    reuse_existing_ip_allowed: true
    in_vpc: true
  when:
    item.0.assign_elastic_ip is defined
    and item.0.assign_elastic_ip
  with_together:
    - "{{ instances }}"
    - "{{ ec2_jobs.results }}"
  loop_control:
    label: >-
      {{ item.1.tagged_instances[0].region }}:{{ item.1.tagged_instances[0].id }}
  register: ec2_eips
