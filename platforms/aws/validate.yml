- include: ../common/validate.yml

- name: Ensure cluster_tags is correctly configured
  assert:
    msg: "Please define cluster_tags (a hash, including Owner) in {{cluster}}/config.yml"
    that:
      - cluster_tags is defined
      - cluster_tags is mapping
      - cluster_tags['Owner'] is defined
      - cluster_tags['Owner'] != ''

- name: Ensure instances is correctly configured
  assert:
    msg: "Please define instances (an array of hashes, one per instance) in {{cluster}}/config.yml"
    that:
      - instances is defined
      - instances is sequence and instances is not string and instances is not mapping
      - instances | length > 0

- name: Ensure that the cluster name is set as a tag
  set_fact:
    cluster_tags: "{{ dict(Name=cluster_name)|combine(cluster_tags) }}"

- name: Derive EC2 group name for the cluster
  set_fact:
    cluster_tag: "{{ 'tag_Name_' + cluster_tags['Name'] }}"

- name: Derive list of unique regions from instances
  set_fact:
    regions: "{{ instances|map(attribute='region')|unique|list }}"
