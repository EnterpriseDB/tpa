- name: Require cluster directory to be specified
  assert:
    msg: "Please rerun with «-e cluster=./clusters/name»"
    that:
      - cluster is defined and cluster != ''

- name: Derive full path to cluster directory
  set_fact: cluster_dir="{{ cluster|realpath }}"

- name: Load cluster configuration file
  include_vars: "{{ cluster_dir }}/config.yml"

- name: Ensure cluster_name is correctly configured
  assert:
    msg: "Please define cluster_name (a non-empty string) in {{cluster}}/config.yml"
    that:
      - cluster_name is defined
      - cluster_name != ''

- name: Ensure cluster_tags is correctly configured
  assert:
    msg: "Please define cluster_tags (a hash, including Owner) in {{cluster}}/config.yml"
    that:
      - cluster_tags is defined
      - cluster_tags is mapping
      - cluster_tags['Owner'] is defined
      - cluster_tags['Owner'] != ''

- name: Ensure instances is correctly configured
  assert:
    msg: "Please define instances (an array of hashes, one per instance) in {{cluster}}/config.yml"
    that:
      - instances is defined
      - instances is sequence and instances is not string and instances is not mapping
      - instances | length > 0

- name: Derive EC2 group name for cluster
  set_fact:
    cluster_tag: "{{ 'tag_Name_' + cluster_name }}"

- name: Ensure that the cluster name is set as a tag
  set_fact:
    cluster_tags: "{{ dict(Name=cluster_name)|combine(cluster_tags) }}"

- name: Derive list of unique regions from instances
  set_fact:
    regions: "{{ instances|map(attribute='region')|unique|list }}"
