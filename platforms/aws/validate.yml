- name: Require cluster directory to be specified
  assert:
    msg: "Please rerun with «-e cluster=./clusters/name»"
    that:
      - cluster is defined and cluster != ''

- name: Derive full path to cluster directory
  set_fact: cluster_dir="{{ cluster|realpath }}"

- name: Load cluster configuration file
  include_vars: "{{ cluster_dir }}/config.yml"

- name: Ensure cluster configuration is complete
  assert:
    msg: "Please define cluster configuration in {{cluster}}/config.yml"
    that:
      - cluster_name is defined
      - cluster_name != ''
      - cluster_tags is defined
      - cluster_tags is mapping
      - cluster_tags['Owner'] is defined
      - cluster_tags['Owner'] != ''
      - instances is defined
      - instances is sequence and instances is not string and instances is not mapping
      - instances | length > 0

- name: Derive EC2 group name for cluster
  set_fact:
    cluster_tag: "{{ 'tag_Name_' + cluster_name }}"

- name: Derive list of unique regions from instances
  set_fact:
    regions: "{{ instances|map(attribute='region')|unique|list }}"
