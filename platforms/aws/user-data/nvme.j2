{# Â© Copyright EnterpriseDB UK Limited 2015-2022 - All rights reserved. #}

cat > /usr/local/bin/nvme-ebs-name <<'SCRIPT'
#!/bin/bash
PATH="${PATH}:/usr/sbin"
nvme id-ctrl --raw-binary "$1"|cut -c3073-3104|sed -e 's,^/dev/,,' -e 's/ *$//'
SCRIPT

cat > /usr/local/bin/nvme-is-name <<'SCRIPT'
#!/bin/bash
PATH="${PATH}:/usr/sbin"
nvme list|awk '/Amazon EC2 NVMe Instance Storage/ {print $1}'|grep -nx "$1"|sed 's/:.*//'|tr '[1-4]' '[b-e]'|sed 's/^/xvd/'
SCRIPT

chmod +x /usr/local/bin/nvme-{ebs,is}-name

cat > /etc/udev/rules.d/10-aws-nvme.rules <<'UDEV'
SUBSYSTEM=="block", KERNEL=="nvme[0-9]*n1", ATTRS{model}=="Amazon Elastic Block Store              ", PROGRAM="/usr/local/bin/nvme-ebs-name /dev/%k", SYMLINK+="%c{1+}"
SUBSYSTEM=="block", KERNEL=="nvme[0-9]*n1", ATTRS{model}=="Amazon EC2 NVMe Instance Storage        ", PROGRAM="/usr/local/bin/nvme-is-name /dev/%k", SYMLINK+="%c{1+}"
UDEV

udevadm control -R && udevadm trigger
