{#
    If mdadm is not available, install it.
#}

{% if not image['name'].startswith('TPA-') %}
if ! command -v mdadm &>/dev/null; then
{% include 'user-data/os/'+OS+'/mdadm.j2' %}
; fi
{% endif %}

udevadm control --stop-exec-queue
{% for md, units in item.volumes|select('has_subkey','raid_device')|groupby('raid_device') %}
test -b {{ md }} \
  || mdadm --assemble --verbose {{ md }} {{ units|map(attribute='device_name')|join(" ") }} \
  || mdadm --create --verbose {{ md }} --level={{ units[0].raid_level|default(0) }} --raid-devices={{ units|count }} {{ units|map(attribute='device_name')|join(" ") }} \
  || echo "Couldn't assemble or create {{ md }}" > /var/log/tpa-firstboot-failures.log
{% endfor %}
udevadm control --start-exec-queue

M=/etc/mdadm
test -d $M || M=/etc
mdadm --detail --scan >> $M/mdadm.conf
