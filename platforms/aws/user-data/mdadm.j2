{#
    If mdadm is not available, install it.
#}

{% if not image['name'].startswith('TPA-') %}
test -x /sbin/mdadm || (
{%   if 'RHEL' in image['name'] %}
{%     include 'user-data/os/RedHat/mdadm.j2' %}
{%   elif 'debian' in image['name'].lower() %}
{%     include 'user-data/os/Debian/mdadm.j2' %}
{%   elif 'ubuntu' in image['name'].lower() %}
{%     include 'user-data/os/Ubuntu/mdadm.j2' %}
{%   endif %}
)
{% endif %}

udevadm control --stop-exec-queue
{% for md, units in item.volumes|select('has_subkey','raid_device')|groupby('raid_device') %}
test -b {{ md }} || mdadm --create --verbose {{ md }} --level={{ units[0].raid_level|default(0) }} --raid-devices={{ units|count }} {{ units|map(attribute='device_name')|join(" ") }}
{% endfor %}
udevadm control --start-exec-queue
