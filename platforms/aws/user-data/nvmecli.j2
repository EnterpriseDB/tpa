{# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com> #}
{#
    If nvme-cli is not available, install it.
#}

if ! command -v nvme &>/dev/null; then
{% include 'user-data/os/'+OS+'/nvmecli.j2' %}
; fi

cat > /usr/local/bin/ebs-nvme-mapping <<'SCRIPT'
#!/bin/bash
#
# Copyright (c) 2018 Omachonu Ogali
# MIT License:
# https://github.com/oogali/ebs-automatic-nvme-mapping/blob/master/LICENSE

PATH="${PATH}:/usr/sbin"

for blkdev in $( nvme list | awk '/^\/dev/ { print $1 }' ) ; do
  d=$(nvme id-ctrl --raw-binary "${blkdev}" | cut -c3073-3104 | tr -s ' ' | sed 's/ $//g')
  if [[ $d && ( $d == /dev/* || $d == xvd? || $d == sd? ) ]]; then
    if [[ "$d" != /dev/* ]]; then
      d=/dev/$d
    fi
    ( test -b $blkdev && test -L $d ) || ln -s $blkdev $d
  fi
done
SCRIPT
chmod +x /usr/local/bin/ebs-nvme-mapping

cat > /etc/udev/rules.d/999-aws-ebs-nvme.rules <<'UDEV'
ACTION=="add", SUBSYSTEM=="block", KERNEL=="nvme[1-26]n1", ATTRS{model}=="Amazon Elastic Block Store              ", RUN+="/usr/local/bin/ebs-nvme-mapping"
UDEV

/bin/bash -x /usr/local/bin/ebs-nvme-mapping
