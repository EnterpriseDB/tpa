---

# Decommission an already-provisioned AWS cluster:
#
#     ansible-playbook -i inventory/ec2.py platforms/aws/deprovision.yml \
#         --extra-vars @config/clustername-aws.yml
#
# XXX Doesn't delete elastic IPs or extra provisioned volumes.

- name: Decommission EC2 cluster
  hosts: tag_Name_{{ cluster_name }}
  tasks:
    - name: Ensure cluster configuration is present
      assert:
        msg: "Please rerun with «--extra-vars @clustername-aws.yml»"
        that:
          - cluster_name is defined and cluster_name != ''
          - instances | length > 0
      tags: validate
      run_once: true
      delegate_to: localhost

    - name: Discover EC2 instance facts
      ec2_facts:
      remote_user: admin

    - name: Terminate EC2 instances
      ec2:
        state: absent
        instance_id: "{{ ansible_ec2_instance_id }}"
        region: "{{ ansible_ec2_placement_region }}"
        wait: yes
      delegate_to: localhost

    - name: Terminate VPCs
      ec2_vpc:
        state: absent
        region: "{{ item.region }}"
        cidr_block: "{{ item.subnet }}"
        resource_tags: "{{ cluster_tags }}"
        wait: yes
      with_items: instances
      delegate_to: localhost
      run_once: true

    - name: Remove keypair in each region
      ec2_key:
        state: absent
        name: "{{ ec2_key_name }}"
        region: "{{ item.region }}"
        wait: yes
      with_items: instances
      delegate_to: localhost
      run_once: true
      tags: keys
