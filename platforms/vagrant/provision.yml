---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

- name: Set instance variables and IP
  set_fact:
    instance_vars: "{{
      instance_vars|default([])|union([
        addresses|combine({
          'Name': item.Name,
          'node': item.node,
          'image': item.image,
          'memory': item|try_subkey('memory'),
          'role': item|try_subkey('role', []),
          'backup': item|try_subkey('backup'),
          'upstream': item|try_subkey('upstream'),
          'volumes': item|try_subkey('volumes', []),
          'vars': addresses|combine(exports)|combine(item.vars),
          'platform': 'vagrant',
        })
      ])
    }}"
  with_items:
    "{{ vagrant_instances }}"
  loop_control:
    label: >-
      {{ item.Name }}
  vars:
    addresses: "{{ item|ip_addresses }}"
    exports: "{{ item|export_as_vars }}"

- name: Write Vagrantfile and firstboot.sh
  template:
    src: "{{ item }}.j2"
    dest: "{{ cluster_dir }}/{{ item }}"
  with_items:
    - Vagrantfile
    - firstboot.sh
