---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

- assert:
    msg: "Ansible 2.6.x is required"
    that:
      - ansible_version.major == 2
      - ansible_version.minor == 6
  tags: prereqs

- import_tasks: validate-compat.yml

- name: Set default empty locations and cluster_vars
  set_fact:
    locations: "{{ locations|default([]) }}"
    cluster_vars: "{{ cluster_vars|default({}) }}"

- name: Ensure cluster_name is specified
  assert:
    msg: "Please define cluster_name in {{ config_file }}"
    that:
      - cluster_name is defined
      - cluster_name != ''

- name: Ensure given cluster_name is valid
  assert:
    msg: "Invalid cluster_name='{{ cluster_name }}' defined in {{ config_file }} (may contain only letters, numbers, underscores, minus)"
    that:
      - cluster_name|match('^[_a-zA-Z0-9-]+$')

- name: Set default cluster_tags (including Owner)
  set_fact:
    cluster_tags: "{{ default_tags|combine(cluster_tags|default({})) }}"
  vars:
    default_tags:
      Owner: >-
        {{ Owner|default(lookup('env', 'USER')) or lookup('pipe', 'id -u -n || true') }}

# It is not currently meaningful to set cluster_tags['Name'] to anything
# other than cluster_name. We only use the latter value, so it will only
# lead to confusion to allow the former to be set.

- name: Ensure that the cluster_name is set as a tag
  set_fact:
    cluster_tags: "{{ cluster_tags|combine(dict(Name=cluster_name)) }}"
    cluster_tag: "{{ cluster_tag|default('tag_Cluster_' + cluster_name) }}"

- name: Ensure that every location specifies a unique name
  assert:
    msg: "Please set a unique 'Name' for every location"
    that:
      - locations|selectattr('Name','defined')|map(attribute='Name')|unique|list|count == locations|count

- name: Ensure instances is correctly configured
  assert:
    msg: "Please define instances (an array of hashes, one per instance) in {{ config_file }}"
    that:
      - instances is defined
      - instances is sequence and instances is not string and instances is not mapping
      - instances is not empty

- name: Set defaults for instance definitions
  set_fact:
    instances: "{{
      instances|set_instance_defaults(cluster_name,
        compat_defaults|combine(instance_defaults|default({}), recursive=True),
        locations
      )
    }}"

- name: Ensure that every instance specifies a node id and name
  assert:
    msg: "Please set 'node' and 'Name' on every instance"
    that:
      - instances|selectattr('node','defined')|list|count == instances|count
      - instances|selectattr('Name','defined')|list|count == instances|count
