
- name: Check for .git within the cluster directory
  command:
    cmd: test -d .git
  args:
    chdir: "{{ cluster_dir }}"
  register: is_git_repository
  ignore_errors: yes

- name: Ensure we have local and remote repositories for Tower
  block:
  - name: Create a git repository if necessary
    block:
    - command:
        cmd: git init
      args:
        chdir: "{{ cluster_dir }}"
    - command:
        cmd: git checkout -b {{ cluster_name }}
      args:
        chdir: "{{ cluster_dir }}"
    when: is_git_repository.rc != 0

  - name: Check for an existing tower remote repository
    command:
      cmd: git remote get-url tower
    args:
      chdir: "{{ cluster_dir }}"
    register: existing_tower_remote_repository
    ignore_errors: yes

  - name: Warn if remote repositories clash
    assert:
      that: ansible_tower.git_repository == existing_tower_remote_repository.stdout
      fail_msg: "Configured remote repository {{ ansible_tower.git_repository }} does not match {{ existing_tower_remote_repository.stdout }}"
    when: ansible_tower.git_repository is defined
      and existing_tower_remote_repository.rc == 0

  - name: Add remote git repository
    command:
      cmd: git remote add tower {{ ansible_tower.git_repository }}
    args:
      chdir: "{{ cluster_dir }}"
    when: ansible_tower.git_repository is defined and existing_tower_remote_repository.rc != 0

  when: ansible_tower

- set_fact:
    git_inventory_files:
      - 'config.yml'
      - 'ansible.cfg'
      - 'deploy.yml'
      - 'commands/'
      - 'inventory/'
      - 'vault/'

- name: Add and commit files to git
  block:
  - name: Add inventory files to git
    command:
      cmd: git add --ignore-errors {{ item }}
    with_items: "{{ git_inventory_files }}"
    args:
      chdir: "{{ cluster_dir }}"
    register: added_files
    ignore_errors: yes

  - name: Check if commit is required
    shell:
      cmd: git status --porcelain -uno | egrep '^(A| M)'
    args:
      chdir: "{{ cluster_dir }}"
    register: commit_required
    ignore_errors: yes

  - name: Commit inventory
    command:
      cmd: git commit -m "Inventory files for cluster {{ cluster_name }}"
    args:
      chdir: "{{ cluster_dir }}"
    when: commit_required.stdout != ""
  when: ansible_tower or is_git_repository.rc == 0

- name: Push inventory to tower
  command:
    cmd: git push tower {{ cluster_name }}
  args:
    chdir: "{{ cluster_dir }}"
  when: ansible_tower
    and ansible_tower.git_repository is defined
    and (commit_required.stdout != "" or existing_tower_remote_repository.rc != 0)
