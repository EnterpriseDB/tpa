---

# We expect 'cluster' to point to a directory in which we can find
# config.yml (or whatever 'config' is set to). If we are invoked through
# tpaexec provision, we can count on cluster being set, but we check
# anyway.

- name: Require cluster directory to be specified
  assert:
    msg: "No cluster directory specified; please rerun with «-e cluster=/path/to/cluster»"
    that:
      - cluster is defined and cluster != ''

- name: Set tpa_dir
  set_fact:
    tpa_dir: "{{
      lookup('env', 'TPA_DIR') or (playbook_dir|regex_replace('/platforms/.*', ''))
    }}"
  tags: always

- name: Set full path to cluster_dir and config_file
  set_fact:
    cluster_dir: "{{ dir }}"
    config_file: "{{ dir }}/{{ file }}"
  vars:
    dir: >-
      {{ cluster|realpath }}
    file: >-
      {{ config|default('config.yml') }}

- name: Load cluster configuration file
  include_vars: "{{ config_file }}"
