---

# This playbook provisions three EC2 instances in separate regions (and
# therefore with separate VPCs, security groups, and access keys) with
# elastic IPs and an extra EBS volume each.
#
# The image ids below are the "debian-wheezy-amd64-hvm-2015-01-28-ebs"
# community AMI in each region.
#
# The appropriate AWS credentials must be supplied separately, e.g. in
# ~/.boto or in the environment.

- hosts: localhost
  connection: local
  gather_facts: no
  vars:
    cluster_name: "X2"
    cluster_tags:
      Cap: One
    key_file: "id_{{ cluster_name | lower }}"
    key_name: "2Q_{{ cluster_name | lower }}"
    instances:
      - type: i2.xlarge
        region: us-east-1
        image: ami-e0efab88
        subnet: 10.1.0.0/24
        ip: 10.1.0.1
        tags:
          db: primary
      - type: t2.medium
        region: us-west-2
        image: ami-431a4273
        subnet: 10.1.1.0/24
        ip: 10.1.1.1
        tags:
          db: standby
      - type: t2.medium
        region: eu-west-1
        image: ami-61e56916
        subnet: 10.1.2.0/24
        ip: 10.1.2.1
        tags:
          db: standby

  tasks:

    # Set up a VPC in each region with a single public subnet and an
    # internet gateway. A VPC is an isolated network zone comprising
    # multiple subnets, gateways, etc.

    - name: Set up VPCs
      ec2_vpc:
        state: present
        region: "{{ item.region }}"
        cidr_block: "{{ item.subnet }}"
        resource_tags: "{{ cluster_tags }}"
        internet_gateway: yes
        subnets:
          - cidr: "{{ item.subnet }}"
            resource_tags:
              name: "{{ cluster_name }}/{{ item.region }}"
        route_tables:
          - subnets:
              - "{{ item.subnet }}"
            routes:
              - dest: 0.0.0.0/0
                gw: igw
        wait: yes
      with_items: instances
      register: vpcs
      tags: vpcs

    # Set up a security group in each VPC. A security group is a set of
    # firewall rules. We explicitly allow certain incoming traffic; by
    # default, there is an egress rule that allows everything.

    - name: Set up security groups
      ec2_group:
        state: present
        vpc_id: "{{ item.vpc.id }}"
        region: "{{ item.vpc.region }}"
        name: "{{ cluster_name }}/{{ item.vpc.region }}"
        description: "Security group for {{ cluster_name }} in {{ item.vpc.region }}"
        rules:
          - proto: tcp
            from_port: 22
            to_port: 22
            cidr_ip: 0.0.0.0/0
          - proto: tcp
            from_port: 80
            to_port: 80
            cidr_ip: 0.0.0.0/0
          - proto: tcp
            from_port: 443
            to_port: 443
            cidr_ip: 0.0.0.0/0
          - proto: tcp
            from_port: 5432
            to_port: 5432
            cidr_ip: 0.0.0.0/0
          - proto: udp
            from_port: 1194
            to_port: 1194
            cidr_ip: 0.0.0.0/0
      with_items: vpcs.results
      register: security_groups
      tags: groups

    # Create an SSH keypair and make sure the public key is stored in
    # each region. This key is used to initially provide SSH access to
    # the EC2 instances we set up next.

    - name: Create a new keypair
      command: ssh-keygen -P "" -f "{{ key_file }}" -C 2ndQuadrant
        creates="{{ key_file }}"
      tags: keys
    - name: Set up keypair in each region
      ec2_key:
        state: present
        name: "{{ key_name }}"
        key_material: "{{ lookup('file', key_file + '.pub') }}"
        region: "{{ item.region }}"
        wait: yes
      with_items: instances
      tags: keys

    # Create the EC2 instances using the VPC subnets and security groups
    # and access key we configured above.
    #
    # We also attach an extra EBS volume to the instance (this could be
    # moved to the per-instance configuration above, but right now each
    # instance needs the same thing).

    - name: Set up EC2 instances
      ec2:
        exact_count: 1
        count_tag: "{{ cluster_tags }}"
        image: "{{ item.0.image }}"
        region: "{{ item.0.region }}"
        group_id: "{{ item.2.group_id }}"
        instance_type: "{{ item.0.type }}"
        vpc_subnet_id: "{{ item.1.subnets[0].id }}"
        instance_tags: "{{ cluster_tags | merge(item.0.tags) }}"
        key_name: "{{ key_name }}"
        assign_public_ip: yes
        volumes:
          - device_name: /dev/xvdb
            volume_type: standard
            volume_size: 10
        wait: yes
      with_together:
        - instances
        - vpcs.results
        - security_groups.results
      register: ec2_instances

    # Associate an elastic IP with each instance.

    - name: Associate elastic IPs
      ec2_eip:
        state: present
        region: "{{ item.instances[0].region }}"
        instance_id: "{{ item.instances[0].id }}"
        reuse_existing_ip_allowed: true
      with_items: ec2_instances.results
      when: ec2_instances.changed
      register: eips
