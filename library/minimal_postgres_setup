#!/bin/bash
# Â© Copyright EnterpriseDB UK Limited 2015-2022 - All rights reserved.

source "$1"

pgdata=${pgdata:-/opt/postgres/data}
pgdata_initialised=false
postgres_running=false

VERSION=$pgdata/PG_VERSION
if [[ -f $VERSION ]]; then
    pgdata_initialised=true
    pgdata_version=$(cat "$VERSION")
    pgdata_user=$(stat -c %U "$VERSION")
    pgdata_wal_dir=$(readlink -f "$pgdata/pg_wal")
    pidfile=$pgdata/postmaster.pid
    if [[ -f $pidfile && -d /proc/$(head -1 "$pidfile") ]]; then
        postgres_running=true
    fi
fi

if [[ -f /etc/harp/config.yml ]]; then
    harp_consensus_protocol=$(awk -F '"' '/driver: "(.*)"/{print($2)}' /etc/harp/config.yml)
fi

grep -Ev '": "*,*$' <<RESULT
{
    "changed": false,
    "ansible_facts": {
        "pgdata_wal_dir": "$pgdata_wal_dir",
        "pgdata_user": "$pgdata_user",
        "pgdata_version": $pgdata_version,
        "pgdata_initialised": $pgdata_initialised,
        "postgres_running": $postgres_running,
        "harp_consensus_protocol": "$harp_consensus_protocol",
        "pgdata": "$pgdata"
    }
}
RESULT
