#!/bin/bash
# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>
#
# This is an ansible module that takes no arguments and returns only
# some distribution-specific facts.

declare -A families pkg_mgrs
families=([Debian]=Debian [RedHat]=RedHat [Ubuntu]=Debian)
pkg_mgrs=([Debian]=apt [RedHat]=dnf)

. /etc/os-release

version=$VERSION_ID
major_version=${VERSION_ID%.*}

case "${ID}:${VERSION_ID%.*}" in
    rhel:7|centos:7)
        distribution=RedHat
        release=$VERSION_ID
        python=python2
        pkg_mgr=yum
        ;;
    debian:8)
        distribution=Debian
        release=jessie
        python=python2
        ;;
    debian:9|debian:10)
        distribution=Debian
        release=$VERSION_CODENAME
        python=python3
        ;;
    ubuntu:16|ubuntu:18)
        distribution=Ubuntu
        release=$VERSION_CODENAME
        python=python3
        ;;
    rhel:8|centos:8)
        distribution=RedHat
        release=$VERSION_ID
        python=python3
        ;;
    *)
        cat <<RESULT
        {"failed": true, "msg": "Unsupported distribution: ${ID}:${VERSION_ID}"}
RESULT
        exit 0
        ;;
esac

os_family=${os_family:-${families[$distribution]}}
pkg_mgr=${pkg_mgr:-${pkg_mgrs[$os_family]}}
service_mgr=${service_mgr:-systemd}

grep -Ev '": ""' <<RESULT
{
    "ansible_facts": {
        "ansible_os_family": "$os_family",
        "ansible_distribution": "$distribution",
        "ansible_distribution_release": "$release",
        "ansible_distribution_version": "$version",
        "ansible_distribution_major_version": "$major_version",
        "ansible_service_mgr": "$service_mgr",
        "ansible_pkg_mgr": "$pkg_mgr",
        "python": "$python"
    }
}
RESULT
