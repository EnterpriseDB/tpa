#!/bin/bash

IFS=$' \t\n'
set -eu

archdir=$(dirname $0)
libdir=$(dirname $0)/../lib
namesfile=()

cluster=${1:?"No cluster directory specified (please run this script via 'tpaexec config clustername â€¦')"}
shift

while [[ $# -gt 0 ]]; do
    opt=$1
    shift

    case "$opt" in
        --redmine*|--ticket|--issue)
            issue=${1:?Redmine issue id not specified}
            shift
            ;;
        --instances)
            instances=${1:?Number of instances not specified}
            shift
            ;;
        --platform)
            platform=${1:?Platform name not specified}
            shift
            ;;
        --region)
            region=${1:?Region name not specified}
            shift
            ;;
        --subnet)
            subnet=${1:?Subnet address/mask not specified}
            shift
            ;;
        --distribution|--os)
            distribution=${1:?Distribution name not specified}
            shift
            ;;
        --minimal)
            minimal=-minimal
            ;;
        --hostnames-from)
            namesfile=(${1:?Hostname list file not specified})
            shift
            ;;
        *)
            echo "ERROR: unrecognised parameter: $opt" >&2
            exit 1
            ;;
    esac
done

if [[ ! "${issue:-}" || ! "${instances:-}" ]]; then
    echo "ERROR: --redmine-id <num> and --instances <num> are both required" >&2
    exit 1
fi

platform=${platform:-aws}
region=${region:-eu-west-1}
subnet=${subnet:-10.33.115.0/24}
distribution=${distribution:-Debian}
minimal=${minimal:-''}

if [[ "$platform" != "aws" ]]; then
    echo "ERROR: currently unsupported platform: $platform (use '--platform aws')" >&2
    exit 1
fi

image=$($libdir/image "$distribution$minimal" $platform)
eval $image

mkdir $cluster

trap "rm -rf $cluster" ERR

cat > $cluster/config.yml <<PREAMBLE
---
architecture: Training

cluster_name: training_$issue
cluster_tags:
  Reference: https://redmine.2ndquadrant.it/issues/$issue

cluster_vars:
  cluster_network: $subnet

cluster_rules:
  - {proto: tcp, from_port: 0, to_port: 65535, cidr_ip: 0.0.0.0/0}

ec2_ami:
  Name: $image_name
  Owner: $image_owner
ec2_ami_user: $image_user

ec2_vpc:
  Name: Test

instance_defaults:
    type: t2.micro
    region: $region
    subnet: $subnet
    role:
        - primary

instances:
PREAMBLE

hostnames=($($libdir/hostnames $instances "${namesfile[@]}"))
for i in $(seq 1 $instances);
do
    cat >> $cluster/config.yml <<INSTANCE
  - node: $i
    Name: ${hostnames[$i-1]}
INSTANCE
done

cp $archdir/deploy.yml $cluster
