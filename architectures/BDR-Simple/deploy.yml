---

# Copyright Â© 2ndQuadrant Limited <info@2ndquadrant.com>

- import_playbook: "{{ tpa_dir }}/architectures/lib/init.yml"
  tags: always

- name: Set up TPA cluster nodes
  any_errors_fatal: True
  max_fail_percentage: 0
  become_user: root
  become: true

  hosts: "{{ deploy_hosts|default('all') }}"
  tasks:
    - include_role: name=common

    - include_role: name=sys

    - include_role: name=postgres
      when: >
        'postgres' in role

    - include_role: name=barman
      tags: barman

    - include_role: name=repmgr
      tags: repmgr

    - include_role: name=pgbouncer
      tags: pgbouncer

    - include_role: name=haproxy
      when: >
        'haproxy' in role
      tags: haproxy

    - include_role: name=final
      tags: [final]

    - include_role: name=postgres/bdr
      when: >
        'bdr' in role and 'primary' in role
      tags: [postgres, bdr]

    - include_role: name=monitoring
      when: >
        'role_monitoring-server' in groups
      tags: monitoring

- import_playbook: "{{ tpa_dir }}/architectures/lib/fini.yml"
  tags: always
