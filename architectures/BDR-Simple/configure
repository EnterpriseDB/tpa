#!/bin/bash

source $(dirname $0)/../lib/configure-common.sh

while [[ $# -gt 0 ]]; do
    opt=$1
    shift

    case "$opt" in
        --num-instances)
            instances=${1:?number of instances not specified}
            shift
            ;;
        *)
            source $libdir/configure-options.sh
            ;;
    esac
done

default_repos='products/bdr3/snapshot,products/pglogical3/snapshot'
if [[ ${POSTGRES_VERSION:-10} == 9.6 ]]; then
    default_repos='products/bdr2/snapshot'
fi

: ${tpa_2q_repositories:="[$default_repos]"}

extensions="[pglogical]"
if [[ $tpa_2q_repositories == */bdr2/* ]]; then
    extensions="[]"
    if [[ ! ${POSTGRES_VERSION:-} ]]; then
        export POSTGRES_VERSION=9.6
    fi
    if [[ ${POSTGRES_VERSION:-10} != 9.[46] ]]; then
        error "BDR2 does not support Postgres ${POSTGRES_VERSION:-10}"
    fi
fi
if [[ $tpa_2q_repositories == */bdr3/* ]]; then
    if [[ ${POSTGRES_VERSION:-10} == 9.* ]]; then
        error "BDR3 does not support Postgres ${POSTGRES_VERSION:-10}"
    fi
fi

vars+=([instances]=${instances:=3})
source $libdir/configure-defaults.sh
subnets=(${subnet:-$($libdir/subnets 1)})
vars+=([subnets]=$(IFS=, && echo "[${subnets[*]}]"))
vars+=([cluster_tags]="$($libdir/cluster-tags)")
vars+=([cluster_vars]="$($libdir/cluster-vars \
    postgres_coredump_filter=0xff repmgr_failover=manual \
    tpa_2q_repositories=$tpa_2q_repositories \
    extra_postgres_extensions=$extensions)")

v=$(write_vars $cluster)
template $archdir/templates/config.yml.j2 $v > $cluster/config.yml

source $libdir/configure-links.sh
