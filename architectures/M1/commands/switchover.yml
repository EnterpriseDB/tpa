---

- name: Basic initialisation and fact discovery
  any_errors_fatal: True
  max_fail_percentage: 0

  hosts: all
  roles:
    - role: platforms
      tags: always

    - role: facts
      tags: always

    - role: postgres/vars
      tags: always

- name: Perform switchover to {{ target }} on cluster {{ cluster }}
  any_errors_fatal: True
  max_fail_percentage: 0
  become_user: root
  become: yes
  hosts: all
  tasks:
    - include_role: name=postgres/facts
      vars:
        pgdata_initialised: true
      when: >
        'postgres' in role

    - assert:
        msg: "Switchover target is not a postgres server: {{ target }}"
        that:
          - "'postgres' in role"
      when: >
        inventory_hostname == target

    - assert:
        msg: "Switchover target is already a primary: {{ target }}"
        that:
          - target not in groups['role_primary']
      when: >
        inventory_hostname == target

    - assert:
        msg: "Expected only one primary, but found: {{ groups['role_primary']|join(', ') }}"
        that:
          - groups['role_primary']|length == 1
      when: >
        inventory_hostname == target

    - name: Stop repmgr
      service:
        name: repmgr
        state: stopped
      when: >
        'primary' in role or 'replica' in role

    - name: Perform switchover to {{ target }}
      command: >
        {{ postgres_bin_dir }}/repmgr standby switchover --verbose -f {{ repmgr_conf_file }} --siblings-follow
      become_user: "{{ postgres_user }}"
      become: yes
      when: >
        'postgres' in role and inventory_hostname == target

    - name: Restart repmgr
      service:
        name: repmgr
        state: started
      when: >
        'primary' in role or 'replica' in role

    - name: Display cluster status
      command: >
        {{ postgres_bin_dir }}/repmgr cluster show --verbose -f {{ repmgr_conf_file }}
      become_user: "{{ postgres_user }}"
      become: yes
      when: >
        inventory_hostname == target
