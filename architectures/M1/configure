#!/bin/bash

source $(dirname $0)/../lib/configure-common.sh

while [[ $# -gt 0 ]]; do
    opt=$1
    shift

    case "$opt" in
        --num-cascaded-replicas)
            cascaded_replicas=${1:?Number of cascaded replicas not specified}
            shift
            ;;
        *)
            source $libdir/configure-options.sh
            ;;
    esac
done

vars+=([cascaded_replicas]=${cascaded_replicas:=1})
vars+=([instances]=${instances:=$((3+$cascaded_replicas))})
source $libdir/configure-defaults.sh
subnets=(${subnet:-$($libdir/subnets 2)})
vars+=([subnets]=$(IFS=, && echo "[${subnets[*]}]"))
vars+=([cluster_tags]="$($libdir/cluster-tags)")
vars+=([cluster_vars]="$($libdir/cluster-vars vpn_network=192.168.33.0/24 \
    twoq_repositories=${twoq_repositories:-[]})")

v=$(write_vars $cluster)
template $archdir/templates/config.yml.j2 $v > $cluster/config.yml

for f in deploy.yml commands; do
    ln -sf $archdir/$f $cluster
done
rm -f -- "$v"
