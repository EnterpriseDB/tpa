---

- name: Basic initialisation and fact discovery
  any_errors_fatal: True
  max_fail_percentage: 0

  hosts: all
  tasks:
    - include_role: name=platforms
      tags: always

    - include_role: name=facts
      tags: always

    - include_role: name=postgres/vars
      tags: always

# We want to make sure postgres and repmgr are running on all applicable
# instances in the cluster. First, we unlock any LUKS-encrypted volumes.

- name: Start Postgres on cluster {{ cluster }}
  any_errors_fatal: True
  max_fail_percentage: 0
  become_user: root
  become: yes
  hosts: all
  tasks:
    - service:
        name: repmgr
        state: stopped
      when: >
        'primary' in role or 'replica' in role

    - service:
        name: postgres
        state: stopped
      when: >
        'postgres' in role

    - mount:
        src: "{{ _device }}"
        name: "{{ item.mountpoint }}"
        state: unmounted
      with_items: "{{ volumes }}"
      vars:
        _device: >-
          {{ (item.encryption == 'luks')|ternary('/dev/mapper/%s' % (item.luks_volume|default(item.device|basename)), item.device) }}

    - command: cryptsetup luksClose "{{ _luks_volume }}"
      register: luksclose
      failed_when: luksclose.rc not in [0, 4]
      changed_when: luksclose.rc != 4
      with_items: >
        {{ volumes|json_query("[?encryption=='luks']") }}
      vars:
        _luks_volume: >-
          {{ item.luks_volume|default(item.device|basename) }}
