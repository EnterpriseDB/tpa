---

# Â© Copyright EnterpriseDB UK Limited 2015-2022 - All rights reserved.

- import_playbook: "{{ tpa_dir }}/architectures/lib/init.yml"
  vars:
    wait_for_instances: yes
  tags: always

- name: Set up TPA cluster nodes
  any_errors_fatal: True
  max_fail_percentage: 0
  become_user: root
  become: true
  environment: "{{ target_environment }}"

  hosts: "{{ deploy_hosts|default('all') }}"
  tasks:
  - include_role:
      name: sys
      apply:
        tags: sys
    when:
      platform not in ['shared']
      and (pem_shared|default(false)) is false
    tags: always

  - include_role:
      name: postgres
      apply:
        tags: postgres
    when: >
      'postgres' in role
      and (pem_shared|default(false)) is false
    tags: always

  - include_role:
      name: barman
      apply:
        tags: barman
    when:
      groups['role_barman']|default([]) is not empty
    tags: always

  - block:
      - include_role: name=repmgr
      - include_role: name=efm
        when:
          failover_manager == 'efm'
          and ('postgres' in role or 'efm-witness' in role)
    when:
      groups|members_of('role_replica', not_in=['role_readonly']) is not empty
      and (pem_shared|default(false)) is false
    tags: always

  - include_role:
      name: pgbouncer
      apply:
        tags: pgbouncer
    when:
      groups['role_pgbouncer']|default([]) is not empty
      and (pem_shared|default(false)) is false
    tags: always

  - include_role:
      name: haproxy
      apply:
        tags: haproxy
    when:
      groups['role_haproxy']|default([]) is not empty
      and (pem_shared|default(false)) is false
    tags: always

  - include_role:
      name: etcd
      apply:
        tags: etcd
    when:
      groups['role_etcd']|default([]) is not empty
      and (pem_shared|default(false)) is false
    tags: always

  - include_role:
      name: harp
      apply:
        tags: harp
    when:
      failover_manager == 'harp'
      and ('postgres' in role or 'harp-proxy' in role)
      and 'pem-server' not in role
    tags: always

  - include_role:
      name: pem
      apply:
        tags: pem
    when:
      (
       groups['role_pem-server']|default([]) is not empty
       or groups['role_pem-agent']|default([]) is not empty
      )
      and (pem_shared|default(false)) is false
    tags: always

  - include_role:
      name: final
      apply:
        tags: final
    when:
      (pem_shared|default(false)) is false
    tags: always

- import_playbook: "{{ tpa_dir }}/architectures/lib/fini.yml"
