---

- name: Set test output directory
  hosts: all
  tasks:
    - set_fact:
        output_dir: >-
          {{ cluster }}/test/{{ lookup('pipe', 'date +%s') }}
      run_once: yes

- name: Basic initialisation and fact discovery
  any_errors_fatal: True
  max_fail_percentage: 0

  hosts: all
  roles:
    - role: platforms
      tags: always

    - role: facts
      tags: always

    - role: postgres/vars
      tags: always

- name: Test instances
  any_errors_fatal: True
  max_fail_percentage: 0

  hosts: all
  tasks:
    - include_role: name=postgres/facts
      vars:
        pgdata_initialised: true
      when: >
        'postgres' in role

    - include_role: name=test
      tags: test
