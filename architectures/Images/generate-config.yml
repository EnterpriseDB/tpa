---

- name: Generate config.yml
  hosts: localhost
  tasks:
    - name: Load list of base AMIs
      include_vars: base-amis.yml

    - name: Search for base AMIs in each region
      ec2_ami_facts:
        region: "{{ item.0 }}"
        owner: "{{ base_amis[item.1].Owner }}"
        filters:
          name: "{{ base_amis[item.1].Name }}"
      with_nested:
        - "{{ regions }}"
        - "{{ distributions }}"
      register: amis

    - assert:
        msg: >
          Expected 1 AMI matching base_amis in {{ item.0 }}, found {{ item.1.images|length }}
        that:
          - item.1.images|length == 1
      with_together:
        - "{{ regions }}"
        - "{{ amis.results }}"

    - set_fact:
        region_amis: "{{ region_amis|default({})|combine({item: []}) }}"
      with_items: "{{ regions }}"

    - set_fact:
        region_amis: "{{
          region_amis|combine({
            item.item.0: region_amis[item.item.0]|union([{
              'image_id': item.images.0.image_id,
              'user': base_amis[item.item.1].ansible_user,
              'os': item.item.1
            }])
          })
        }}"
      with_items: "{{ amis.results }}"

    - name: Generate config.yml
      template:
        src: templates/config.yml.j2
        dest: "{{ output }}"
