#!/bin/bash

source $(dirname $0)/../lib/configure-common.sh

while [[ $# -gt 0 ]]; do
    opt=$1
    shift

    case "$opt" in
        *)
            source $libdir/configure-options.sh
            ;;
    esac
done

postgres_volume_size=${postgres_volume_size:-64}
barman_volume_size=${barman_volume_size:-128}

source $libdir/configure-defaults.sh
vars+=([instances]=${instances:=8})

if [[ "$platform" != "aws" ]]; then
    error "currently unsupported platform: $platform (use '--platform aws')"
fi

vars+=([subnet]=${subnet:=$($libdir/subnets 1)})
hostnames=(zero $($libdir/hostnames $instances))
vars+=([hostnames]=$(IFS=, && echo "[${hostnames[*]}]"))
vars+=([cluster_tags]="$($libdir/cluster-tags)")
vars+=([cluster_vars]="$($libdir/cluster-vars \
    tpa_2q_repo=internal-snapshot postgres_coredump_filter=0xff repmgr_failover=manual)")

v=$(write_vars $cluster)
template $archdir/templates/config.yml.j2 $v > $cluster/config.yml

ln -sf $archdir/deploy.yml $cluster
