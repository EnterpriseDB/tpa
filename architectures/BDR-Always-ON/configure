#!/bin/bash

source $(dirname $0)/../lib/configure-common.sh

while [[ $# -gt 0 ]]; do
    opt=$1
    shift

    case "$opt" in
        *)
            source $libdir/configure-options.sh
            ;;
    esac
done

: ${twoq_repositories:='[products/bdr3/snapshot]'}

postgres_volume_size=${postgres_volume_size:-64}
barman_volume_size=${barman_volume_size:-128}
vars+=([instances]=${instances:=8})
source $libdir/configure-defaults.sh
subnets=(${subnet:-$($libdir/subnets 1)})
vars+=([subnets]=$(IFS=, && echo "[${subnets[*]}]"))
vars+=([cluster_tags]="$($libdir/cluster-tags)")
vars+=([cluster_vars]="$($libdir/cluster-vars \
    postgres_coredump_filter=0xff repmgr_failover=manual \
    twoq_repositories=$twoq_repositories \
    extra_postgres_extensions='[pglogical]')")

v=$(write_vars $cluster)
template $archdir/templates/config.yml.j2 $v > $cluster/config.yml

source $libdir/configure-links.sh
