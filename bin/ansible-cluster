#!/bin/bash
#
# Runs ansible in the context of a clusterâ€”i.e., with the correct path
# to the cluster's inventory and so on. This is for ad-hoc commands, not
# to run playbooks; see also ansible-cluster-playbook.
#
# Example: ansible-cluster test/tpa all -m ping

IFS=$' \t\n'
set -eu

TOP=/opt/2ndQuadrant/TPA
if [[ ! -d $TOP ]]; then
    TOP=$(dirname $0)/..
    type realpath &>/dev/null && TOP=$(realpath $TOP)
fi
export TPA_DIR=${TPA_DIR:-$TOP}

cluster=${1:?No cluster specified}
shift

cd $cluster

$TPA_DIR/ansible/ansible \
    -i inventory --vault-password-file vault/vault_pass.txt \
    -e cluster=$(pwd) "$@"
