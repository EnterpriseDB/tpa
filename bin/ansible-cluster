#!/bin/bash
#
# Runs ansible in the context of a clusterâ€”i.e., with the correct path
# to the cluster's inventory and so on. This is for ad-hoc commands, not
# to run playbooks; see also ansible-cluster-playbook.
#
# Example: ansible-cluster test/tpa all -m ping

IFS=
set -e -u

TOP=$(dirname $0)/..
type realpath &>/dev/null && TOP=$(realpath $TOP)
export TPA_DIR=${TPA_DIR:-$TOP}

cluster=${1:?No cluster specified}
shift

cluster_dir=$cluster
if [[ ${cluster_dir:0:1} != '/' && ${cluster_dir:0:2} != './' ]]; then
    cluster=$(echo $cluster|sed 's,^clusters/,,')
    cluster_dir="$TPA_DIR/clusters/$cluster"
fi

if [ ! -d $cluster_dir ]; then
    echo "Can't find directory $cluster_dir"
    exit
fi

cd $cluster_dir

$TPA_DIR/ansible/ansible \
    -i inventory --vault-password-file vault/vault_pass.txt \
    -e cluster=$(pwd) "$@"
