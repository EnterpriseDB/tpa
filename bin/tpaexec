#!/bin/bash
#
# Runs provision/deprovision/deploy etc.

IFS=
set -e -u

TOP=/opt/2ndQuadrant/TPA
if [[ ! -d $TOP ]]; then
    TOP=$(dirname $0)/..
    type realpath &>/dev/null && TOP=$(realpath $TOP)
fi
export TPA_DIR=${TPA_DIR:-$TOP}

if [[ -f $TPA_DIR/VERSION ]]; then
    VERSION=$(cat $TPA_DIR/VERSION)
else
    VERSION=$(cd $TPA_DIR && git describe)
fi

command=${1:?No command specified}
shift

case "$command" in
    provision|deprovision|deploy|rehydrate)
        $TPA_DIR/bin/$command "$@"
        ;;

    info)
        subcommand=${1:-""}
        case "$subcommand" in
            "")
                echo "TPA $VERSION"
                ;;
            platforms|architectures|platforms/*|architectures/*)
                cat $TPA_DIR/$subcommand/README.md
                ;;
            *)
                echo "Unrecognised info subcommand: $subcommand"
                ;;
        esac
        ;;

    version)
        echo "TPA $VERSION"
        ;;

    *)
        echo "Unrecognised tpaexec command: $command"
        ;;
esac
