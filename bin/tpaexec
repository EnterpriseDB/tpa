#!/bin/bash
#
# Runs provision/deprovision/deploy etc.

IFS=
set -e -u

TOP=$(dirname $0)/..
type realpath &>/dev/null && TOP=$(realpath $TOP)
export TPA_DIR=${TPA_DIR:-$TOP}

command=${1:?No command specified}
shift

case "$command" in
    provision|deprovision|deploy|rehydrate)
        $TPA_DIR/bin/$command "$@"
        ;;

    info)
        subcommand=${1:-""}
        case "$subcommand" in
            "")
                echo "TPA $(cat $TPA_DIR/VERSION.md)"
                ;;
            platforms)
                find $TPA_DIR/platforms -name common -prune -o -type d -print|  \
                    sed -e 's,^.*/platforms/,,' -e 's,/.*$,,'|sort -u|          \
                    awk '{if ($1){print $1}}'
                ;;
            architectures)
                find $TPA_DIR/architectures -type d -print|                     \
                    sed -e 's,^.*/architectures/,,' -e 's,/.*$,,'|sort -u|      \
                    awk '{if ($1){print $1}}'
                ;;
            *)
                echo "Unrecognised info subcommand: $subcommand"
                ;;
        esac
        ;;

    version)
        echo "TPA $(cat $TPA_DIR/VERSION.md)"
        ;;

    *)
        echo "Unrecognised tpaexec command: $command"
        ;;
esac
