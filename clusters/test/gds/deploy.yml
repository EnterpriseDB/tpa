---

# Deploys Postgres and associated software to a cluster.

- name: Basic initialisation and fact discovery
  any_errors_fatal: True
  max_fail_percentage: 0

  # This play must always be applied to all hosts in the cluster. Here
  # we do any platform-specific checks and initialisation, confirm that
  # all hosts are available, and perform basic fact discovery.

  hosts: all
  roles:
    - role: platforms
      tags: always

    - role: facts
      tags: always

    - role: postgres/vars
      vars:
        postgres_version: 10
      tags: always

- name: Set up GDS cluster on BDR3 and Postgres10
  hosts: tag_Cluster_gds
  any_errors_fatal: True
  max_fail_percentage: 0
  become_user: root
  become: true

  vars:
    ansible_distribution: Ubuntu
    ansible_distribution_release: xenial
    postgres_packages:
      Ubuntu:
        - postgresql-{{postgres_version}}
        - postgresql-{{postgres_version}}-dbg
        - postgresql-client-{{postgres_version}}
        - postgresql-contrib-{{postgres_version}}
        - postgresql-server-dev-{{postgres_version}}
        - postgresql-plperl-{{postgres_version}}
        - barman-cli
    apt_repositories:
      PGDG:
        key_id: ACCC4CF8
        key_url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
        repo: >-
          deb http://apt.postgresql.org/pub/repos/apt/ {{ ansible_distribution_release }}-pgdg main 10
        versions: [10]
      pglogical:
        key_id: 7ED05910
        key_url: "https://{{ lookup('env', 'BDR_USERNAME') }}:{{ lookup('env', 'BDR_PASSWORD') }}@temp-packages.2ndquadrant.com/7ED05910.asc"
        repo: "deb https://{{ lookup('env', 'BDR_USERNAME') }}:{{ lookup('env', 'BDR_PASSWORD') }}@temp-packages.2ndquadrant.com/pglogical-pipeline/latest/deb/ {{ ansible_distribution_release }} main"
        versions: [10]
      BDR:
        key_id: 7ED05910
        key_url: "https://{{ lookup('env', 'BDR_USERNAME') }}:{{ lookup('env', 'BDR_PASSWORD') }}@temp-packages.2ndquadrant.com/7ED05910.asc"
        repo: "deb https://{{ lookup('env', 'BDR_USERNAME') }}:{{ lookup('env', 'BDR_PASSWORD') }}@temp-packages.2ndquadrant.com/bdr3-pipeline/branches/bdr-plugin/REL3_0_DEV/latest/deb/ {{ ansible_distribution_release }} main"
        versions: [10]
    extra_postgres_packages:
      Debian: &debian_extra_packages ['postgresql-{{postgres_version}}-bdr-plugin']
      RedHat: ['postgresql{{postgres_versionNN}}-bdr']
      Ubuntu: *debian_extra_packages
    postgres_extensions:
      - pg_stat_statements
      - pg_freespacemap
      - pg_visibility
      - pageinspect
      - pgstattuple
      - pglogical

  roles:
    - role: common

    - role: sys/tune
      tags: always

    - role: sys/sysctl
      vars:
        sysctl_values:
          net.ipv4.ip_forward: 1
      tags: [sys, sysctl]

    - role: sys/openvpn
      when: >
        'tag_role_openvpn-server' in groups
        and vpn_network is defined

    - role: sys/hosts
      tags: [sys, hosts]

    - role: sys/rsyslog
      tags: [sys, rsyslog]

    - role: postgres
      when: >
        'postgres' in role

    - role: barman
      tags: barman

    - role: repmgr
      tags: repmgr

    - role: pgbouncer
      tags: pgbouncer
      when: >
        'postgres' in role

    - role: bdr/config
      when: >
        'bdr' in role and 'primary' in role
      tags: bdr

    - role: postgres/final
      when: >
        'postgres' in role
      tags: [postgres, final]

    - role: bdr/node
      when: >
        'bdr' in role and 'primary' in role
      tags: bdr

    - role: monitoring
      when: >
        'tag_role_monitoring-server' in groups
      tags: monitoring

- name: Ensure /etc/hosts is correct cluster-wide
  any_errors_fatal: True
  max_fail_percentage: 0
  become_user: root
  become: yes
  hosts: all
  roles:
    - role: sys/hosts
      tags: [sys, hosts]

