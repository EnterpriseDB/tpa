---

# Deploys Postgres and associated software to a cluster.

- name: Basic initialisation and fact discovery
  any_errors_fatal: True
  max_fail_percentage: 0

  # This play must always be applied to all hosts in the cluster. Here
  # we do any platform-specific checks and initialisation, confirm that
  # all hosts are available, and perform basic fact discovery.

  hosts: all
  roles:
    - role: platforms
      tags: always

    - role: facts
      tags: always

    - role: postgres/vars
      vars:
        postgres_version: 9.4
      tags: always

- name: Set up TPA BDR1 cluster
  hosts: all
  any_errors_fatal: True
  max_fail_percentage: 0
  become_user: root
  become: true

  vars:
    ansible_distribution: "Red Hat Enterprise Linux"
    ansible_distribution_release: "7"

  roles:
    - role: common

    - role: sys/volumes
      tags: [sys, fs]

    - role: sys/tune
      tags: always

    - role: sys/sysctl
      vars:
        sysctl_values:
          net.ipv4.ip_forward: 1
      tags: [sys, sysctl]

    - role: sys/openvpn

    - role: sys/hosts
      tags: [sys, hosts]

    - role: sys/rsyslog
      tags: [sys, rsyslog]

    - role: postgres
      when: >
        'postgres' in role

- name: Ensure /etc/hosts is correct cluster-wide
  any_errors_fatal: True
  max_fail_percentage: 0
  become_user: root
  become: yes
  hosts: all
  roles:
    - role: sys/hosts
      tags: [sys, hosts]
