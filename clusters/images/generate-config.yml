---

# Given a list of regions and a list of AMIs, this playbook generates a
# config.yml for a cluster with one instance per AMI per region based on
# the config.yml.j2 template.

- name: Generate config.yml for clusters/images
  hosts: localhost
  vars:
    # Which regions do we want to build new AMIs in?
    regions:
      - us-east-1
      #- us-east-2 # (commented out due to lack of official Debian image)
      - us-west-1
      - us-west-2
      - eu-west-1
      - eu-central-1

    # Which AMIs should we start with?
    base_amis:
      - Name: debian-jessie-amd64-hvm-2016-09-19-ebs
        Owner: 379101102735
        os: Debian
      - Name: RHEL-7.3_HVM_GA-20161026-x86_64-1-Hourly2-GP2
        Owner: 309956199498
        os: RedHat
      - Name: ubuntu/images/hvm-ssd/ubuntu-xenial-16.04-amd64-server-20161020
        Owner: 099720109477
        os: Ubuntu

  tasks:
    - name: Search for base AMIs in each region
      ec2_ami_find:
        region: "{{ item.0 }}"
        name: "{{ item.1.Name }}"
        owner: "{{ item.1.Owner }}"
        sort: name
        sort_end: 1
        sort_order: descending
        no_result_action: fail
      with_nested:
        - "{{ regions }}"
        - "{{ base_amis }}"
      register: amis

    - set_fact:
        region_amis: "{{ region_amis|default({})|combine({item: []}) }}"
      with_items: "{{ regions }}"

    - set_fact:
        region_amis: "{{ region_amis|combine({item.item.0: region_amis[item.item.0]|union([{'ami_id': item.results.0.ami_id, 'os': item.item.1.os}])}) }}"
      with_items: "{{ amis.results }}"

    - name: Expand config.yml template
      template:
        src: config.yml.j2
        dest: "{{ playbook_dir }}/config.yml"
