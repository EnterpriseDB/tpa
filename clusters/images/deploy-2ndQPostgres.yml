---

- name: Set up TPA image nodes
  hosts: all
  any_errors_fatal: True
  max_fail_percentage: 0
  sudo_user: root
  sudo: true

  pre_tasks:
    - include: ../../platforms/aws/hostvars.yml
      tags: always
    - name: Wait for instances to be available
      local_action:
        module: wait_for
        port: "{{ ansible_port|default(22) }}"
        host: "{{ ansible_host }}"

  roles:
    - role: postgres/vars

    - role: common/pkg
    - role: postgres/pkg
      vars:
        postgres_package_source: 2ndQPostgres
    - role: pglogical/pkg
    - role: sys/openvpn/pkg
    - role: pgbouncer/pkg
    - role: barman/pkg
    - role: repmgr/pkg

    - role: sys/upgrade
    - role: sys/firstboot
