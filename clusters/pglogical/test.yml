# TODO: Drop the provider slot if it exists. If some test fails, it may
# not be dropped as expected.

- set_fact: provider_port="{{hostvars[item]['postgres_port']|int}}"
- set_fact: subscriber_port="{{postgres_port|int}}"

- name: Drop the provider database
  command: dropdb -p {{provider_port}} --if-exists provider
  delegate_to: "{{item}}"

- name: Drop the subscriber database
  command: dropdb --if-exists subscriber

- block:
    - command: dropuser -p {{provider_port}} --if-exists super
    - command: dropuser -p {{provider_port}} --if-exists nonsuper
    - name: Recreate nonsuper user on provider
      command: createuser -p {{provider_port}} --replication nonsuper
    - name: Recreate super user on provider
      command: createuser -p {{provider_port}} -s super
  delegate_to: "{{item}}"

- block:
    - command: dropuser --if-exists super
    - command: dropuser --if-exists nonsuper
    - name: Recreate nonsuper user on subscriber
      command: createuser --replication nonsuper
    - name: Recreate super user on subscriber
      command: createuser -s super

- name: Recreate the provider database
  command: createdb -p {{provider_port}} -O super provider
  delegate_to: "{{item}}"

- name: Recreate the subscriber database
  command: createdb -O super subscriber

- name: Template DSN in test files
  replace:
    dest: "{{item}}"
    regexp: "(?s)(CREATE OR REPLACE FUNCTION public.pglogical_regress_variables\\(.*? AS \\$f\\$).*?(\\$f\\$;)"
    replace: "\\1SELECT 'dbname=provider port={{provider_port}}'::text, 'dbname=subscriber port={{subscriber_port}}'::text\\2"
    backup: no
  with_items:
    - "{{pglogical_build_dir}}/sql/preseed.sql"
    - "{{pglogical_build_dir}}/expected/preseed.out"

- name: Create output directory
  file:
    path: "{{pglogical}}/out-{{inventory_hostname}}-{{item}}"
    state: directory
  vars:
    pglogical: "{{pglogical_build_dir|expanduser}}"

- name: Run pg_regress
  shell: >
    {{postgres}}/lib/postgresql/pgxs/src/test/regress/pg_regress \
      --inputdir={{pglogical}} \
      --outputdir="{{pglogical}}/out-{{inventory_hostname}}-{{item}}" \
      preseed infofuncs init_fail init preseed_check basic extended toasted replication_set add_table matview bidirectional primary_key foreign_key functions copy drop
  vars:
    postgres: "{{postgres_install_dir|expanduser}}"
    pglogical: "{{pglogical_build_dir|expanduser}}"
