- name: Set up pglogical test nodes
  hosts: tag_Name_PglogicalTests
  pre_tasks:
    - name: Check if the data directory exists already
      stat: path="{{postgres_data_dir}}"
      register: datadir

    - name: Make sure Postgres isn't running if the data directory exists
      shell: "{{postgres_install_dir|expanduser}}/bin/pg_ctl -D {{postgres_data_dir}} -w stop -m immediate"
      environment:
        PGPORT: "{{postgres_port|int}}"
      register: pg_ctl_stopped
      changed_when: "pg_ctl_stopped.rc == 0"
      failed_when: false
      when: datadir.stat.exists

    - name: Remove any existing data directory
      file: state=absent path="{{postgres_data_dir}}" force=yes
      when: datadir.stat.exists

  roles:
    - role: 'postgres/src'
    - role: 'postgres/ext'
      postgres_ext_git_url: git@github.com:2ndQuadrant/pglogical_output.git
      postgres_ext_dir: "~/pglogical/{{inventory_hostname}}/pglogical_output"
    - role: 'postgres/ext'
      postgres_ext_git_url: git@github.com:2ndQuadrant/pglogical.git
      postgres_ext_dir: "~/pglogical/{{inventory_hostname}}/pglogical"
    - role: 'postgres/initdb'
    - role: 'postgres/config'

  post_tasks:
    - name: Start Postgres
      shell: "{{postgres_install_dir}}/bin/pg_ctl -D {{postgres_data_dir}} -w start"

  environment:
    PATH: "{{postgres_install_dir|expanduser}}/bin:{{lookup('env', 'PATH')}}"
