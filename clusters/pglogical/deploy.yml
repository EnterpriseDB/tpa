- name: Set up pglogical test nodes
  hosts: tag_Name_PglogicalTests
  pre_tasks:
    - name: Check if the data directory exists already
      stat: path="{{postgres_data_dir}}"
      register: datadir

    - name: Make sure Postgres isn't running if the data directory exists
      shell: "pg_ctl -D {{postgres_data_dir}} -w stop -m immediate"
      environment:
        PGPORT: "{{postgres_port|int}}"
      register: pg_ctl_stopped
      changed_when: "pg_ctl_stopped.rc == 0"
      failed_when: false
      when: datadir.stat.exists

    - name: Remove any existing data directory
      file: state=absent path="{{postgres_data_dir}}" force=yes
      when: datadir.stat.exists

  roles:
    - role: 'postgres/src'
      postgres_git_reference_repo: "{{postgres_reference_repo}}"
    - role: 'postgres/ext'
      postgres_ext_git_url: git@github.com:2ndQuadrant/pglogical_output.git
      postgres_ext_git_reference_repo: "{{pglogical_output_reference_repo}}"
      postgres_ext_dir: "{{pglogical_output_build_dir}}"
    - role: 'postgres/ext'
      postgres_ext_git_url: git@github.com:2ndQuadrant/pglogical.git
      postgres_ext_git_reference_repo: "{{pglogical_reference_repo}}"
      postgres_ext_dir: "{{pglogical_build_dir}}"
    - role: 'postgres/initdb'
      postgres_initdb_opts: ['-A', 'trust']
    - role: 'postgres/config'
      postgres_config_settings:
        wal_level: logical
        max_wal_senders: 10
        max_replication_slots: 10
        track_commit_timestamp: on
        shared_preload_libraries: pglogical
        log_line_prefix: "'[%m] [%p] [%d] '"
        DateStyle: "'ISO, DMY'"
        fsync: off

  post_tasks:
    - name: Start Postgres
      shell: "pg_ctl -D {{postgres_data_dir}} -w start"

  environment:
    PATH: "{{postgres_install_dir|expanduser}}/bin:{{lookup('env', 'PATH')}}"

- name: Run regression tests
  hosts: subscribers
  tasks:
    - include: test.yml
      with_items: groups['providers']
  environment:
    PATH: "{{postgres_install_dir|expanduser}}/bin:{{lookup('env', 'PATH')}}"
    PGPORT: "{{postgres_port|int}}"
