---

# Create an encrypted volume named luks_volume on luks_device, create a
# filesystem on it, and mount it under luks_mountpoint.
#
# XXX The passphrase should be generated and stored as an encrypted host
# variable.

- name: Ensure LUKS configuration is available
  assert:
    that:
      - luks_volume is defined
      - luks_device is defined
      - luks_mountpoint is defined
      - ansible_version.major >= 2

- name: Is the encrypted volume already initialised?
  command: cryptsetup isLuks "{{ luks_device }}"
  ignore_errors: true
  changed_when: False
  register: luks

- block:
    - name: Load passphrase from vault
      include_vars: passphrase.yml

    - name: Initialise LUKS volume on {{ luks_device }}
      shell: echo -n "{{ luks_passphrase }}" | cryptsetup -q luksFormat --key-file - "{{ luks_device }}"
      no_log: true

    - name: Map LUKS volume to /dev/mapper/{{ luks_volume }}
      shell: echo -n "{{ luks_passphrase }}" | cryptsetup luksOpen --key-file - "{{ luks_device }}" "{{ luks_volume }}"
      no_log: true

    - name: Create ext4 filesystem on mapped LUKS volume {{ luks_volume }}
      command: mkfs.ext4 "/dev/mapper/{{ luks_volume }}"

    - name: Mount mapped encrypted filesystem under {{ luks_mountpoint }}
      mount:
        name: "{{ luks_mountpoint }}"
        src: "/dev/mapper/{{ luks_volume }}"
        fstype: ext4
        opts: noauto
        state: mounted

  when: luks|failed
