---

- name: Ensure Postgres configuration is present
  assert:
    that:
      - pgversion is defined

- include: packages.yml
- include_vars: "{{ansible_distribution}}.yml"

- name: Ensure the data directory exists
  file:
    path: "{{pgdata}}"
    state: directory
    owner: postgres
    group: postgres
    mode: 0755

- block:
    - name: Set PGDATA in postgresql-{{pgversion}}.service
      lineinfile:
        dest: "/lib/systemd/system/postgresql-{{pgversion}}.service"
        line: "Environment=PGDATA={{pgdata}}"
        regexp: "^Environment=PGDATA="
        state: present
    - name: Run initdb with the right data directory
      command: "{{pgbindir}}/postgresql{{pgversionNN}}-setup initdb"
      args:
        creates: "{{pgdata}}/PG_VERSION"
  when: ansible_distribution == 'redhat'

- name: Install Postgres configuration files
  template:
    src="{{ item }}.j2" dest="{{ pgconf }}/{{ item }}"
    owner=postgres group=postgres mode=0640
  with_items:
    - pg_hba.conf
    - postgresql.conf
  register: pgconfig

- name: Restart Postgres
  service: name=postgresql state=restarted
  when: pgconfig.changed

- name: Disable Postgres autostart on reboot
  service:
     name: postgresql
     enabled: no

- include: ssh.yml
