---

- name: Ensure Postgres configuration is present
  assert:
    that:
      - pgversion is defined

- name: Add PGDG repository signing key
  apt_key:
    id=ACCC4CF8 url=https://www.postgresql.org/media/keys/ACCC4CF8.asc
    state=present

- name: Add the PGDG apt repository
  apt_repository:
    repo='deb http://apt.postgresql.org/pub/repos/apt/ wheezy-pgdg main'
    state=present update_cache=yes

- name: Install Postgres packages
  apt: pkg={{ item }}-{{ pgversion }} state=latest
  with_items:
    - postgresql
    - postgresql-client
    - postgresql-contrib
    - postgresql-server-dev

- name: Install Postgres configuration files
  template:
    src="{{ item }}.j2" dest="{{ pgconf }}/{{ item }}"
    owner=postgres group=postgres mode=0640
  with_items:
    - pg_hba.conf
    - postgresql.conf
  register: pgconfig

- name: Restart Postgres
  service: name=postgresql state=restarted
  when: pgconfig.changed
