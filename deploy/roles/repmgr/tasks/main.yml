---

- name: Create repmgr configuration directory
  file: path=/etc/repmgr owner=postgres group=postgres mode=0755
    state=directory

- name: Install repmgr.conf on each node
  template: src=repmgr.conf.j2 dest=/etc/repmgr/repmgr.conf

- name: Install repmgr failover scripts
  copy: src="{{ item }}" dest=/etc/repmgr/
    owner=postgres group=postgres mode=0755
  with_items:
    - promote_command.sh
    - follow_command.sh

- name: Create repmgr user on the primary
  postgresql_user: name=repmgr role_attr_flags=SUPERUSER state=present
  sudo_user: postgres
  delegate_to: primary_hostname
  run_once: yes

- name: Create repmgr database on the primary
  postgresql_db: name=repmgr owner=repmgr state=present
  sudo_user: postgres
  delegate_to: primary_hostname
  run_once: yes

- name: Check if the primary is registered
  command: repmgr -f /etc/repmgr/repmgr.conf cluster show
  ignore_errors: True
  changed_when: False
  sudo_user: postgres
  register: master
  delegate_to: primary_hostname
  run_once: yes

- name: Run repmgr master register on the primary
  command: repmgr -f /etc/repmgr/repmgr.conf --verbose master register
  sudo_user: postgres
  delegate_to: primary_hostname
  run_once: yes
  when: master|failed

- name: Check if the standby is registered
  command: repmgr -f /etc/repmgr/repmgr.conf cluster show
  sudo_user: postgres
  ignore_errors: True
  changed_when: False
  register: standby
  when: inventory_hostname != primary_hostname

- block:
    - name: Stop Postgres
      service: name=postgresql state=stopped
      sudo_user: root
    - name: Move existing cluster directory
      command: mv /var/lib/postgresql/{{pgversion}}/main /var/lib/postgresql/{{pgversion}}/main.backup
      ignore_errors: yes
    - name: Create new cluster directory
      file: path=/var/lib/postgresql/{{pgversion}}/main state=directory
    - name: Run repmgr standby clone
      command: repmgr -D /var/lib/postgresql/{{pgversion}}/main -d repmgr -U repmgr --verbose standby clone {{hostvars[primary_hostname]['vpn_address']}}
    - name: Start Postgres
      service: name=postgresql state=started
      sudo_user: root
    - name: Run repmgr standby register
      command: repmgr -f /etc/repmgr/repmgr.conf --verbose standby register
  when: standby|failed and inventory_hostname != primary_hostname
  sudo_user: postgres
